---
ID: "a7be7071-445f-443a-a8d0-d03abf78ac16"
Parent: "e3fbf2bd-14b5-439f-b488-478701f1bae1"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: /sitecore/media library/Base Themes/Core Libraries/scripts/typeahead
DB: master
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/A7BE7071445F443AA8D0D03ABF78AC16.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  BlobID: "df0668b2-3603-4578-a23b-5e7e8d130dcc"
  Value: LyohDQogKiB0eXBlYWhlYWQuanMgMC4xMC40DQogKiBodHRwczovL2dpdGh1Yi5jb20vdHdpdHRlci90eXBlYWhlYWQuanMNCiAqIENvcHlyaWdodCAyMDEzLTIwMTQgVHdpdHRlciwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzOyBMaWNlbnNlZCBNSVQNCiAqLw0KDQooZnVuY3Rpb24oJCkgew0KICAgIHZhciBfID0gZnVuY3Rpb24oKSB7DQogICAgICAgICJ1c2Ugc3RyaWN0IjsNCiAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIGlzTXNpZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIC8obXNpZXx0cmlkZW50KS9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkgPyBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC8obXNpZSB8cnY6KShcZCsoLlxkKyk/KS9pKVsyXSA6IGZhbHNlOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGlzQmxhbmtTdHJpbmc6IGZ1bmN0aW9uKHN0cikgew0KICAgICAgICAgICAgICAgIHJldHVybiAhc3RyIHx8IC9eXHMqJC8udGVzdChzdHIpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGVzY2FwZVJlZ0V4Q2hhcnM6IGZ1bmN0aW9uKHN0cikgew0KICAgICAgICAgICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvW1wtXFtcXVwvXHtcfVwoXClcKlwrXD9cLlxcXF5cJFx8XS9nLCAiXFwkJiIpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGlzU3RyaW5nOiBmdW5jdGlvbihvYmopIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gInN0cmluZyI7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaXNOdW1iZXI6IGZ1bmN0aW9uKG9iaikgew0KICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAibnVtYmVyIjsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBpc0FycmF5OiAkLmlzQXJyYXksDQogICAgICAgICAgICBpc0Z1bmN0aW9uOiAkLmlzRnVuY3Rpb24sDQogICAgICAgICAgICBpc09iamVjdDogJC5pc1BsYWluT2JqZWN0LA0KICAgICAgICAgICAgaXNVbmRlZmluZWQ6IGZ1bmN0aW9uKG9iaikgew0KICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIjsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICB0b1N0cjogZnVuY3Rpb24gdG9TdHIocykgew0KICAgICAgICAgICAgICAgIHJldHVybiBfLmlzVW5kZWZpbmVkKHMpIHx8IHMgPT09IG51bGwgPyAiIiA6IHMgKyAiIjsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBiaW5kOiAkLnByb3h5LA0KICAgICAgICAgICAgZWFjaDogZnVuY3Rpb24oY29sbGVjdGlvbiwgY2IpIHsNCiAgICAgICAgICAgICAgICAkLmVhY2goY29sbGVjdGlvbiwgcmV2ZXJzZUFyZ3MpOw0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVyc2VBcmdzKGluZGV4LCB2YWx1ZSkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2IodmFsdWUsIGluZGV4KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgbWFwOiAkLm1hcCwNCiAgICAgICAgICAgIGZpbHRlcjogJC5ncmVwLA0KICAgICAgICAgICAgZXZlcnk6IGZ1bmN0aW9uKG9iaiwgdGVzdCkgew0KICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB0cnVlOw0KICAgICAgICAgICAgICAgIGlmICghb2JqKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICQuZWFjaChvYmosIGZ1bmN0aW9uKGtleSwgdmFsKSB7DQogICAgICAgICAgICAgICAgICAgIGlmICghKHJlc3VsdCA9IHRlc3QuY2FsbChudWxsLCB2YWwsIGtleSwgb2JqKSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIHJldHVybiAhIXJlc3VsdDsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBzb21lOiBmdW5jdGlvbihvYmosIHRlc3QpIHsNCiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZmFsc2U7DQogICAgICAgICAgICAgICAgaWYgKCFvYmopIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgJC5lYWNoKG9iaiwgZnVuY3Rpb24oa2V5LCB2YWwpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9IHRlc3QuY2FsbChudWxsLCB2YWwsIGtleSwgb2JqKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgcmV0dXJuICEhcmVzdWx0Ow0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIG1peGluOiAkLmV4dGVuZCwNCiAgICAgICAgICAgIGdldFVuaXF1ZUlkOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICB2YXIgY291bnRlciA9IDA7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY291bnRlcisrOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9KCksDQogICAgICAgICAgICB0ZW1wbGF0aWZ5OiBmdW5jdGlvbiB0ZW1wbGF0aWZ5KG9iaikgew0KICAgICAgICAgICAgICAgIHJldHVybiAkLmlzRnVuY3Rpb24ob2JqKSA/IG9iaiA6IHRlbXBsYXRlOw0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHRlbXBsYXRlKCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKG9iaik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGRlZmVyOiBmdW5jdGlvbihmbikgew0KICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZm4sIDApOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGRlYm91bmNlOiBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsNCiAgICAgICAgICAgICAgICB2YXIgdGltZW91dCwgcmVzdWx0Ow0KICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzLCBsYXRlciwgY2FsbE5vdzsNCiAgICAgICAgICAgICAgICAgICAgbGF0ZXIgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpbW1lZGlhdGUpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0Ow0KICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7DQogICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxOb3cpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHRocm90dGxlOiBmdW5jdGlvbihmdW5jLCB3YWl0KSB7DQogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQsIGFyZ3MsIHRpbWVvdXQsIHJlc3VsdCwgcHJldmlvdXMsIGxhdGVyOw0KICAgICAgICAgICAgICAgIHByZXZpb3VzID0gMDsNCiAgICAgICAgICAgICAgICBsYXRlciA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICBwcmV2aW91cyA9IG5ldyBEYXRlKCk7DQogICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgbm93ID0gbmV3IERhdGUoKSwgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBwcmV2aW91cyk7DQogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSB0aGlzOw0KICAgICAgICAgICAgICAgICAgICBhcmdzID0gYXJndW1lbnRzOw0KICAgICAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXMgPSBub3c7DQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOw0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aW1lb3V0KSB7DQogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgcmVtYWluaW5nKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgbm9vcDogZnVuY3Rpb24oKSB7fQ0KICAgICAgICB9Ow0KICAgIH0oKTsNCiAgICB2YXIgVkVSU0lPTiA9ICIwLjEwLjQiOw0KICAgIHZhciB0b2tlbml6ZXJzID0gZnVuY3Rpb24oKSB7DQogICAgICAgICJ1c2Ugc3RyaWN0IjsNCiAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIG5vbndvcmQ6IG5vbndvcmQsDQogICAgICAgICAgICB3aGl0ZXNwYWNlOiB3aGl0ZXNwYWNlLA0KICAgICAgICAgICAgb2JqOiB7DQogICAgICAgICAgICAgICAgbm9ud29yZDogZ2V0T2JqVG9rZW5pemVyKG5vbndvcmQpLA0KICAgICAgICAgICAgICAgIHdoaXRlc3BhY2U6IGdldE9ialRva2VuaXplcih3aGl0ZXNwYWNlKQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBmdW5jdGlvbiB3aGl0ZXNwYWNlKHN0cikgew0KICAgICAgICAgICAgc3RyID0gXy50b1N0cihzdHIpOw0KICAgICAgICAgICAgcmV0dXJuIHN0ciA/IHN0ci5zcGxpdCgvXHMrLykgOiBbXTsNCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiBub253b3JkKHN0cikgew0KICAgICAgICAgICAgc3RyID0gXy50b1N0cihzdHIpOw0KICAgICAgICAgICAgcmV0dXJuIHN0ciA/IHN0ci5zcGxpdCgvXFcrLykgOiBbXTsNCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiBnZXRPYmpUb2tlbml6ZXIodG9rZW5pemVyKSB7DQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gc2V0S2V5KCkgew0KICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOw0KICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiB0b2tlbml6ZShvKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbnMgPSBbXTsNCiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGFyZ3MsIGZ1bmN0aW9uKGspIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRva2VucyA9IHRva2Vucy5jb25jYXQodG9rZW5pemVyKF8udG9TdHIob1trXSkpKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0b2tlbnM7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIH07DQogICAgICAgIH0NCiAgICB9KCk7DQogICAgdmFyIExydUNhY2hlID0gZnVuY3Rpb24oKSB7DQogICAgICAgICJ1c2Ugc3RyaWN0IjsNCiAgICAgICAgZnVuY3Rpb24gTHJ1Q2FjaGUobWF4U2l6ZSkgew0KICAgICAgICAgICAgdGhpcy5tYXhTaXplID0gXy5pc051bWJlcihtYXhTaXplKSA/IG1heFNpemUgOiAxMDA7DQogICAgICAgICAgICB0aGlzLnJlc2V0KCk7DQogICAgICAgICAgICBpZiAodGhpcy5tYXhTaXplIDw9IDApIHsNCiAgICAgICAgICAgICAgICB0aGlzLnNldCA9IHRoaXMuZ2V0ID0gJC5ub29wOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIF8ubWl4aW4oTHJ1Q2FjaGUucHJvdG90eXBlLCB7DQogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChrZXksIHZhbCkgew0KICAgICAgICAgICAgICAgIHZhciB0YWlsSXRlbSA9IHRoaXMubGlzdC50YWlsLCBub2RlOw0KICAgICAgICAgICAgICAgIGlmICh0aGlzLnNpemUgPj0gdGhpcy5tYXhTaXplKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdC5yZW1vdmUodGFpbEl0ZW0pOw0KICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5oYXNoW3RhaWxJdGVtLmtleV07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmIChub2RlID0gdGhpcy5oYXNoW2tleV0pIHsNCiAgICAgICAgICAgICAgICAgICAgbm9kZS52YWwgPSB2YWw7DQogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdC5tb3ZlVG9Gcm9udChub2RlKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBub2RlID0gbmV3IE5vZGUoa2V5LCB2YWwpOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3QuYWRkKG5vZGUpOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLmhhc2hba2V5XSA9IG5vZGU7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2l6ZSsrOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldChrZXkpIHsNCiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMuaGFzaFtrZXldOw0KICAgICAgICAgICAgICAgIGlmIChub2RlKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdC5tb3ZlVG9Gcm9udChub2RlKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICByZXNldDogZnVuY3Rpb24gcmVzZXQoKSB7DQogICAgICAgICAgICAgICAgdGhpcy5zaXplID0gMDsNCiAgICAgICAgICAgICAgICB0aGlzLmhhc2ggPSB7fTsNCiAgICAgICAgICAgICAgICB0aGlzLmxpc3QgPSBuZXcgTGlzdCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgZnVuY3Rpb24gTGlzdCgpIHsNCiAgICAgICAgICAgIHRoaXMuaGVhZCA9IHRoaXMudGFpbCA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgXy5taXhpbihMaXN0LnByb3RvdHlwZSwgew0KICAgICAgICAgICAgYWRkOiBmdW5jdGlvbiBhZGQobm9kZSkgew0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmhlYWQpIHsNCiAgICAgICAgICAgICAgICAgICAgbm9kZS5uZXh0ID0gdGhpcy5oZWFkOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLmhlYWQucHJldiA9IG5vZGU7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHRoaXMuaGVhZCA9IG5vZGU7DQogICAgICAgICAgICAgICAgdGhpcy50YWlsID0gdGhpcy50YWlsIHx8IG5vZGU7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUobm9kZSkgew0KICAgICAgICAgICAgICAgIG5vZGUucHJldiA/IG5vZGUucHJldi5uZXh0ID0gbm9kZS5uZXh0IDogdGhpcy5oZWFkID0gbm9kZS5uZXh0Ow0KICAgICAgICAgICAgICAgIG5vZGUubmV4dCA/IG5vZGUubmV4dC5wcmV2ID0gbm9kZS5wcmV2IDogdGhpcy50YWlsID0gbm9kZS5wcmV2Ow0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIG1vdmVUb0Zyb250OiBmdW5jdGlvbihub2RlKSB7DQogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUobm9kZSk7DQogICAgICAgICAgICAgICAgdGhpcy5hZGQobm9kZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICBmdW5jdGlvbiBOb2RlKGtleSwgdmFsKSB7DQogICAgICAgICAgICB0aGlzLmtleSA9IGtleTsNCiAgICAgICAgICAgIHRoaXMudmFsID0gdmFsOw0KICAgICAgICAgICAgdGhpcy5wcmV2ID0gdGhpcy5uZXh0ID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gTHJ1Q2FjaGU7DQogICAgfSgpOw0KICAgIHZhciBQZXJzaXN0ZW50U3RvcmFnZSA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAidXNlIHN0cmljdCI7DQogICAgICAgIHZhciBscywgbWV0aG9kczsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIGxzID0gd2luZG93LmxvY2FsU3RvcmFnZTsNCiAgICAgICAgICAgIGxzLnNldEl0ZW0oIn5+fiIsICIhIik7DQogICAgICAgICAgICBscy5yZW1vdmVJdGVtKCJ+fn4iKTsNCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7DQogICAgICAgICAgICBscyA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gUGVyc2lzdGVudFN0b3JhZ2UobmFtZXNwYWNlKSB7DQogICAgICAgICAgICB0aGlzLnByZWZpeCA9IFsgIl9fIiwgbmFtZXNwYWNlLCAiX18iIF0uam9pbigiIik7DQogICAgICAgICAgICB0aGlzLnR0bEtleSA9ICJfX3R0bF9fIjsNCiAgICAgICAgICAgIHRoaXMua2V5TWF0Y2hlciA9IG5ldyBSZWdFeHAoIl4iICsgXy5lc2NhcGVSZWdFeENoYXJzKHRoaXMucHJlZml4KSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGxzICYmIHdpbmRvdy5KU09OKSB7DQogICAgICAgICAgICBtZXRob2RzID0gew0KICAgICAgICAgICAgICAgIF9wcmVmaXg6IGZ1bmN0aW9uKGtleSkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wcmVmaXggKyBrZXk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBfdHRsS2V5OiBmdW5jdGlvbihrZXkpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3ByZWZpeChrZXkpICsgdGhpcy50dGxLZXk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgew0KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0V4cGlyZWQoa2V5KSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoa2V5KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVjb2RlKGxzLmdldEl0ZW0odGhpcy5fcHJlZml4KGtleSkpKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIHR0bCkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc051bWJlcih0dGwpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBscy5zZXRJdGVtKHRoaXMuX3R0bEtleShrZXkpLCBlbmNvZGUobm93KCkgKyB0dGwpKTsNCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxzLnJlbW92ZUl0ZW0odGhpcy5fdHRsS2V5KGtleSkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBscy5zZXRJdGVtKHRoaXMuX3ByZWZpeChrZXkpLCBlbmNvZGUodmFsKSk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSkgew0KICAgICAgICAgICAgICAgICAgICBscy5yZW1vdmVJdGVtKHRoaXMuX3R0bEtleShrZXkpKTsNCiAgICAgICAgICAgICAgICAgICAgbHMucmVtb3ZlSXRlbSh0aGlzLl9wcmVmaXgoa2V5KSk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgaSwga2V5LCBrZXlzID0gW10sIGxlbiA9IGxzLmxlbmd0aDsNCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGtleSA9IGxzLmtleShpKSkubWF0Y2godGhpcy5rZXlNYXRjaGVyKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleXMucHVzaChrZXkucmVwbGFjZSh0aGlzLmtleU1hdGNoZXIsICIiKSk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0ga2V5cy5sZW5ndGg7IGktLTsgKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShrZXlzW2ldKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIGlzRXhwaXJlZDogZnVuY3Rpb24oa2V5KSB7DQogICAgICAgICAgICAgICAgICAgIHZhciB0dGwgPSBkZWNvZGUobHMuZ2V0SXRlbSh0aGlzLl90dGxLZXkoa2V5KSkpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gXy5pc051bWJlcih0dGwpICYmIG5vdygpID4gdHRsID8gdHJ1ZSA6IGZhbHNlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBtZXRob2RzID0gew0KICAgICAgICAgICAgICAgIGdldDogXy5ub29wLA0KICAgICAgICAgICAgICAgIHNldDogXy5ub29wLA0KICAgICAgICAgICAgICAgIHJlbW92ZTogXy5ub29wLA0KICAgICAgICAgICAgICAgIGNsZWFyOiBfLm5vb3AsDQogICAgICAgICAgICAgICAgaXNFeHBpcmVkOiBfLm5vb3ANCiAgICAgICAgICAgIH07DQogICAgICAgIH0NCiAgICAgICAgXy5taXhpbihQZXJzaXN0ZW50U3RvcmFnZS5wcm90b3R5cGUsIG1ldGhvZHMpOw0KICAgICAgICByZXR1cm4gUGVyc2lzdGVudFN0b3JhZ2U7DQogICAgICAgIGZ1bmN0aW9uIG5vdygpIHsNCiAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsNCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiBlbmNvZGUodmFsKSB7DQogICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoXy5pc1VuZGVmaW5lZCh2YWwpID8gbnVsbCA6IHZhbCk7DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gZGVjb2RlKHZhbCkgew0KICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsKTsNCiAgICAgICAgfQ0KICAgIH0oKTsNCiAgICB2YXIgVHJhbnNwb3J0ID0gZnVuY3Rpb24oKSB7DQogICAgICAgICJ1c2Ugc3RyaWN0IjsNCiAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0c0NvdW50ID0gMCwgcGVuZGluZ1JlcXVlc3RzID0ge30sIG1heFBlbmRpbmdSZXF1ZXN0cyA9IDYsIHNoYXJlZENhY2hlID0gbmV3IExydUNhY2hlKDEwKTsNCiAgICAgICAgZnVuY3Rpb24gVHJhbnNwb3J0KG8pIHsNCiAgICAgICAgICAgIG8gPSBvIHx8IHt9Ow0KICAgICAgICAgICAgdGhpcy5jYW5jZWxsZWQgPSBmYWxzZTsNCiAgICAgICAgICAgIHRoaXMubGFzdFVybCA9IG51bGw7DQogICAgICAgICAgICB0aGlzLl9zZW5kID0gby50cmFuc3BvcnQgPyBjYWxsYmFja1RvRGVmZXJyZWQoby50cmFuc3BvcnQpIDogJC5hamF4Ow0KICAgICAgICAgICAgdGhpcy5fZ2V0ID0gby5yYXRlTGltaXRlciA/IG8ucmF0ZUxpbWl0ZXIodGhpcy5fZ2V0KSA6IHRoaXMuX2dldDsNCiAgICAgICAgICAgIHRoaXMuX2NhY2hlID0gby5jYWNoZSA9PT0gZmFsc2UgPyBuZXcgTHJ1Q2FjaGUoMCkgOiBzaGFyZWRDYWNoZTsNCiAgICAgICAgfQ0KICAgICAgICBUcmFuc3BvcnQuc2V0TWF4UGVuZGluZ1JlcXVlc3RzID0gZnVuY3Rpb24gc2V0TWF4UGVuZGluZ1JlcXVlc3RzKG51bSkgew0KICAgICAgICAgICAgbWF4UGVuZGluZ1JlcXVlc3RzID0gbnVtOw0KICAgICAgICB9Ow0KICAgICAgICBUcmFuc3BvcnQucmVzZXRDYWNoZSA9IGZ1bmN0aW9uIHJlc2V0Q2FjaGUoKSB7DQogICAgICAgICAgICBzaGFyZWRDYWNoZS5yZXNldCgpOw0KICAgICAgICB9Ow0KICAgICAgICBfLm1peGluKFRyYW5zcG9ydC5wcm90b3R5cGUsIHsNCiAgICAgICAgICAgIF9nZXQ6IGZ1bmN0aW9uKHVybCwgbywgY2IpIHsNCiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGpxWGhyOw0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbmNlbGxlZCB8fCB1cmwgIT09IHRoaXMubGFzdFVybCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmIChqcVhociA9IHBlbmRpbmdSZXF1ZXN0c1t1cmxdKSB7DQogICAgICAgICAgICAgICAgICAgIGpxWGhyLmRvbmUoZG9uZSkuZmFpbChmYWlsKTsNCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBlbmRpbmdSZXF1ZXN0c0NvdW50IDwgbWF4UGVuZGluZ1JlcXVlc3RzKSB7DQogICAgICAgICAgICAgICAgICAgIHBlbmRpbmdSZXF1ZXN0c0NvdW50Kys7DQogICAgICAgICAgICAgICAgICAgIHBlbmRpbmdSZXF1ZXN0c1t1cmxdID0gdGhpcy5fc2VuZCh1cmwsIG8pLmRvbmUoZG9uZSkuZmFpbChmYWlsKS5hbHdheXMoYWx3YXlzKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0aGlzLm9uRGVja1JlcXVlc3RBcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBkb25lKHJlc3ApIHsNCiAgICAgICAgICAgICAgICAgICAgY2IgJiYgY2IobnVsbCwgcmVzcCk7DQogICAgICAgICAgICAgICAgICAgIHRoYXQuX2NhY2hlLnNldCh1cmwsIHJlc3ApOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBmYWlsKCkgew0KICAgICAgICAgICAgICAgICAgICBjYiAmJiBjYih0cnVlKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gYWx3YXlzKCkgew0KICAgICAgICAgICAgICAgICAgICBwZW5kaW5nUmVxdWVzdHNDb3VudC0tOw0KICAgICAgICAgICAgICAgICAgICBkZWxldGUgcGVuZGluZ1JlcXVlc3RzW3VybF07DQogICAgICAgICAgICAgICAgICAgIGlmICh0aGF0Lm9uRGVja1JlcXVlc3RBcmdzKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB0aGF0Ll9nZXQuYXBwbHkodGhhdCwgdGhhdC5vbkRlY2tSZXF1ZXN0QXJncyk7DQogICAgICAgICAgICAgICAgICAgICAgICB0aGF0Lm9uRGVja1JlcXVlc3RBcmdzID0gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKHVybCwgbywgY2IpIHsNCiAgICAgICAgICAgICAgICB2YXIgcmVzcDsNCiAgICAgICAgICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKG8pKSB7DQogICAgICAgICAgICAgICAgICAgIGNiID0gbzsNCiAgICAgICAgICAgICAgICAgICAgbyA9IHt9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbGxlZCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIHRoaXMubGFzdFVybCA9IHVybDsNCiAgICAgICAgICAgICAgICBpZiAocmVzcCA9IHRoaXMuX2NhY2hlLmdldCh1cmwpKSB7DQogICAgICAgICAgICAgICAgICAgIF8uZGVmZXIoZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBjYiAmJiBjYihudWxsLCByZXNwKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZ2V0KHVybCwgbywgY2IpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm4gISFyZXNwOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGNhbmNlbDogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgdGhpcy5jYW5jZWxsZWQgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIFRyYW5zcG9ydDsNCiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2tUb0RlZmVycmVkKGZuKSB7DQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gY3VzdG9tU2VuZFdyYXBwZXIodXJsLCBvKSB7DQogICAgICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gJC5EZWZlcnJlZCgpOw0KICAgICAgICAgICAgICAgIGZuKHVybCwgbywgb25TdWNjZXNzLCBvbkVycm9yKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQ7DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gb25TdWNjZXNzKHJlc3ApIHsNCiAgICAgICAgICAgICAgICAgICAgXy5kZWZlcihmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzcCk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBvbkVycm9yKGVycikgew0KICAgICAgICAgICAgICAgICAgICBfLmRlZmVyKGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGVycik7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgIH0NCiAgICB9KCk7DQogICAgdmFyIFNlYXJjaEluZGV4ID0gZnVuY3Rpb24oKSB7DQogICAgICAgICJ1c2Ugc3RyaWN0IjsNCiAgICAgICAgZnVuY3Rpb24gU2VhcmNoSW5kZXgobykgew0KICAgICAgICAgICAgbyA9IG8gfHwge307DQogICAgICAgICAgICBpZiAoIW8uZGF0dW1Ub2tlbml6ZXIgfHwgIW8ucXVlcnlUb2tlbml6ZXIpIHsNCiAgICAgICAgICAgICAgICAkLmVycm9yKCJkYXR1bVRva2VuaXplciBhbmQgcXVlcnlUb2tlbml6ZXIgYXJlIGJvdGggcmVxdWlyZWQiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuZGF0dW1Ub2tlbml6ZXIgPSBvLmRhdHVtVG9rZW5pemVyOw0KICAgICAgICAgICAgdGhpcy5xdWVyeVRva2VuaXplciA9IG8ucXVlcnlUb2tlbml6ZXI7DQogICAgICAgICAgICB0aGlzLnJlc2V0KCk7DQogICAgICAgIH0NCiAgICAgICAgXy5taXhpbihTZWFyY2hJbmRleC5wcm90b3R5cGUsIHsNCiAgICAgICAgICAgIGJvb3RzdHJhcDogZnVuY3Rpb24gYm9vdHN0cmFwKG8pIHsNCiAgICAgICAgICAgICAgICB0aGlzLmRhdHVtcyA9IG8uZGF0dW1zOw0KICAgICAgICAgICAgICAgIHRoaXMudHJpZSA9IG8udHJpZTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBhZGQ6IGZ1bmN0aW9uKGRhdGEpIHsNCiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7DQogICAgICAgICAgICAgICAgZGF0YSA9IF8uaXNBcnJheShkYXRhKSA/IGRhdGEgOiBbIGRhdGEgXTsNCiAgICAgICAgICAgICAgICBfLmVhY2goZGF0YSwgZnVuY3Rpb24oZGF0dW0pIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGlkLCB0b2tlbnM7DQogICAgICAgICAgICAgICAgICAgIGlkID0gdGhhdC5kYXR1bXMucHVzaChkYXR1bSkgLSAxOw0KICAgICAgICAgICAgICAgICAgICB0b2tlbnMgPSBub3JtYWxpemVUb2tlbnModGhhdC5kYXR1bVRva2VuaXplcihkYXR1bSkpOw0KICAgICAgICAgICAgICAgICAgICBfLmVhY2godG9rZW5zLCBmdW5jdGlvbih0b2tlbikgew0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUsIGNoYXJzLCBjaDsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0aGF0LnRyaWU7DQogICAgICAgICAgICAgICAgICAgICAgICBjaGFycyA9IHRva2VuLnNwbGl0KCIiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChjaCA9IGNoYXJzLnNoaWZ0KCkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZHJlbltjaF0gfHwgKG5vZGUuY2hpbGRyZW5bY2hdID0gbmV3Tm9kZSgpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmlkcy5wdXNoKGlkKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQocXVlcnkpIHsNCiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRva2VucywgbWF0Y2hlczsNCiAgICAgICAgICAgICAgICB0b2tlbnMgPSBub3JtYWxpemVUb2tlbnModGhpcy5xdWVyeVRva2VuaXplcihxdWVyeSkpOw0KICAgICAgICAgICAgICAgIF8uZWFjaCh0b2tlbnMsIGZ1bmN0aW9uKHRva2VuKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBub2RlLCBjaGFycywgY2gsIGlkczsNCiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoZXMgJiYgbWF0Y2hlcy5sZW5ndGggPT09IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBub2RlID0gdGhhdC50cmllOw0KICAgICAgICAgICAgICAgICAgICBjaGFycyA9IHRva2VuLnNwbGl0KCIiKTsNCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgJiYgKGNoID0gY2hhcnMuc2hpZnQoKSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkcmVuW2NoXTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSAmJiBjaGFycy5sZW5ndGggPT09IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlkcyA9IG5vZGUuaWRzLnNsaWNlKDApOw0KICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcyA9IG1hdGNoZXMgPyBnZXRJbnRlcnNlY3Rpb24obWF0Y2hlcywgaWRzKSA6IGlkczsNCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXMgPSBbXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaGVzID8gXy5tYXAodW5pcXVlKG1hdGNoZXMpLCBmdW5jdGlvbihpZCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5kYXR1bXNbaWRdOw0KICAgICAgICAgICAgICAgIH0pIDogW107DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KCkgew0KICAgICAgICAgICAgICAgIHRoaXMuZGF0dW1zID0gW107DQogICAgICAgICAgICAgICAgdGhpcy50cmllID0gbmV3Tm9kZSgpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24gc2VyaWFsaXplKCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgICAgIGRhdHVtczogdGhpcy5kYXR1bXMsDQogICAgICAgICAgICAgICAgICAgIHRyaWU6IHRoaXMudHJpZQ0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gU2VhcmNoSW5kZXg7DQogICAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVRva2Vucyh0b2tlbnMpIHsNCiAgICAgICAgICAgIHRva2VucyA9IF8uZmlsdGVyKHRva2VucywgZnVuY3Rpb24odG9rZW4pIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gISF0b2tlbjsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgdG9rZW5zID0gXy5tYXAodG9rZW5zLCBmdW5jdGlvbih0b2tlbikgew0KICAgICAgICAgICAgICAgIHJldHVybiB0b2tlbi50b0xvd2VyQ2FzZSgpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICByZXR1cm4gdG9rZW5zOw0KICAgICAgICB9DQogICAgICAgIGZ1bmN0aW9uIG5ld05vZGUoKSB7DQogICAgICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgICAgIGlkczogW10sDQogICAgICAgICAgICAgICAgY2hpbGRyZW46IHt9DQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQogICAgICAgIGZ1bmN0aW9uIHVuaXF1ZShhcnJheSkgew0KICAgICAgICAgICAgdmFyIHNlZW4gPSB7fSwgdW5pcXVlcyA9IFtdOw0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7DQogICAgICAgICAgICAgICAgaWYgKCFzZWVuW2FycmF5W2ldXSkgew0KICAgICAgICAgICAgICAgICAgICBzZWVuW2FycmF5W2ldXSA9IHRydWU7DQogICAgICAgICAgICAgICAgICAgIHVuaXF1ZXMucHVzaChhcnJheVtpXSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIHVuaXF1ZXM7DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gZ2V0SW50ZXJzZWN0aW9uKGFycmF5QSwgYXJyYXlCKSB7DQogICAgICAgICAgICB2YXIgYWkgPSAwLCBiaSA9IDAsIGludGVyc2VjdGlvbiA9IFtdOw0KICAgICAgICAgICAgYXJyYXlBID0gYXJyYXlBLnNvcnQoY29tcGFyZSk7DQogICAgICAgICAgICBhcnJheUIgPSBhcnJheUIuc29ydChjb21wYXJlKTsNCiAgICAgICAgICAgIHZhciBsZW5BcnJheUEgPSBhcnJheUEubGVuZ3RoLCBsZW5BcnJheUIgPSBhcnJheUIubGVuZ3RoOw0KICAgICAgICAgICAgd2hpbGUgKGFpIDwgbGVuQXJyYXlBICYmIGJpIDwgbGVuQXJyYXlCKSB7DQogICAgICAgICAgICAgICAgaWYgKGFycmF5QVthaV0gPCBhcnJheUJbYmldKSB7DQogICAgICAgICAgICAgICAgICAgIGFpKys7DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcnJheUFbYWldID4gYXJyYXlCW2JpXSkgew0KICAgICAgICAgICAgICAgICAgICBiaSsrOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbi5wdXNoKGFycmF5QVthaV0pOw0KICAgICAgICAgICAgICAgICAgICBhaSsrOw0KICAgICAgICAgICAgICAgICAgICBiaSsrOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiBpbnRlcnNlY3Rpb247DQogICAgICAgICAgICBmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gYSAtIGI7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9KCk7DQogICAgdmFyIG9QYXJzZXIgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgInVzZSBzdHJpY3QiOw0KICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgbG9jYWw6IGdldExvY2FsLA0KICAgICAgICAgICAgcHJlZmV0Y2g6IGdldFByZWZldGNoLA0KICAgICAgICAgICAgcmVtb3RlOiBnZXRSZW1vdGUNCiAgICAgICAgfTsNCiAgICAgICAgZnVuY3Rpb24gZ2V0TG9jYWwobykgew0KICAgICAgICAgICAgcmV0dXJuIG8ubG9jYWwgfHwgbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiBnZXRQcmVmZXRjaChvKSB7DQogICAgICAgICAgICB2YXIgcHJlZmV0Y2gsIGRlZmF1bHRzOw0KICAgICAgICAgICAgZGVmYXVsdHMgPSB7DQogICAgICAgICAgICAgICAgdXJsOiBudWxsLA0KICAgICAgICAgICAgICAgIHRodW1icHJpbnQ6ICIiLA0KICAgICAgICAgICAgICAgIHR0bDogMjQgKiA2MCAqIDYwICogMWUzLA0KICAgICAgICAgICAgICAgIGZpbHRlcjogbnVsbCwNCiAgICAgICAgICAgICAgICBhamF4OiB7fQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIGlmIChwcmVmZXRjaCA9IG8ucHJlZmV0Y2ggfHwgbnVsbCkgew0KICAgICAgICAgICAgICAgIHByZWZldGNoID0gXy5pc1N0cmluZyhwcmVmZXRjaCkgPyB7DQogICAgICAgICAgICAgICAgICAgIHVybDogcHJlZmV0Y2gNCiAgICAgICAgICAgICAgICB9IDogcHJlZmV0Y2g7DQogICAgICAgICAgICAgICAgcHJlZmV0Y2ggPSBfLm1peGluKGRlZmF1bHRzLCBwcmVmZXRjaCk7DQogICAgICAgICAgICAgICAgcHJlZmV0Y2gudGh1bWJwcmludCA9IFZFUlNJT04gKyBwcmVmZXRjaC50aHVtYnByaW50Ow0KICAgICAgICAgICAgICAgIHByZWZldGNoLmFqYXgudHlwZSA9IHByZWZldGNoLmFqYXgudHlwZSB8fCAiR0VUIjsNCiAgICAgICAgICAgICAgICBwcmVmZXRjaC5hamF4LmRhdGFUeXBlID0gcHJlZmV0Y2guYWpheC5kYXRhVHlwZSB8fCAianNvbiI7DQogICAgICAgICAgICAgICAgIXByZWZldGNoLnVybCAmJiAkLmVycm9yKCJwcmVmZXRjaCByZXF1aXJlcyB1cmwgdG8gYmUgc2V0Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gcHJlZmV0Y2g7DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gZ2V0UmVtb3RlKG8pIHsNCiAgICAgICAgICAgIHZhciByZW1vdGUsIGRlZmF1bHRzOw0KICAgICAgICAgICAgZGVmYXVsdHMgPSB7DQogICAgICAgICAgICAgICAgdXJsOiBudWxsLA0KICAgICAgICAgICAgICAgIGNhY2hlOiB0cnVlLA0KICAgICAgICAgICAgICAgIHdpbGRjYXJkOiAiJVFVRVJZIiwNCiAgICAgICAgICAgICAgICByZXBsYWNlOiBudWxsLA0KICAgICAgICAgICAgICAgIHJhdGVMaW1pdEJ5OiAiZGVib3VuY2UiLA0KICAgICAgICAgICAgICAgIHJhdGVMaW1pdFdhaXQ6IDMwMCwNCiAgICAgICAgICAgICAgICBzZW5kOiBudWxsLA0KICAgICAgICAgICAgICAgIGZpbHRlcjogbnVsbCwNCiAgICAgICAgICAgICAgICBhamF4OiB7fQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIGlmIChyZW1vdGUgPSBvLnJlbW90ZSB8fCBudWxsKSB7DQogICAgICAgICAgICAgICAgcmVtb3RlID0gXy5pc1N0cmluZyhyZW1vdGUpID8gew0KICAgICAgICAgICAgICAgICAgICB1cmw6IHJlbW90ZQ0KICAgICAgICAgICAgICAgIH0gOiByZW1vdGU7DQogICAgICAgICAgICAgICAgcmVtb3RlID0gXy5taXhpbihkZWZhdWx0cywgcmVtb3RlKTsNCiAgICAgICAgICAgICAgICByZW1vdGUucmF0ZUxpbWl0ZXIgPSAvXnRocm90dGxlJC9pLnRlc3QocmVtb3RlLnJhdGVMaW1pdEJ5KSA/IGJ5VGhyb3R0bGUocmVtb3RlLnJhdGVMaW1pdFdhaXQpIDogYnlEZWJvdW5jZShyZW1vdGUucmF0ZUxpbWl0V2FpdCk7DQogICAgICAgICAgICAgICAgcmVtb3RlLmFqYXgudHlwZSA9IHJlbW90ZS5hamF4LnR5cGUgfHwgIkdFVCI7DQogICAgICAgICAgICAgICAgcmVtb3RlLmFqYXguZGF0YVR5cGUgPSByZW1vdGUuYWpheC5kYXRhVHlwZSB8fCAianNvbiI7DQogICAgICAgICAgICAgICAgZGVsZXRlIHJlbW90ZS5yYXRlTGltaXRCeTsNCiAgICAgICAgICAgICAgICBkZWxldGUgcmVtb3RlLnJhdGVMaW1pdFdhaXQ7DQogICAgICAgICAgICAgICAgIXJlbW90ZS51cmwgJiYgJC5lcnJvcigicmVtb3RlIHJlcXVpcmVzIHVybCB0byBiZSBzZXQiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiByZW1vdGU7DQogICAgICAgICAgICBmdW5jdGlvbiBieURlYm91bmNlKHdhaXQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZm4pIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF8uZGVib3VuY2UoZm4sIHdhaXQpOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9DQogICAgICAgICAgICBmdW5jdGlvbiBieVRocm90dGxlKHdhaXQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZm4pIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF8udGhyb3R0bGUoZm4sIHdhaXQpOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9KCk7DQogICAgKGZ1bmN0aW9uKHJvb3QpIHsNCiAgICAgICAgInVzZSBzdHJpY3QiOw0KICAgICAgICB2YXIgb2xkLCBrZXlzOw0KICAgICAgICBvbGQgPSByb290LkJsb29kaG91bmQ7DQogICAgICAgIGtleXMgPSB7DQogICAgICAgICAgICBkYXRhOiAiZGF0YSIsDQogICAgICAgICAgICBwcm90b2NvbDogInByb3RvY29sIiwNCiAgICAgICAgICAgIHRodW1icHJpbnQ6ICJ0aHVtYnByaW50Ig0KICAgICAgICB9Ow0KICAgICAgICByb290LkJsb29kaG91bmQgPSBCbG9vZGhvdW5kOw0KICAgICAgICBmdW5jdGlvbiBCbG9vZGhvdW5kKG8pIHsNCiAgICAgICAgICAgIGlmICghbyB8fCAhby5sb2NhbCAmJiAhby5wcmVmZXRjaCAmJiAhby5yZW1vdGUpIHsNCiAgICAgICAgICAgICAgICAkLmVycm9yKCJvbmUgb2YgbG9jYWwsIHByZWZldGNoLCBvciByZW1vdGUgaXMgcmVxdWlyZWQiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMubGltaXQgPSBvLmxpbWl0IHx8IDU7DQogICAgICAgICAgICB0aGlzLnNvcnRlciA9IGdldFNvcnRlcihvLnNvcnRlcik7DQogICAgICAgICAgICB0aGlzLmR1cERldGVjdG9yID0gby5kdXBEZXRlY3RvciB8fCBpZ25vcmVEdXBsaWNhdGVzOw0KICAgICAgICAgICAgdGhpcy5sb2NhbCA9IG9QYXJzZXIubG9jYWwobyk7DQogICAgICAgICAgICB0aGlzLnByZWZldGNoID0gb1BhcnNlci5wcmVmZXRjaChvKTsNCiAgICAgICAgICAgIHRoaXMucmVtb3RlID0gb1BhcnNlci5yZW1vdGUobyk7DQogICAgICAgICAgICB0aGlzLmNhY2hlS2V5ID0gdGhpcy5wcmVmZXRjaCA/IHRoaXMucHJlZmV0Y2guY2FjaGVLZXkgfHwgdGhpcy5wcmVmZXRjaC51cmwgOiBudWxsOw0KICAgICAgICAgICAgdGhpcy5pbmRleCA9IG5ldyBTZWFyY2hJbmRleCh7DQogICAgICAgICAgICAgICAgZGF0dW1Ub2tlbml6ZXI6IG8uZGF0dW1Ub2tlbml6ZXIsDQogICAgICAgICAgICAgICAgcXVlcnlUb2tlbml6ZXI6IG8ucXVlcnlUb2tlbml6ZXINCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgdGhpcy5zdG9yYWdlID0gdGhpcy5jYWNoZUtleSA/IG5ldyBQZXJzaXN0ZW50U3RvcmFnZSh0aGlzLmNhY2hlS2V5KSA6IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgQmxvb2Rob3VuZC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gbm9Db25mbGljdCgpIHsNCiAgICAgICAgICAgIHJvb3QuQmxvb2Rob3VuZCA9IG9sZDsNCiAgICAgICAgICAgIHJldHVybiBCbG9vZGhvdW5kOw0KICAgICAgICB9Ow0KICAgICAgICBCbG9vZGhvdW5kLnRva2VuaXplcnMgPSB0b2tlbml6ZXJzOw0KICAgICAgICBfLm1peGluKEJsb29kaG91bmQucHJvdG90eXBlLCB7DQogICAgICAgICAgICBfbG9hZFByZWZldGNoOiBmdW5jdGlvbiBsb2FkUHJlZmV0Y2gobykgew0KICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgc2VyaWFsaXplZCwgZGVmZXJyZWQ7DQogICAgICAgICAgICAgICAgaWYgKHNlcmlhbGl6ZWQgPSB0aGlzLl9yZWFkRnJvbVN0b3JhZ2Uoby50aHVtYnByaW50KSkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmluZGV4LmJvb3RzdHJhcChzZXJpYWxpemVkKTsNCiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCkucmVzb2x2ZSgpOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGRlZmVycmVkID0gJC5hamF4KG8udXJsLCBvLmFqYXgpLmRvbmUoaGFuZGxlUHJlZmV0Y2hSZXNwb25zZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZDsNCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVQcmVmZXRjaFJlc3BvbnNlKHJlc3ApIHsNCiAgICAgICAgICAgICAgICAgICAgdGhhdC5jbGVhcigpOw0KICAgICAgICAgICAgICAgICAgICB0aGF0LmFkZChvLmZpbHRlciA/IG8uZmlsdGVyKHJlc3ApIDogcmVzcCk7DQogICAgICAgICAgICAgICAgICAgIHRoYXQuX3NhdmVUb1N0b3JhZ2UodGhhdC5pbmRleC5zZXJpYWxpemUoKSwgby50aHVtYnByaW50LCBvLnR0bCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9nZXRGcm9tUmVtb3RlOiBmdW5jdGlvbiBnZXRGcm9tUmVtb3RlKHF1ZXJ5LCBjYikgew0KICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdXJsLCB1cmlFbmNvZGVkUXVlcnk7DQogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnRyYW5zcG9ydCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHF1ZXJ5ID0gcXVlcnkgfHwgIiI7DQogICAgICAgICAgICAgICAgdXJpRW5jb2RlZFF1ZXJ5ID0gZW5jb2RlVVJJQ29tcG9uZW50KHF1ZXJ5KTsNCiAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLnJlbW90ZS5yZXBsYWNlID8gdGhpcy5yZW1vdGUucmVwbGFjZSh0aGlzLnJlbW90ZS51cmwsIHF1ZXJ5KSA6IHRoaXMucmVtb3RlLnVybC5yZXBsYWNlKHRoaXMucmVtb3RlLndpbGRjYXJkLCB1cmlFbmNvZGVkUXVlcnkpOw0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnRyYW5zcG9ydC5nZXQodXJsLCB0aGlzLnJlbW90ZS5hamF4LCBoYW5kbGVSZW1vdGVSZXNwb25zZSk7DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlUmVtb3RlUmVzcG9uc2UoZXJyLCByZXNwKSB7DQogICAgICAgICAgICAgICAgICAgIGVyciA/IGNiKFtdKSA6IGNiKHRoYXQucmVtb3RlLmZpbHRlciA/IHRoYXQucmVtb3RlLmZpbHRlcihyZXNwKSA6IHJlc3ApOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfY2FuY2VsTGFzdFJlbW90ZVJlcXVlc3Q6IGZ1bmN0aW9uIGNhbmNlbExhc3RSZW1vdGVSZXF1ZXN0KCkgew0KICAgICAgICAgICAgICAgIHRoaXMudHJhbnNwb3J0ICYmIHRoaXMudHJhbnNwb3J0LmNhbmNlbCgpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9zYXZlVG9TdG9yYWdlOiBmdW5jdGlvbiBzYXZlVG9TdG9yYWdlKGRhdGEsIHRodW1icHJpbnQsIHR0bCkgew0KICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0b3JhZ2UpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yYWdlLnNldChrZXlzLmRhdGEsIGRhdGEsIHR0bCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcmFnZS5zZXQoa2V5cy5wcm90b2NvbCwgbG9jYXRpb24ucHJvdG9jb2wsIHR0bCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcmFnZS5zZXQoa2V5cy50aHVtYnByaW50LCB0aHVtYnByaW50LCB0dGwpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfcmVhZEZyb21TdG9yYWdlOiBmdW5jdGlvbiByZWFkRnJvbVN0b3JhZ2UodGh1bWJwcmludCkgew0KICAgICAgICAgICAgICAgIHZhciBzdG9yZWQgPSB7fSwgaXNFeHBpcmVkOw0KICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0b3JhZ2UpIHsNCiAgICAgICAgICAgICAgICAgICAgc3RvcmVkLmRhdGEgPSB0aGlzLnN0b3JhZ2UuZ2V0KGtleXMuZGF0YSk7DQogICAgICAgICAgICAgICAgICAgIHN0b3JlZC5wcm90b2NvbCA9IHRoaXMuc3RvcmFnZS5nZXQoa2V5cy5wcm90b2NvbCk7DQogICAgICAgICAgICAgICAgICAgIHN0b3JlZC50aHVtYnByaW50ID0gdGhpcy5zdG9yYWdlLmdldChrZXlzLnRodW1icHJpbnQpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpc0V4cGlyZWQgPSBzdG9yZWQudGh1bWJwcmludCAhPT0gdGh1bWJwcmludCB8fCBzdG9yZWQucHJvdG9jb2wgIT09IGxvY2F0aW9uLnByb3RvY29sOw0KICAgICAgICAgICAgICAgIHJldHVybiBzdG9yZWQuZGF0YSAmJiAhaXNFeHBpcmVkID8gc3RvcmVkLmRhdGEgOiBudWxsOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9pbml0aWFsaXplOiBmdW5jdGlvbiBpbml0aWFsaXplKCkgew0KICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgbG9jYWwgPSB0aGlzLmxvY2FsLCBkZWZlcnJlZDsNCiAgICAgICAgICAgICAgICBkZWZlcnJlZCA9IHRoaXMucHJlZmV0Y2ggPyB0aGlzLl9sb2FkUHJlZmV0Y2godGhpcy5wcmVmZXRjaCkgOiAkLkRlZmVycmVkKCkucmVzb2x2ZSgpOw0KICAgICAgICAgICAgICAgIGxvY2FsICYmIGRlZmVycmVkLmRvbmUoYWRkTG9jYWxUb0luZGV4KTsNCiAgICAgICAgICAgICAgICB0aGlzLnRyYW5zcG9ydCA9IHRoaXMucmVtb3RlID8gbmV3IFRyYW5zcG9ydCh0aGlzLnJlbW90ZSkgOiBudWxsOw0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmluaXRQcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSgpOw0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZExvY2FsVG9JbmRleCgpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhhdC5hZGQoXy5pc0Z1bmN0aW9uKGxvY2FsKSA/IGxvY2FsKCkgOiBsb2NhbCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoZm9yY2UpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gIXRoaXMuaW5pdFByb21pc2UgfHwgZm9yY2UgPyB0aGlzLl9pbml0aWFsaXplKCkgOiB0aGlzLmluaXRQcm9taXNlOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGFkZDogZnVuY3Rpb24gYWRkKGRhdGEpIHsNCiAgICAgICAgICAgICAgICB0aGlzLmluZGV4LmFkZChkYXRhKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldChxdWVyeSwgY2IpIHsNCiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1hdGNoZXMgPSBbXSwgY2FjaGVIaXQgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICBtYXRjaGVzID0gdGhpcy5pbmRleC5nZXQocXVlcnkpOw0KICAgICAgICAgICAgICAgIG1hdGNoZXMgPSB0aGlzLnNvcnRlcihtYXRjaGVzKS5zbGljZSgwLCB0aGlzLmxpbWl0KTsNCiAgICAgICAgICAgICAgICBtYXRjaGVzLmxlbmd0aCA8IHRoaXMubGltaXQgPyBjYWNoZUhpdCA9IHRoaXMuX2dldEZyb21SZW1vdGUocXVlcnksIHJldHVyblJlbW90ZU1hdGNoZXMpIDogdGhpcy5fY2FuY2VsTGFzdFJlbW90ZVJlcXVlc3QoKTsNCiAgICAgICAgICAgICAgICBpZiAoIWNhY2hlSGl0KSB7DQogICAgICAgICAgICAgICAgICAgIChtYXRjaGVzLmxlbmd0aCA+IDAgfHwgIXRoaXMudHJhbnNwb3J0KSAmJiBjYiAmJiBjYihtYXRjaGVzKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmV0dXJuUmVtb3RlTWF0Y2hlcyhyZW1vdGVNYXRjaGVzKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaGVzV2l0aEJhY2tmaWxsID0gbWF0Y2hlcy5zbGljZSgwKTsNCiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKHJlbW90ZU1hdGNoZXMsIGZ1bmN0aW9uKHJlbW90ZU1hdGNoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNEdXBsaWNhdGU7DQogICAgICAgICAgICAgICAgICAgICAgICBpc0R1cGxpY2F0ZSA9IF8uc29tZShtYXRjaGVzV2l0aEJhY2tmaWxsLCBmdW5jdGlvbihtYXRjaCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0LmR1cERldGVjdG9yKHJlbW90ZU1hdGNoLCBtYXRjaCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgICFpc0R1cGxpY2F0ZSAmJiBtYXRjaGVzV2l0aEJhY2tmaWxsLnB1c2gocmVtb3RlTWF0Y2gpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXNXaXRoQmFja2ZpbGwubGVuZ3RoIDwgdGhhdC5saW1pdDsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIGNiICYmIGNiKHRoYXQuc29ydGVyKG1hdGNoZXNXaXRoQmFja2ZpbGwpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuaW5kZXgucmVzZXQoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBjbGVhclByZWZldGNoQ2FjaGU6IGZ1bmN0aW9uIGNsZWFyUHJlZmV0Y2hDYWNoZSgpIHsNCiAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2UgJiYgdGhpcy5zdG9yYWdlLmNsZWFyKCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgY2xlYXJSZW1vdGVDYWNoZTogZnVuY3Rpb24gY2xlYXJSZW1vdGVDYWNoZSgpIHsNCiAgICAgICAgICAgICAgICB0aGlzLnRyYW5zcG9ydCAmJiBUcmFuc3BvcnQucmVzZXRDYWNoZSgpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHR0QWRhcHRlcjogZnVuY3Rpb24gdHRBZGFwdGVyKCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBfLmJpbmQodGhpcy5nZXQsIHRoaXMpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIEJsb29kaG91bmQ7DQogICAgICAgIGZ1bmN0aW9uIGdldFNvcnRlcihzb3J0Rm4pIHsNCiAgICAgICAgICAgIHJldHVybiBfLmlzRnVuY3Rpb24oc29ydEZuKSA/IHNvcnQgOiBub1NvcnQ7DQogICAgICAgICAgICBmdW5jdGlvbiBzb3J0KGFycmF5KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5LnNvcnQoc29ydEZuKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGZ1bmN0aW9uIG5vU29ydChhcnJheSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBhcnJheTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiBpZ25vcmVEdXBsaWNhdGVzKCkgew0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQogICAgfSkodGhpcyk7DQogICAgdmFyIGh0bWwgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIHdyYXBwZXI6ICc8c3BhbiBjbGFzcz0idHdpdHRlci10eXBlYWhlYWQiPjwvc3Bhbj4nLA0KICAgICAgICAgICAgZHJvcGRvd246ICc8c3BhbiBjbGFzcz0idHQtZHJvcGRvd24tbWVudSI+PC9zcGFuPicsDQogICAgICAgICAgICBkYXRhc2V0OiAnPGRpdiBjbGFzcz0idHQtZGF0YXNldC0lQ0xBU1MlIj48L2Rpdj4nLA0KICAgICAgICAgICAgc3VnZ2VzdGlvbnM6ICc8c3BhbiBjbGFzcz0idHQtc3VnZ2VzdGlvbnMiPjwvc3Bhbj4nLA0KICAgICAgICAgICAgc3VnZ2VzdGlvbjogJzxkaXYgY2xhc3M9InR0LXN1Z2dlc3Rpb24iPjwvZGl2PicNCiAgICAgICAgfTsNCiAgICB9KCk7DQogICAgdmFyIGNzcyA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAidXNlIHN0cmljdCI7DQogICAgICAgIHZhciBjc3MgPSB7DQogICAgICAgICAgICB3cmFwcGVyOiB7DQogICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsDQogICAgICAgICAgICAgICAgZGlzcGxheTogImlubGluZS1ibG9jayINCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBoaW50OiB7DQogICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsDQogICAgICAgICAgICAgICAgdG9wOiAiMCIsDQogICAgICAgICAgICAgICAgbGVmdDogIjAiLA0KICAgICAgICAgICAgICAgIGJvcmRlckNvbG9yOiAidHJhbnNwYXJlbnQiLA0KICAgICAgICAgICAgICAgIGJveFNoYWRvdzogIm5vbmUiLA0KICAgICAgICAgICAgICAgIG9wYWNpdHk6ICIxIg0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGlucHV0OiB7DQogICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsDQogICAgICAgICAgICAgICAgdmVydGljYWxBbGlnbjogInRvcCIsDQogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaW5wdXRXaXRoTm9IaW50OiB7DQogICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsDQogICAgICAgICAgICAgICAgdmVydGljYWxBbGlnbjogInRvcCINCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBkcm9wZG93bjogew0KICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLA0KICAgICAgICAgICAgICAgIHRvcDogIjEwMCUiLA0KICAgICAgICAgICAgICAgIGxlZnQ6ICIwIiwNCiAgICAgICAgICAgICAgICB6SW5kZXg6ICIxMDAiLA0KICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJub25lIg0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHN1Z2dlc3Rpb25zOiB7DQogICAgICAgICAgICAgICAgZGlzcGxheTogImJsb2NrIg0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHN1Z2dlc3Rpb246IHsNCiAgICAgICAgICAgICAgICB3aGl0ZVNwYWNlOiAibm93cmFwIiwNCiAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIg0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHN1Z2dlc3Rpb25DaGlsZDogew0KICAgICAgICAgICAgICAgIHdoaXRlU3BhY2U6ICJub3JtYWwiDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgbHRyOiB7DQogICAgICAgICAgICAgICAgbGVmdDogIjAiLA0KICAgICAgICAgICAgICAgIHJpZ2h0OiAiYXV0byINCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBydGw6IHsNCiAgICAgICAgICAgICAgICBsZWZ0OiAiYXV0byIsDQogICAgICAgICAgICAgICAgcmlnaHQ6ICIgMCINCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgaWYgKF8uaXNNc2llKCkpIHsNCiAgICAgICAgICAgIF8ubWl4aW4oY3NzLmlucHV0LCB7DQogICAgICAgICAgICAgICAgYmFja2dyb3VuZEltYWdlOiAidXJsKGRhdGE6aW1hZ2UvZ2lmO2Jhc2U2NCxSMGxHT0RsaEFRQUJBSUFBQUFBQUFQLy8veUg1QkFFQUFBQUFMQUFBQUFBQkFBRUFBQUlCUkFBNykiDQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoXy5pc01zaWUoKSAmJiBfLmlzTXNpZSgpIDw9IDcpIHsNCiAgICAgICAgICAgIF8ubWl4aW4oY3NzLmlucHV0LCB7DQogICAgICAgICAgICAgICAgbWFyZ2luVG9wOiAiLTFweCINCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBjc3M7DQogICAgfSgpOw0KICAgIHZhciBFdmVudEJ1cyA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAidXNlIHN0cmljdCI7DQogICAgICAgIHZhciBuYW1lc3BhY2UgPSAidHlwZWFoZWFkOiI7DQogICAgICAgIGZ1bmN0aW9uIEV2ZW50QnVzKG8pIHsNCiAgICAgICAgICAgIGlmICghbyB8fCAhby5lbCkgew0KICAgICAgICAgICAgICAgICQuZXJyb3IoIkV2ZW50QnVzIGluaXRpYWxpemVkIHdpdGhvdXQgZWwiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuJGVsID0gJChvLmVsKTsNCiAgICAgICAgfQ0KICAgICAgICBfLm1peGluKEV2ZW50QnVzLnByb3RvdHlwZSwgew0KICAgICAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24odHlwZSkgew0KICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOw0KICAgICAgICAgICAgICAgIHRoaXMuJGVsLnRyaWdnZXIobmFtZXNwYWNlICsgdHlwZSwgYXJncyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gRXZlbnRCdXM7DQogICAgfSgpOw0KICAgIHZhciBFdmVudEVtaXR0ZXIgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgInVzZSBzdHJpY3QiOw0KICAgICAgICB2YXIgc3BsaXR0ZXIgPSAvXHMrLywgbmV4dFRpY2sgPSBnZXROZXh0VGljaygpOw0KICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgb25TeW5jOiBvblN5bmMsDQogICAgICAgICAgICBvbkFzeW5jOiBvbkFzeW5jLA0KICAgICAgICAgICAgb2ZmOiBvZmYsDQogICAgICAgICAgICB0cmlnZ2VyOiB0cmlnZ2VyDQogICAgICAgIH07DQogICAgICAgIGZ1bmN0aW9uIG9uKG1ldGhvZCwgdHlwZXMsIGNiLCBjb250ZXh0KSB7DQogICAgICAgICAgICB2YXIgdHlwZTsNCiAgICAgICAgICAgIGlmICghY2IpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHR5cGVzID0gdHlwZXMuc3BsaXQoc3BsaXR0ZXIpOw0KICAgICAgICAgICAgY2IgPSBjb250ZXh0ID8gYmluZENvbnRleHQoY2IsIGNvbnRleHQpIDogY2I7DQogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSB0aGlzLl9jYWxsYmFja3MgfHwge307DQogICAgICAgICAgICB3aGlsZSAodHlwZSA9IHR5cGVzLnNoaWZ0KCkpIHsNCiAgICAgICAgICAgICAgICB0aGlzLl9jYWxsYmFja3NbdHlwZV0gPSB0aGlzLl9jYWxsYmFja3NbdHlwZV0gfHwgew0KICAgICAgICAgICAgICAgICAgICBzeW5jOiBbXSwNCiAgICAgICAgICAgICAgICAgICAgYXN5bmM6IFtdDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICB0aGlzLl9jYWxsYmFja3NbdHlwZV1bbWV0aG9kXS5wdXNoKGNiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICAgIGZ1bmN0aW9uIG9uQXN5bmModHlwZXMsIGNiLCBjb250ZXh0KSB7DQogICAgICAgICAgICByZXR1cm4gb24uY2FsbCh0aGlzLCAiYXN5bmMiLCB0eXBlcywgY2IsIGNvbnRleHQpOw0KICAgICAgICB9DQogICAgICAgIGZ1bmN0aW9uIG9uU3luYyh0eXBlcywgY2IsIGNvbnRleHQpIHsNCiAgICAgICAgICAgIHJldHVybiBvbi5jYWxsKHRoaXMsICJzeW5jIiwgdHlwZXMsIGNiLCBjb250ZXh0KTsNCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiBvZmYodHlwZXMpIHsNCiAgICAgICAgICAgIHZhciB0eXBlOw0KICAgICAgICAgICAgaWYgKCF0aGlzLl9jYWxsYmFja3MpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHR5cGVzID0gdHlwZXMuc3BsaXQoc3BsaXR0ZXIpOw0KICAgICAgICAgICAgd2hpbGUgKHR5cGUgPSB0eXBlcy5zaGlmdCgpKSB7DQogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2NhbGxiYWNrc1t0eXBlXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICAgIGZ1bmN0aW9uIHRyaWdnZXIodHlwZXMpIHsNCiAgICAgICAgICAgIHZhciB0eXBlLCBjYWxsYmFja3MsIGFyZ3MsIHN5bmNGbHVzaCwgYXN5bmNGbHVzaDsNCiAgICAgICAgICAgIGlmICghdGhpcy5fY2FsbGJhY2tzKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0eXBlcyA9IHR5cGVzLnNwbGl0KHNwbGl0dGVyKTsNCiAgICAgICAgICAgIGFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7DQogICAgICAgICAgICB3aGlsZSAoKHR5cGUgPSB0eXBlcy5zaGlmdCgpKSAmJiAoY2FsbGJhY2tzID0gdGhpcy5fY2FsbGJhY2tzW3R5cGVdKSkgew0KICAgICAgICAgICAgICAgIHN5bmNGbHVzaCA9IGdldEZsdXNoKGNhbGxiYWNrcy5zeW5jLCB0aGlzLCBbIHR5cGUgXS5jb25jYXQoYXJncykpOw0KICAgICAgICAgICAgICAgIGFzeW5jRmx1c2ggPSBnZXRGbHVzaChjYWxsYmFja3MuYXN5bmMsIHRoaXMsIFsgdHlwZSBdLmNvbmNhdChhcmdzKSk7DQogICAgICAgICAgICAgICAgc3luY0ZsdXNoKCkgJiYgbmV4dFRpY2soYXN5bmNGbHVzaCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiBnZXRGbHVzaChjYWxsYmFja3MsIGNvbnRleHQsIGFyZ3MpIHsNCiAgICAgICAgICAgIHJldHVybiBmbHVzaDsNCiAgICAgICAgICAgIGZ1bmN0aW9uIGZsdXNoKCkgew0KICAgICAgICAgICAgICAgIHZhciBjYW5jZWxsZWQ7DQogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNhbGxiYWNrcy5sZW5ndGg7ICFjYW5jZWxsZWQgJiYgaSA8IGxlbjsgaSArPSAxKSB7DQogICAgICAgICAgICAgICAgICAgIGNhbmNlbGxlZCA9IGNhbGxiYWNrc1tpXS5hcHBseShjb250ZXh0LCBhcmdzKSA9PT0gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiAhY2FuY2VsbGVkOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRUaWNrKCkgew0KICAgICAgICAgICAgdmFyIG5leHRUaWNrRm47DQogICAgICAgICAgICBpZiAod2luZG93LnNldEltbWVkaWF0ZSkgew0KICAgICAgICAgICAgICAgIG5leHRUaWNrRm4gPSBmdW5jdGlvbiBuZXh0VGlja1NldEltbWVkaWF0ZShmbikgew0KICAgICAgICAgICAgICAgICAgICBzZXRJbW1lZGlhdGUoZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBmbigpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBuZXh0VGlja0ZuID0gZnVuY3Rpb24gbmV4dFRpY2tTZXRUaW1lb3V0KGZuKSB7DQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBmbigpOw0KICAgICAgICAgICAgICAgICAgICB9LCAwKTsNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIG5leHRUaWNrRm47DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gYmluZENvbnRleHQoZm4sIGNvbnRleHQpIHsNCiAgICAgICAgICAgIHJldHVybiBmbi5iaW5kID8gZm4uYmluZChjb250ZXh0KSA6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIGZuLmFwcGx5KGNvbnRleHQsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7DQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQogICAgfSgpOw0KICAgIHZhciBoaWdobGlnaHQgPSBmdW5jdGlvbihkb2MpIHsNCiAgICAgICAgInVzZSBzdHJpY3QiOw0KICAgICAgICB2YXIgZGVmYXVsdHMgPSB7DQogICAgICAgICAgICBub2RlOiBudWxsLA0KICAgICAgICAgICAgcGF0dGVybjogbnVsbCwNCiAgICAgICAgICAgIHRhZ05hbWU6ICJzdHJvbmciLA0KICAgICAgICAgICAgY2xhc3NOYW1lOiBudWxsLA0KICAgICAgICAgICAgd29yZHNPbmx5OiBmYWxzZSwNCiAgICAgICAgICAgIGNhc2VTZW5zaXRpdmU6IGZhbHNlDQogICAgICAgIH07DQogICAgICAgIHJldHVybiBmdW5jdGlvbiBoaWdodGxpZ2h0KG8pIHsNCiAgICAgICAgICAgIHZhciByZWdleDsNCiAgICAgICAgICAgIG8gPSBfLm1peGluKHt9LCBkZWZhdWx0cywgbyk7DQogICAgICAgICAgICBpZiAoIW8ubm9kZSB8fCAhby5wYXR0ZXJuKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgby5wYXR0ZXJuID0gXy5pc0FycmF5KG8ucGF0dGVybikgPyBvLnBhdHRlcm4gOiBbIG8ucGF0dGVybiBdOw0KICAgICAgICAgICAgcmVnZXggPSBnZXRSZWdleChvLnBhdHRlcm4sIG8uY2FzZVNlbnNpdGl2ZSwgby53b3Jkc09ubHkpOw0KICAgICAgICAgICAgdHJhdmVyc2Uoby5ub2RlLCBoaWdodGxpZ2h0VGV4dE5vZGUpOw0KICAgICAgICAgICAgZnVuY3Rpb24gaGlnaHRsaWdodFRleHROb2RlKHRleHROb2RlKSB7DQogICAgICAgICAgICAgICAgdmFyIG1hdGNoLCBwYXR0ZXJuTm9kZSwgd3JhcHBlck5vZGU7DQogICAgICAgICAgICAgICAgaWYgKG1hdGNoID0gcmVnZXguZXhlYyh0ZXh0Tm9kZS5kYXRhKSkgew0KICAgICAgICAgICAgICAgICAgICB3cmFwcGVyTm9kZSA9IGRvYy5jcmVhdGVFbGVtZW50KG8udGFnTmFtZSk7DQogICAgICAgICAgICAgICAgICAgIG8uY2xhc3NOYW1lICYmICh3cmFwcGVyTm9kZS5jbGFzc05hbWUgPSBvLmNsYXNzTmFtZSk7DQogICAgICAgICAgICAgICAgICAgIHBhdHRlcm5Ob2RlID0gdGV4dE5vZGUuc3BsaXRUZXh0KG1hdGNoLmluZGV4KTsNCiAgICAgICAgICAgICAgICAgICAgcGF0dGVybk5vZGUuc3BsaXRUZXh0KG1hdGNoWzBdLmxlbmd0aCk7DQogICAgICAgICAgICAgICAgICAgIHdyYXBwZXJOb2RlLmFwcGVuZENoaWxkKHBhdHRlcm5Ob2RlLmNsb25lTm9kZSh0cnVlKSk7DQogICAgICAgICAgICAgICAgICAgIHRleHROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHdyYXBwZXJOb2RlLCBwYXR0ZXJuTm9kZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiAhIW1hdGNoOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZnVuY3Rpb24gdHJhdmVyc2UoZWwsIGhpZ2h0bGlnaHRUZXh0Tm9kZSkgew0KICAgICAgICAgICAgICAgIHZhciBjaGlsZE5vZGUsIFRFWFRfTk9ERV9UWVBFID0gMzsNCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlID0gZWwuY2hpbGROb2Rlc1tpXTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFX1RZUEUpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGkgKz0gaGlnaHRsaWdodFRleHROb2RlKGNoaWxkTm9kZSkgPyAxIDogMDsNCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYXZlcnNlKGNoaWxkTm9kZSwgaGlnaHRsaWdodFRleHROb2RlKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgZnVuY3Rpb24gZ2V0UmVnZXgocGF0dGVybnMsIGNhc2VTZW5zaXRpdmUsIHdvcmRzT25seSkgew0KICAgICAgICAgICAgdmFyIGVzY2FwZWRQYXR0ZXJucyA9IFtdLCByZWdleFN0cjsNCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBwYXR0ZXJucy5sZW5ndGg7IGkgPCBsZW47IGkrKykgew0KICAgICAgICAgICAgICAgIGVzY2FwZWRQYXR0ZXJucy5wdXNoKF8uZXNjYXBlUmVnRXhDaGFycyhwYXR0ZXJuc1tpXSkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmVnZXhTdHIgPSB3b3Jkc09ubHkgPyAiXFxiKCIgKyBlc2NhcGVkUGF0dGVybnMuam9pbigifCIpICsgIilcXGIiIDogIigiICsgZXNjYXBlZFBhdHRlcm5zLmpvaW4oInwiKSArICIpIjsNCiAgICAgICAgICAgIHJldHVybiBjYXNlU2Vuc2l0aXZlID8gbmV3IFJlZ0V4cChyZWdleFN0cikgOiBuZXcgUmVnRXhwKHJlZ2V4U3RyLCAiaSIpOw0KICAgICAgICB9DQogICAgfSh3aW5kb3cuZG9jdW1lbnQpOw0KICAgIHZhciBJbnB1dCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAidXNlIHN0cmljdCI7DQogICAgICAgIHZhciBzcGVjaWFsS2V5Q29kZU1hcDsNCiAgICAgICAgc3BlY2lhbEtleUNvZGVNYXAgPSB7DQogICAgICAgICAgICA5OiAidGFiIiwNCiAgICAgICAgICAgIDI3OiAiZXNjIiwNCiAgICAgICAgICAgIDM3OiAibGVmdCIsDQogICAgICAgICAgICAzOTogInJpZ2h0IiwNCiAgICAgICAgICAgIDEzOiAiZW50ZXIiLA0KICAgICAgICAgICAgMzg6ICJ1cCIsDQogICAgICAgICAgICA0MDogImRvd24iDQogICAgICAgIH07DQogICAgICAgIGZ1bmN0aW9uIElucHV0KG8pIHsNCiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgb25CbHVyLCBvbkZvY3VzLCBvbktleWRvd24sIG9uSW5wdXQ7DQogICAgICAgICAgICBvID0gbyB8fCB7fTsNCiAgICAgICAgICAgIGlmICghby5pbnB1dCkgew0KICAgICAgICAgICAgICAgICQuZXJyb3IoImlucHV0IGlzIG1pc3NpbmciKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIG9uQmx1ciA9IF8uYmluZCh0aGlzLl9vbkJsdXIsIHRoaXMpOw0KICAgICAgICAgICAgb25Gb2N1cyA9IF8uYmluZCh0aGlzLl9vbkZvY3VzLCB0aGlzKTsNCiAgICAgICAgICAgIG9uS2V5ZG93biA9IF8uYmluZCh0aGlzLl9vbktleWRvd24sIHRoaXMpOw0KICAgICAgICAgICAgb25JbnB1dCA9IF8uYmluZCh0aGlzLl9vbklucHV0LCB0aGlzKTsNCiAgICAgICAgICAgIHRoaXMuJGhpbnQgPSAkKG8uaGludCk7DQogICAgICAgICAgICB0aGlzLiRpbnB1dCA9ICQoby5pbnB1dCkub24oImJsdXIudHQiLCBvbkJsdXIpLm9uKCJmb2N1cy50dCIsIG9uRm9jdXMpLm9uKCJrZXlkb3duLnR0Iiwgb25LZXlkb3duKTsNCiAgICAgICAgICAgIGlmICh0aGlzLiRoaW50Lmxlbmd0aCA9PT0gMCkgew0KICAgICAgICAgICAgICAgIHRoaXMuc2V0SGludCA9IHRoaXMuZ2V0SGludCA9IHRoaXMuY2xlYXJIaW50ID0gdGhpcy5jbGVhckhpbnRJZkludmFsaWQgPSBfLm5vb3A7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIV8uaXNNc2llKCkpIHsNCiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC5vbigiaW5wdXQudHQiLCBvbklucHV0KTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgdGhpcy4kaW5wdXQub24oImtleWRvd24udHQga2V5cHJlc3MudHQgY3V0LnR0IHBhc3RlLnR0IiwgZnVuY3Rpb24oJGUpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWNpYWxLZXlDb2RlTWFwWyRlLndoaWNoIHx8ICRlLmtleUNvZGVdKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgXy5kZWZlcihfLmJpbmQodGhhdC5fb25JbnB1dCwgdGhhdCwgJGUpKTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMucXVlcnkgPSB0aGlzLiRpbnB1dC52YWwoKTsNCiAgICAgICAgICAgIHRoaXMuJG92ZXJmbG93SGVscGVyID0gYnVpbGRPdmVyZmxvd0hlbHBlcih0aGlzLiRpbnB1dCk7DQogICAgICAgIH0NCiAgICAgICAgSW5wdXQubm9ybWFsaXplUXVlcnkgPSBmdW5jdGlvbihzdHIpIHsNCiAgICAgICAgICAgIHJldHVybiAoc3RyIHx8ICIiKS5yZXBsYWNlKC9eXHMqL2csICIiKS5yZXBsYWNlKC9cc3syLH0vZywgIiAiKTsNCiAgICAgICAgfTsNCiAgICAgICAgXy5taXhpbihJbnB1dC5wcm90b3R5cGUsIEV2ZW50RW1pdHRlciwgew0KICAgICAgICAgICAgX29uQmx1cjogZnVuY3Rpb24gb25CbHVyKCkgew0KICAgICAgICAgICAgICAgIHRoaXMucmVzZXRJbnB1dFZhbHVlKCk7DQogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJibHVycmVkIik7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX29uRm9jdXM6IGZ1bmN0aW9uIG9uRm9jdXMoKSB7DQogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJmb2N1c2VkIik7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX29uS2V5ZG93bjogZnVuY3Rpb24gb25LZXlkb3duKCRlKSB7DQogICAgICAgICAgICAgICAgdmFyIGtleU5hbWUgPSBzcGVjaWFsS2V5Q29kZU1hcFskZS53aGljaCB8fCAkZS5rZXlDb2RlXTsNCiAgICAgICAgICAgICAgICB0aGlzLl9tYW5hZ2VQcmV2ZW50RGVmYXVsdChrZXlOYW1lLCAkZSk7DQogICAgICAgICAgICAgICAgaWYgKGtleU5hbWUgJiYgdGhpcy5fc2hvdWxkVHJpZ2dlcihrZXlOYW1lLCAkZSkpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKGtleU5hbWUgKyAiS2V5ZWQiLCAkZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9vbklucHV0OiBmdW5jdGlvbiBvbklucHV0KCkgew0KICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrSW5wdXRWYWx1ZSgpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9tYW5hZ2VQcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gbWFuYWdlUHJldmVudERlZmF1bHQoa2V5TmFtZSwgJGUpIHsNCiAgICAgICAgICAgICAgICB2YXIgcHJldmVudERlZmF1bHQsIGhpbnRWYWx1ZSwgaW5wdXRWYWx1ZTsNCiAgICAgICAgICAgICAgICBzd2l0Y2ggKGtleU5hbWUpIHsNCiAgICAgICAgICAgICAgICAgIGNhc2UgInRhYiI6DQogICAgICAgICAgICAgICAgICAgIGhpbnRWYWx1ZSA9IHRoaXMuZ2V0SGludCgpOw0KICAgICAgICAgICAgICAgICAgICBpbnB1dFZhbHVlID0gdGhpcy5nZXRJbnB1dFZhbHVlKCk7DQogICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0ID0gaGludFZhbHVlICYmIGhpbnRWYWx1ZSAhPT0gaW5wdXRWYWx1ZSAmJiAhd2l0aE1vZGlmaWVyKCRlKTsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICAgIGNhc2UgInVwIjoNCiAgICAgICAgICAgICAgICAgIGNhc2UgImRvd24iOg0KICAgICAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdCA9ICF3aXRoTW9kaWZpZXIoJGUpOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQgJiYgJGUucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfc2hvdWxkVHJpZ2dlcjogZnVuY3Rpb24gc2hvdWxkVHJpZ2dlcihrZXlOYW1lLCAkZSkgew0KICAgICAgICAgICAgICAgIHZhciB0cmlnZ2VyOw0KICAgICAgICAgICAgICAgIHN3aXRjaCAoa2V5TmFtZSkgew0KICAgICAgICAgICAgICAgICAgY2FzZSAidGFiIjoNCiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlciA9ICF3aXRoTW9kaWZpZXIoJGUpOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlciA9IHRydWU7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiB0cmlnZ2VyOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9jaGVja0lucHV0VmFsdWU6IGZ1bmN0aW9uIGNoZWNrSW5wdXRWYWx1ZSgpIHsNCiAgICAgICAgICAgICAgICB2YXIgaW5wdXRWYWx1ZSwgYXJlRXF1aXZhbGVudCwgaGFzRGlmZmVyZW50V2hpdGVzcGFjZTsNCiAgICAgICAgICAgICAgICBpbnB1dFZhbHVlID0gdGhpcy5nZXRJbnB1dFZhbHVlKCk7DQogICAgICAgICAgICAgICAgYXJlRXF1aXZhbGVudCA9IGFyZVF1ZXJpZXNFcXVpdmFsZW50KGlucHV0VmFsdWUsIHRoaXMucXVlcnkpOw0KICAgICAgICAgICAgICAgIGhhc0RpZmZlcmVudFdoaXRlc3BhY2UgPSBhcmVFcXVpdmFsZW50ID8gdGhpcy5xdWVyeS5sZW5ndGggIT09IGlucHV0VmFsdWUubGVuZ3RoIDogZmFsc2U7DQogICAgICAgICAgICAgICAgdGhpcy5xdWVyeSA9IGlucHV0VmFsdWU7DQogICAgICAgICAgICAgICAgaWYgKCFhcmVFcXVpdmFsZW50KSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigicXVlcnlDaGFuZ2VkIiwgdGhpcy5xdWVyeSk7DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNEaWZmZXJlbnRXaGl0ZXNwYWNlKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigid2hpdGVzcGFjZUNoYW5nZWQiLCB0aGlzLnF1ZXJ5KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZm9jdXM6IGZ1bmN0aW9uIGZvY3VzKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuJGlucHV0LmZvY3VzKCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgYmx1cjogZnVuY3Rpb24gYmx1cigpIHsNCiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC5ibHVyKCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZ2V0UXVlcnk6IGZ1bmN0aW9uIGdldFF1ZXJ5KCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnF1ZXJ5Ow0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHNldFF1ZXJ5OiBmdW5jdGlvbiBzZXRRdWVyeShxdWVyeSkgew0KICAgICAgICAgICAgICAgIHRoaXMucXVlcnkgPSBxdWVyeTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBnZXRJbnB1dFZhbHVlOiBmdW5jdGlvbiBnZXRJbnB1dFZhbHVlKCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRpbnB1dC52YWwoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBzZXRJbnB1dFZhbHVlOiBmdW5jdGlvbiBzZXRJbnB1dFZhbHVlKHZhbHVlLCBzaWxlbnQpIHsNCiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC52YWwodmFsdWUpOw0KICAgICAgICAgICAgICAgIHNpbGVudCA/IHRoaXMuY2xlYXJIaW50KCkgOiB0aGlzLl9jaGVja0lucHV0VmFsdWUoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICByZXNldElucHV0VmFsdWU6IGZ1bmN0aW9uIHJlc2V0SW5wdXRWYWx1ZSgpIHsNCiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0VmFsdWUodGhpcy5xdWVyeSwgdHJ1ZSk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZ2V0SGludDogZnVuY3Rpb24gZ2V0SGludCgpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kaGludC52YWwoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBzZXRIaW50OiBmdW5jdGlvbiBzZXRIaW50KHZhbHVlKSB7DQogICAgICAgICAgICAgICAgdGhpcy4kaGludC52YWwodmFsdWUpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGNsZWFySGludDogZnVuY3Rpb24gY2xlYXJIaW50KCkgew0KICAgICAgICAgICAgICAgIHRoaXMuc2V0SGludCgiIik7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgY2xlYXJIaW50SWZJbnZhbGlkOiBmdW5jdGlvbiBjbGVhckhpbnRJZkludmFsaWQoKSB7DQogICAgICAgICAgICAgICAgdmFyIHZhbCwgaGludCwgdmFsSXNQcmVmaXhPZkhpbnQsIGlzVmFsaWQ7DQogICAgICAgICAgICAgICAgdmFsID0gdGhpcy5nZXRJbnB1dFZhbHVlKCk7DQogICAgICAgICAgICAgICAgaGludCA9IHRoaXMuZ2V0SGludCgpOw0KICAgICAgICAgICAgICAgIHZhbElzUHJlZml4T2ZIaW50ID0gdmFsICE9PSBoaW50ICYmIGhpbnQuaW5kZXhPZih2YWwpID09PSAwOw0KICAgICAgICAgICAgICAgIGlzVmFsaWQgPSB2YWwgIT09ICIiICYmIHZhbElzUHJlZml4T2ZIaW50ICYmICF0aGlzLmhhc092ZXJmbG93KCk7DQogICAgICAgICAgICAgICAgIWlzVmFsaWQgJiYgdGhpcy5jbGVhckhpbnQoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBnZXRMYW5ndWFnZURpcmVjdGlvbjogZnVuY3Rpb24gZ2V0TGFuZ3VhZ2VEaXJlY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLiRpbnB1dC5jc3MoImRpcmVjdGlvbiIpIHx8ICJsdHIiKS50b0xvd2VyQ2FzZSgpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGhhc092ZXJmbG93OiBmdW5jdGlvbiBoYXNPdmVyZmxvdygpIHsNCiAgICAgICAgICAgICAgICB2YXIgY29uc3RyYWludCA9IHRoaXMuJGlucHV0LndpZHRoKCkgLSAyOw0KICAgICAgICAgICAgICAgIHRoaXMuJG92ZXJmbG93SGVscGVyLnRleHQodGhpcy5nZXRJbnB1dFZhbHVlKCkpOw0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRvdmVyZmxvd0hlbHBlci53aWR0aCgpID49IGNvbnN0cmFpbnQ7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaXNDdXJzb3JBdEVuZDogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgdmFyIHZhbHVlTGVuZ3RoLCBzZWxlY3Rpb25TdGFydCwgcmFuZ2U7DQogICAgICAgICAgICAgICAgdmFsdWVMZW5ndGggPSB0aGlzLiRpbnB1dC52YWwoKS5sZW5ndGg7DQogICAgICAgICAgICAgICAgc2VsZWN0aW9uU3RhcnQgPSB0aGlzLiRpbnB1dFswXS5zZWxlY3Rpb25TdGFydDsNCiAgICAgICAgICAgICAgICBpZiAoXy5pc051bWJlcihzZWxlY3Rpb25TdGFydCkpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGVjdGlvblN0YXJ0ID09PSB2YWx1ZUxlbmd0aDsNCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LnNlbGVjdGlvbikgew0KICAgICAgICAgICAgICAgICAgICByYW5nZSA9IGRvY3VtZW50LnNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpOw0KICAgICAgICAgICAgICAgICAgICByYW5nZS5tb3ZlU3RhcnQoImNoYXJhY3RlciIsIC12YWx1ZUxlbmd0aCk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZUxlbmd0aCA9PT0gcmFuZ2UudGV4dC5sZW5ndGg7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7DQogICAgICAgICAgICAgICAgdGhpcy4kaGludC5vZmYoIi50dCIpOw0KICAgICAgICAgICAgICAgIHRoaXMuJGlucHV0Lm9mZigiLnR0Iik7DQogICAgICAgICAgICAgICAgdGhpcy4kaGludCA9IHRoaXMuJGlucHV0ID0gdGhpcy4kb3ZlcmZsb3dIZWxwZXIgPSBudWxsOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIElucHV0Ow0KICAgICAgICBmdW5jdGlvbiBidWlsZE92ZXJmbG93SGVscGVyKCRpbnB1dCkgew0KICAgICAgICAgICAgcmV0dXJuICQoJzxwcmUgYXJpYS1oaWRkZW49InRydWUiPjwvcHJlPicpLmNzcyh7DQogICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsDQogICAgICAgICAgICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIsDQogICAgICAgICAgICAgICAgd2hpdGVTcGFjZTogInByZSIsDQogICAgICAgICAgICAgICAgZm9udEZhbWlseTogJGlucHV0LmNzcygiZm9udC1mYW1pbHkiKSwNCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJGlucHV0LmNzcygiZm9udC1zaXplIiksDQogICAgICAgICAgICAgICAgZm9udFN0eWxlOiAkaW5wdXQuY3NzKCJmb250LXN0eWxlIiksDQogICAgICAgICAgICAgICAgZm9udFZhcmlhbnQ6ICRpbnB1dC5jc3MoImZvbnQtdmFyaWFudCIpLA0KICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6ICRpbnB1dC5jc3MoImZvbnQtd2VpZ2h0IiksDQogICAgICAgICAgICAgICAgd29yZFNwYWNpbmc6ICRpbnB1dC5jc3MoIndvcmQtc3BhY2luZyIpLA0KICAgICAgICAgICAgICAgIGxldHRlclNwYWNpbmc6ICRpbnB1dC5jc3MoImxldHRlci1zcGFjaW5nIiksDQogICAgICAgICAgICAgICAgdGV4dEluZGVudDogJGlucHV0LmNzcygidGV4dC1pbmRlbnQiKSwNCiAgICAgICAgICAgICAgICB0ZXh0UmVuZGVyaW5nOiAkaW5wdXQuY3NzKCJ0ZXh0LXJlbmRlcmluZyIpLA0KICAgICAgICAgICAgICAgIHRleHRUcmFuc2Zvcm06ICRpbnB1dC5jc3MoInRleHQtdHJhbnNmb3JtIikNCiAgICAgICAgICAgIH0pLmluc2VydEFmdGVyKCRpbnB1dCk7DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gYXJlUXVlcmllc0VxdWl2YWxlbnQoYSwgYikgew0KICAgICAgICAgICAgcmV0dXJuIElucHV0Lm5vcm1hbGl6ZVF1ZXJ5KGEpID09PSBJbnB1dC5ub3JtYWxpemVRdWVyeShiKTsNCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiB3aXRoTW9kaWZpZXIoJGUpIHsNCiAgICAgICAgICAgIHJldHVybiAkZS5hbHRLZXkgfHwgJGUuY3RybEtleSB8fCAkZS5tZXRhS2V5IHx8ICRlLnNoaWZ0S2V5Ow0KICAgICAgICB9DQogICAgfSgpOw0KICAgIHZhciBEYXRhc2V0ID0gZnVuY3Rpb24oKSB7DQogICAgICAgICJ1c2Ugc3RyaWN0IjsNCiAgICAgICAgdmFyIGRhdGFzZXRLZXkgPSAidHREYXRhc2V0IiwgdmFsdWVLZXkgPSAidHRWYWx1ZSIsIGRhdHVtS2V5ID0gInR0RGF0dW0iOw0KICAgICAgICBmdW5jdGlvbiBEYXRhc2V0KG8pIHsNCiAgICAgICAgICAgIG8gPSBvIHx8IHt9Ow0KICAgICAgICAgICAgby50ZW1wbGF0ZXMgPSBvLnRlbXBsYXRlcyB8fCB7fTsNCiAgICAgICAgICAgIGlmICghby5zb3VyY2UpIHsNCiAgICAgICAgICAgICAgICAkLmVycm9yKCJtaXNzaW5nIHNvdXJjZSIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKG8ubmFtZSAmJiAhaXNWYWxpZE5hbWUoby5uYW1lKSkgew0KICAgICAgICAgICAgICAgICQuZXJyb3IoImludmFsaWQgZGF0YXNldCBuYW1lOiAiICsgby5uYW1lKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMucXVlcnkgPSBudWxsOw0KICAgICAgICAgICAgdGhpcy5oaWdobGlnaHQgPSAhIW8uaGlnaGxpZ2h0Ow0KICAgICAgICAgICAgdGhpcy5uYW1lID0gby5uYW1lIHx8IF8uZ2V0VW5pcXVlSWQoKTsNCiAgICAgICAgICAgIHRoaXMuc291cmNlID0gby5zb3VyY2U7DQogICAgICAgICAgICB0aGlzLmRpc3BsYXlGbiA9IGdldERpc3BsYXlGbihvLmRpc3BsYXkgfHwgby5kaXNwbGF5S2V5KTsNCiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVzID0gZ2V0VGVtcGxhdGVzKG8udGVtcGxhdGVzLCB0aGlzLmRpc3BsYXlGbik7DQogICAgICAgICAgICB0aGlzLiRlbCA9ICQoaHRtbC5kYXRhc2V0LnJlcGxhY2UoIiVDTEFTUyUiLCB0aGlzLm5hbWUpKTsNCiAgICAgICAgfQ0KICAgICAgICBEYXRhc2V0LmV4dHJhY3REYXRhc2V0TmFtZSA9IGZ1bmN0aW9uIGV4dHJhY3REYXRhc2V0TmFtZShlbCkgew0KICAgICAgICAgICAgcmV0dXJuICQoZWwpLmRhdGEoZGF0YXNldEtleSk7DQogICAgICAgIH07DQogICAgICAgIERhdGFzZXQuZXh0cmFjdFZhbHVlID0gZnVuY3Rpb24gZXh0cmFjdERhdHVtKGVsKSB7DQogICAgICAgICAgICByZXR1cm4gJChlbCkuZGF0YSh2YWx1ZUtleSk7DQogICAgICAgIH07DQogICAgICAgIERhdGFzZXQuZXh0cmFjdERhdHVtID0gZnVuY3Rpb24gZXh0cmFjdERhdHVtKGVsKSB7DQogICAgICAgICAgICByZXR1cm4gJChlbCkuZGF0YShkYXR1bUtleSk7DQogICAgICAgIH07DQogICAgICAgIF8ubWl4aW4oRGF0YXNldC5wcm90b3R5cGUsIEV2ZW50RW1pdHRlciwgew0KICAgICAgICAgICAgX3JlbmRlcjogZnVuY3Rpb24gcmVuZGVyKHF1ZXJ5LCBzdWdnZXN0aW9ucykgew0KICAgICAgICAgICAgICAgIGlmICghdGhpcy4kZWwpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGhhc1N1Z2dlc3Rpb25zOw0KICAgICAgICAgICAgICAgIHRoaXMuJGVsLmVtcHR5KCk7DQogICAgICAgICAgICAgICAgaGFzU3VnZ2VzdGlvbnMgPSBzdWdnZXN0aW9ucyAmJiBzdWdnZXN0aW9ucy5sZW5ndGg7DQogICAgICAgICAgICAgICAgaWYgKCFoYXNTdWdnZXN0aW9ucyAmJiB0aGlzLnRlbXBsYXRlcy5lbXB0eSkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKGdldEVtcHR5SHRtbCgpKS5wcmVwZW5kKHRoYXQudGVtcGxhdGVzLmhlYWRlciA/IGdldEhlYWRlckh0bWwoKSA6IG51bGwpLmFwcGVuZCh0aGF0LnRlbXBsYXRlcy5mb290ZXIgPyBnZXRGb290ZXJIdG1sKCkgOiBudWxsKTsNCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhc1N1Z2dlc3Rpb25zKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmh0bWwoZ2V0U3VnZ2VzdGlvbnNIdG1sKCkpLnByZXBlbmQodGhhdC50ZW1wbGF0ZXMuaGVhZGVyID8gZ2V0SGVhZGVySHRtbCgpIDogbnVsbCkuYXBwZW5kKHRoYXQudGVtcGxhdGVzLmZvb3RlciA/IGdldEZvb3Rlckh0bWwoKSA6IG51bGwpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoInJlbmRlcmVkIik7DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0RW1wdHlIdG1sKCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZXMuZW1wdHkoew0KICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnk6IHF1ZXJ5LA0KICAgICAgICAgICAgICAgICAgICAgICAgaXNFbXB0eTogdHJ1ZQ0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0U3VnZ2VzdGlvbnNIdG1sKCkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgJHN1Z2dlc3Rpb25zLCBub2RlczsNCiAgICAgICAgICAgICAgICAgICAgJHN1Z2dlc3Rpb25zID0gJChodG1sLnN1Z2dlc3Rpb25zKS5jc3MoY3NzLnN1Z2dlc3Rpb25zKTsNCiAgICAgICAgICAgICAgICAgICAgbm9kZXMgPSBfLm1hcChzdWdnZXN0aW9ucywgZ2V0U3VnZ2VzdGlvbk5vZGUpOw0KICAgICAgICAgICAgICAgICAgICAkc3VnZ2VzdGlvbnMuYXBwZW5kLmFwcGx5KCRzdWdnZXN0aW9ucywgbm9kZXMpOw0KICAgICAgICAgICAgICAgICAgICB0aGF0LmhpZ2hsaWdodCAmJiBoaWdobGlnaHQoew0KICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAidHQtaGlnaGxpZ2h0IiwNCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6ICRzdWdnZXN0aW9uc1swXSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHBhdHRlcm46IHF1ZXJ5DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN1Z2dlc3Rpb25zOw0KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRTdWdnZXN0aW9uTm9kZShzdWdnZXN0aW9uKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgJGVsOw0KICAgICAgICAgICAgICAgICAgICAgICAgJGVsID0gJChodG1sLnN1Z2dlc3Rpb24pLmFwcGVuZCh0aGF0LnRlbXBsYXRlcy5zdWdnZXN0aW9uKHN1Z2dlc3Rpb24pKS5kYXRhKGRhdGFzZXRLZXksIHRoYXQubmFtZSkuZGF0YSh2YWx1ZUtleSwgdGhhdC5kaXNwbGF5Rm4oc3VnZ2VzdGlvbikpLmRhdGEoZGF0dW1LZXksIHN1Z2dlc3Rpb24pOw0KICAgICAgICAgICAgICAgICAgICAgICAgJGVsLmNoaWxkcmVuKCkuZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmNzcyhjc3Muc3VnZ2VzdGlvbkNoaWxkKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRlbDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRIZWFkZXJIdG1sKCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZXMuaGVhZGVyKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGlzRW1wdHk6ICFoYXNTdWdnZXN0aW9ucw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Rm9vdGVySHRtbCgpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGVzLmZvb3Rlcih7DQogICAgICAgICAgICAgICAgICAgICAgICBxdWVyeTogcXVlcnksDQogICAgICAgICAgICAgICAgICAgICAgICBpc0VtcHR5OiAhaGFzU3VnZ2VzdGlvbnMNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGdldFJvb3Q6IGZ1bmN0aW9uIGdldFJvb3QoKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGVsOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKHF1ZXJ5KSB7DQogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOw0KICAgICAgICAgICAgICAgIHRoaXMucXVlcnkgPSBxdWVyeTsNCiAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbGVkID0gZmFsc2U7DQogICAgICAgICAgICAgICAgdGhpcy5zb3VyY2UocXVlcnksIHJlbmRlcik7DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVuZGVyKHN1Z2dlc3Rpb25zKSB7DQogICAgICAgICAgICAgICAgICAgIGlmICghdGhhdC5jYW5jZWxlZCAmJiBxdWVyeSA9PT0gdGhhdC5xdWVyeSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5fcmVuZGVyKHF1ZXJ5LCBzdWdnZXN0aW9ucyk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgY2FuY2VsOiBmdW5jdGlvbiBjYW5jZWwoKSB7DQogICAgICAgICAgICAgICAgdGhpcy5jYW5jZWxlZCA9IHRydWU7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsKCk7DQogICAgICAgICAgICAgICAgdGhpcy4kZWwuZW1wdHkoKTsNCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoInJlbmRlcmVkIik7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaXNFbXB0eTogZnVuY3Rpb24gaXNFbXB0eSgpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kZWwuaXMoIjplbXB0eSIpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7DQogICAgICAgICAgICAgICAgdGhpcy4kZWwgPSBudWxsOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIERhdGFzZXQ7DQogICAgICAgIGZ1bmN0aW9uIGdldERpc3BsYXlGbihkaXNwbGF5KSB7DQogICAgICAgICAgICBkaXNwbGF5ID0gZGlzcGxheSB8fCAidmFsdWUiOw0KICAgICAgICAgICAgcmV0dXJuIF8uaXNGdW5jdGlvbihkaXNwbGF5KSA/IGRpc3BsYXkgOiBkaXNwbGF5Rm47DQogICAgICAgICAgICBmdW5jdGlvbiBkaXNwbGF5Rm4ob2JqKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIG9ialtkaXNwbGF5XTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiBnZXRUZW1wbGF0ZXModGVtcGxhdGVzLCBkaXNwbGF5Rm4pIHsNCiAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgZW1wdHk6IHRlbXBsYXRlcy5lbXB0eSAmJiBfLnRlbXBsYXRpZnkodGVtcGxhdGVzLmVtcHR5KSwNCiAgICAgICAgICAgICAgICBoZWFkZXI6IHRlbXBsYXRlcy5oZWFkZXIgJiYgXy50ZW1wbGF0aWZ5KHRlbXBsYXRlcy5oZWFkZXIpLA0KICAgICAgICAgICAgICAgIGZvb3RlcjogdGVtcGxhdGVzLmZvb3RlciAmJiBfLnRlbXBsYXRpZnkodGVtcGxhdGVzLmZvb3RlciksDQogICAgICAgICAgICAgICAgc3VnZ2VzdGlvbjogdGVtcGxhdGVzLnN1Z2dlc3Rpb24gfHwgc3VnZ2VzdGlvblRlbXBsYXRlDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgZnVuY3Rpb24gc3VnZ2VzdGlvblRlbXBsYXRlKGNvbnRleHQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gIjxwPiIgKyBkaXNwbGF5Rm4oY29udGV4dCkgKyAiPC9wPiI7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZE5hbWUoc3RyKSB7DQogICAgICAgICAgICByZXR1cm4gL15bX2EtekEtWjAtOS1dKyQvLnRlc3Qoc3RyKTsNCiAgICAgICAgfQ0KICAgIH0oKTsNCiAgICB2YXIgRHJvcGRvd24gPSBmdW5jdGlvbigpIHsNCiAgICAgICAgInVzZSBzdHJpY3QiOw0KICAgICAgICBmdW5jdGlvbiBEcm9wZG93bihvKSB7DQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG9uU3VnZ2VzdGlvbkNsaWNrLCBvblN1Z2dlc3Rpb25Nb3VzZUVudGVyLCBvblN1Z2dlc3Rpb25Nb3VzZUxlYXZlOw0KICAgICAgICAgICAgbyA9IG8gfHwge307DQogICAgICAgICAgICBpZiAoIW8ubWVudSkgew0KICAgICAgICAgICAgICAgICQuZXJyb3IoIm1lbnUgaXMgcmVxdWlyZWQiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7DQogICAgICAgICAgICB0aGlzLmlzRW1wdHkgPSB0cnVlOw0KICAgICAgICAgICAgdGhpcy5kYXRhc2V0cyA9IF8ubWFwKG8uZGF0YXNldHMsIGluaXRpYWxpemVEYXRhc2V0KTsNCiAgICAgICAgICAgIG9uU3VnZ2VzdGlvbkNsaWNrID0gXy5iaW5kKHRoaXMuX29uU3VnZ2VzdGlvbkNsaWNrLCB0aGlzKTsNCiAgICAgICAgICAgIG9uU3VnZ2VzdGlvbk1vdXNlRW50ZXIgPSBfLmJpbmQodGhpcy5fb25TdWdnZXN0aW9uTW91c2VFbnRlciwgdGhpcyk7DQogICAgICAgICAgICBvblN1Z2dlc3Rpb25Nb3VzZUxlYXZlID0gXy5iaW5kKHRoaXMuX29uU3VnZ2VzdGlvbk1vdXNlTGVhdmUsIHRoaXMpOw0KICAgICAgICAgICAgdGhpcy4kbWVudSA9ICQoby5tZW51KS5vbigiY2xpY2sudHQiLCAiLnR0LXN1Z2dlc3Rpb24iLCBvblN1Z2dlc3Rpb25DbGljaykub24oIm1vdXNlZW50ZXIudHQiLCAiLnR0LXN1Z2dlc3Rpb24iLCBvblN1Z2dlc3Rpb25Nb3VzZUVudGVyKS5vbigibW91c2VsZWF2ZS50dCIsICIudHQtc3VnZ2VzdGlvbiIsIG9uU3VnZ2VzdGlvbk1vdXNlTGVhdmUpOw0KICAgICAgICAgICAgXy5lYWNoKHRoaXMuZGF0YXNldHMsIGZ1bmN0aW9uKGRhdGFzZXQpIHsNCiAgICAgICAgICAgICAgICB0aGF0LiRtZW51LmFwcGVuZChkYXRhc2V0LmdldFJvb3QoKSk7DQogICAgICAgICAgICAgICAgZGF0YXNldC5vblN5bmMoInJlbmRlcmVkIiwgdGhhdC5fb25SZW5kZXJlZCwgdGhhdCk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICBfLm1peGluKERyb3Bkb3duLnByb3RvdHlwZSwgRXZlbnRFbWl0dGVyLCB7DQogICAgICAgICAgICBfb25TdWdnZXN0aW9uQ2xpY2s6IGZ1bmN0aW9uIG9uU3VnZ2VzdGlvbkNsaWNrKCRlKSB7DQogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJzdWdnZXN0aW9uQ2xpY2tlZCIsICQoJGUuY3VycmVudFRhcmdldCkpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9vblN1Z2dlc3Rpb25Nb3VzZUVudGVyOiBmdW5jdGlvbiBvblN1Z2dlc3Rpb25Nb3VzZUVudGVyKCRlKSB7DQogICAgICAgICAgICAgICAgdGhpcy5fcmVtb3ZlQ3Vyc29yKCk7DQogICAgICAgICAgICAgICAgdGhpcy5fc2V0Q3Vyc29yKCQoJGUuY3VycmVudFRhcmdldCksIHRydWUpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9vblN1Z2dlc3Rpb25Nb3VzZUxlYXZlOiBmdW5jdGlvbiBvblN1Z2dlc3Rpb25Nb3VzZUxlYXZlKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUN1cnNvcigpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9vblJlbmRlcmVkOiBmdW5jdGlvbiBvblJlbmRlcmVkKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuaXNFbXB0eSA9IF8uZXZlcnkodGhpcy5kYXRhc2V0cywgaXNEYXRhc2V0RW1wdHkpOw0KICAgICAgICAgICAgICAgIHRoaXMuaXNFbXB0eSA/IHRoaXMuX2hpZGUoKSA6IHRoaXMuaXNPcGVuICYmIHRoaXMuX3Nob3coKTsNCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoImRhdGFzZXRSZW5kZXJlZCIpOw0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGlzRGF0YXNldEVtcHR5KGRhdGFzZXQpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFzZXQuaXNFbXB0eSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfaGlkZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgdGhpcy4kbWVudS5oaWRlKCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX3Nob3c6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuJG1lbnUuY3NzKCJkaXNwbGF5IiwgImJsb2NrIik7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX2dldFN1Z2dlc3Rpb25zOiBmdW5jdGlvbiBnZXRTdWdnZXN0aW9ucygpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kbWVudS5maW5kKCIudHQtc3VnZ2VzdGlvbiIpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9nZXRDdXJzb3I6IGZ1bmN0aW9uIGdldEN1cnNvcigpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kbWVudS5maW5kKCIudHQtY3Vyc29yIikuZmlyc3QoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfc2V0Q3Vyc29yOiBmdW5jdGlvbiBzZXRDdXJzb3IoJGVsLCBzaWxlbnQpIHsNCiAgICAgICAgICAgICAgICAkZWwuZmlyc3QoKS5hZGRDbGFzcygidHQtY3Vyc29yIik7DQogICAgICAgICAgICAgICAgIXNpbGVudCAmJiB0aGlzLnRyaWdnZXIoImN1cnNvck1vdmVkIik7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX3JlbW92ZUN1cnNvcjogZnVuY3Rpb24gcmVtb3ZlQ3Vyc29yKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuX2dldEN1cnNvcigpLnJlbW92ZUNsYXNzKCJ0dC1jdXJzb3IiKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfbW92ZUN1cnNvcjogZnVuY3Rpb24gbW92ZUN1cnNvcihpbmNyZW1lbnQpIHsNCiAgICAgICAgICAgICAgICB2YXIgJHN1Z2dlc3Rpb25zLCAkb2xkQ3Vyc29yLCBuZXdDdXJzb3JJbmRleCwgJG5ld0N1cnNvcjsNCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNPcGVuKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgJG9sZEN1cnNvciA9IHRoaXMuX2dldEN1cnNvcigpOw0KICAgICAgICAgICAgICAgICRzdWdnZXN0aW9ucyA9IHRoaXMuX2dldFN1Z2dlc3Rpb25zKCk7DQogICAgICAgICAgICAgICAgdGhpcy5fcmVtb3ZlQ3Vyc29yKCk7DQogICAgICAgICAgICAgICAgbmV3Q3Vyc29ySW5kZXggPSAkc3VnZ2VzdGlvbnMuaW5kZXgoJG9sZEN1cnNvcikgKyBpbmNyZW1lbnQ7DQogICAgICAgICAgICAgICAgbmV3Q3Vyc29ySW5kZXggPSAobmV3Q3Vyc29ySW5kZXggKyAxKSAlICgkc3VnZ2VzdGlvbnMubGVuZ3RoICsgMSkgLSAxOw0KICAgICAgICAgICAgICAgIGlmIChuZXdDdXJzb3JJbmRleCA9PT0gLTEpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJjdXJzb3JSZW1vdmVkIik7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5ld0N1cnNvckluZGV4IDwgLTEpIHsNCiAgICAgICAgICAgICAgICAgICAgbmV3Q3Vyc29ySW5kZXggPSAkc3VnZ2VzdGlvbnMubGVuZ3RoIC0gMTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdGhpcy5fc2V0Q3Vyc29yKCRuZXdDdXJzb3IgPSAkc3VnZ2VzdGlvbnMuZXEobmV3Q3Vyc29ySW5kZXgpKTsNCiAgICAgICAgICAgICAgICB0aGlzLl9lbnN1cmVWaXNpYmxlKCRuZXdDdXJzb3IpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9lbnN1cmVWaXNpYmxlOiBmdW5jdGlvbiBlbnN1cmVWaXNpYmxlKCRlbCkgew0KICAgICAgICAgICAgICAgIHZhciBlbFRvcCwgZWxCb3R0b20sIG1lbnVTY3JvbGxUb3AsIG1lbnVIZWlnaHQ7DQogICAgICAgICAgICAgICAgZWxUb3AgPSAkZWwucG9zaXRpb24oKS50b3A7DQogICAgICAgICAgICAgICAgZWxCb3R0b20gPSBlbFRvcCArICRlbC5vdXRlckhlaWdodCh0cnVlKTsNCiAgICAgICAgICAgICAgICBtZW51U2Nyb2xsVG9wID0gdGhpcy4kbWVudS5zY3JvbGxUb3AoKTsNCiAgICAgICAgICAgICAgICBtZW51SGVpZ2h0ID0gdGhpcy4kbWVudS5oZWlnaHQoKSArIHBhcnNlSW50KHRoaXMuJG1lbnUuY3NzKCJwYWRkaW5nVG9wIiksIDEwKSArIHBhcnNlSW50KHRoaXMuJG1lbnUuY3NzKCJwYWRkaW5nQm90dG9tIiksIDEwKTsNCiAgICAgICAgICAgICAgICBpZiAoZWxUb3AgPCAwKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuJG1lbnUuc2Nyb2xsVG9wKG1lbnVTY3JvbGxUb3AgKyBlbFRvcCk7DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtZW51SGVpZ2h0IDwgZWxCb3R0b20pIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbWVudS5zY3JvbGxUb3AobWVudVNjcm9sbFRvcCArIChlbEJvdHRvbSAtIG1lbnVIZWlnaHQpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgew0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzT3Blbikgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVDdXJzb3IoKTsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZSgpOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoImNsb3NlZCIpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBvcGVuOiBmdW5jdGlvbiBvcGVuKCkgew0KICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc09wZW4pIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc09wZW4gPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICAhdGhpcy5pc0VtcHR5ICYmIHRoaXMuX3Nob3coKTsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJvcGVuZWQiKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgc2V0TGFuZ3VhZ2VEaXJlY3Rpb246IGZ1bmN0aW9uIHNldExhbmd1YWdlRGlyZWN0aW9uKGRpcikgew0KICAgICAgICAgICAgICAgIHRoaXMuJG1lbnUuY3NzKGRpciA9PT0gImx0ciIgPyBjc3MubHRyIDogY3NzLnJ0bCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgbW92ZUN1cnNvclVwOiBmdW5jdGlvbiBtb3ZlQ3Vyc29yVXAoKSB7DQogICAgICAgICAgICAgICAgdGhpcy5fbW92ZUN1cnNvcigtMSk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgbW92ZUN1cnNvckRvd246IGZ1bmN0aW9uIG1vdmVDdXJzb3JEb3duKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuX21vdmVDdXJzb3IoKzEpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGdldERhdHVtRm9yU3VnZ2VzdGlvbjogZnVuY3Rpb24gZ2V0RGF0dW1Gb3JTdWdnZXN0aW9uKCRlbCkgew0KICAgICAgICAgICAgICAgIHZhciBkYXR1bSA9IG51bGw7DQogICAgICAgICAgICAgICAgaWYgKCRlbC5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICAgICAgZGF0dW0gPSB7DQogICAgICAgICAgICAgICAgICAgICAgICByYXc6IERhdGFzZXQuZXh0cmFjdERhdHVtKCRlbCksDQogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogRGF0YXNldC5leHRyYWN0VmFsdWUoJGVsKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFzZXROYW1lOiBEYXRhc2V0LmV4dHJhY3REYXRhc2V0TmFtZSgkZWwpDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBkYXR1bTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBnZXREYXR1bUZvckN1cnNvcjogZnVuY3Rpb24gZ2V0RGF0dW1Gb3JDdXJzb3IoKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0dW1Gb3JTdWdnZXN0aW9uKHRoaXMuX2dldEN1cnNvcigpLmZpcnN0KCkpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGdldERhdHVtRm9yVG9wU3VnZ2VzdGlvbjogZnVuY3Rpb24gZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uKCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdHVtRm9yU3VnZ2VzdGlvbih0aGlzLl9nZXRTdWdnZXN0aW9ucygpLmZpcnN0KCkpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKHF1ZXJ5KSB7DQogICAgICAgICAgICAgICAgXy5lYWNoKHRoaXMuZGF0YXNldHMsIHVwZGF0ZURhdGFzZXQpOw0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURhdGFzZXQoZGF0YXNldCkgew0KICAgICAgICAgICAgICAgICAgICBkYXRhc2V0LnVwZGF0ZShxdWVyeSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGVtcHR5OiBmdW5jdGlvbiBlbXB0eSgpIHsNCiAgICAgICAgICAgICAgICBfLmVhY2godGhpcy5kYXRhc2V0cywgY2xlYXJEYXRhc2V0KTsNCiAgICAgICAgICAgICAgICB0aGlzLmlzRW1wdHkgPSB0cnVlOw0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNsZWFyRGF0YXNldChkYXRhc2V0KSB7DQogICAgICAgICAgICAgICAgICAgIGRhdGFzZXQuY2xlYXIoKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaXNWaXNpYmxlOiBmdW5jdGlvbiBpc1Zpc2libGUoKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNPcGVuICYmICF0aGlzLmlzRW1wdHk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsNCiAgICAgICAgICAgICAgICB0aGlzLiRtZW51Lm9mZigiLnR0Iik7DQogICAgICAgICAgICAgICAgdGhpcy4kbWVudSA9IG51bGw7DQogICAgICAgICAgICAgICAgXy5lYWNoKHRoaXMuZGF0YXNldHMsIGRlc3Ryb3lEYXRhc2V0KTsNCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBkZXN0cm95RGF0YXNldChkYXRhc2V0KSB7DQogICAgICAgICAgICAgICAgICAgIGRhdGFzZXQuZGVzdHJveSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQogICAgICAgIHJldHVybiBEcm9wZG93bjsNCiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZURhdGFzZXQob0RhdGFzZXQpIHsNCiAgICAgICAgICAgIHJldHVybiBuZXcgRGF0YXNldChvRGF0YXNldCk7DQogICAgICAgIH0NCiAgICB9KCk7DQogICAgdmFyIFR5cGVhaGVhZCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAidXNlIHN0cmljdCI7DQogICAgICAgIHZhciBhdHRyc0tleSA9ICJ0dEF0dHJzIjsNCiAgICAgICAgZnVuY3Rpb24gVHlwZWFoZWFkKG8pIHsNCiAgICAgICAgICAgIHZhciAkbWVudSwgJGlucHV0LCAkaGludDsNCiAgICAgICAgICAgIG8gPSBvIHx8IHt9Ow0KICAgICAgICAgICAgaWYgKCFvLmlucHV0KSB7DQogICAgICAgICAgICAgICAgJC5lcnJvcigibWlzc2luZyBpbnB1dCIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy5pc0FjdGl2YXRlZCA9IGZhbHNlOw0KICAgICAgICAgICAgdGhpcy5hdXRvc2VsZWN0ID0gISFvLmF1dG9zZWxlY3Q7DQogICAgICAgICAgICB0aGlzLm1pbkxlbmd0aCA9IF8uaXNOdW1iZXIoby5taW5MZW5ndGgpID8gby5taW5MZW5ndGggOiAxOw0KICAgICAgICAgICAgdGhpcy4kbm9kZSA9IGJ1aWxkRG9tKG8uaW5wdXQsIG8ud2l0aEhpbnQpOw0KICAgICAgICAgICAgJG1lbnUgPSB0aGlzLiRub2RlLmZpbmQoIi50dC1kcm9wZG93bi1tZW51Iik7DQogICAgICAgICAgICAkaW5wdXQgPSB0aGlzLiRub2RlLmZpbmQoIi50dC1pbnB1dCIpOw0KICAgICAgICAgICAgJGhpbnQgPSB0aGlzLiRub2RlLmZpbmQoIi50dC1oaW50Iik7DQogICAgICAgICAgICAkaW5wdXQub24oImJsdXIudHQiLCBmdW5jdGlvbigkZSkgew0KICAgICAgICAgICAgICAgIHZhciBhY3RpdmUsIGlzQWN0aXZlLCBoYXNBY3RpdmU7DQogICAgICAgICAgICAgICAgYWN0aXZlID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsNCiAgICAgICAgICAgICAgICBpc0FjdGl2ZSA9ICRtZW51LmlzKGFjdGl2ZSk7DQogICAgICAgICAgICAgICAgaGFzQWN0aXZlID0gJG1lbnUuaGFzKGFjdGl2ZSkubGVuZ3RoID4gMDsNCiAgICAgICAgICAgICAgICBpZiAoXy5pc01zaWUoKSAmJiAoaXNBY3RpdmUgfHwgaGFzQWN0aXZlKSkgew0KICAgICAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICAgICAgICAgICAgICAkZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsNCiAgICAgICAgICAgICAgICAgICAgXy5kZWZlcihmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICRpbnB1dC5mb2N1cygpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICRtZW51Lm9uKCJtb3VzZWRvd24udHQiLCBmdW5jdGlvbigkZSkgew0KICAgICAgICAgICAgICAgICRlLnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMgPSBvLmV2ZW50QnVzIHx8IG5ldyBFdmVudEJ1cyh7DQogICAgICAgICAgICAgICAgZWw6ICRpbnB1dA0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB0aGlzLmRyb3Bkb3duID0gbmV3IERyb3Bkb3duKHsNCiAgICAgICAgICAgICAgICBtZW51OiAkbWVudSwNCiAgICAgICAgICAgICAgICBkYXRhc2V0czogby5kYXRhc2V0cw0KICAgICAgICAgICAgfSkub25TeW5jKCJzdWdnZXN0aW9uQ2xpY2tlZCIsIHRoaXMuX29uU3VnZ2VzdGlvbkNsaWNrZWQsIHRoaXMpLm9uU3luYygiY3Vyc29yTW92ZWQiLCB0aGlzLl9vbkN1cnNvck1vdmVkLCB0aGlzKS5vblN5bmMoImN1cnNvclJlbW92ZWQiLCB0aGlzLl9vbkN1cnNvclJlbW92ZWQsIHRoaXMpLm9uU3luYygib3BlbmVkIiwgdGhpcy5fb25PcGVuZWQsIHRoaXMpLm9uU3luYygiY2xvc2VkIiwgdGhpcy5fb25DbG9zZWQsIHRoaXMpLm9uQXN5bmMoImRhdGFzZXRSZW5kZXJlZCIsIHRoaXMuX29uRGF0YXNldFJlbmRlcmVkLCB0aGlzKTsNCiAgICAgICAgICAgIHRoaXMuaW5wdXQgPSBuZXcgSW5wdXQoew0KICAgICAgICAgICAgICAgIGlucHV0OiAkaW5wdXQsDQogICAgICAgICAgICAgICAgaGludDogJGhpbnQNCiAgICAgICAgICAgIH0pLm9uU3luYygiZm9jdXNlZCIsIHRoaXMuX29uRm9jdXNlZCwgdGhpcykub25TeW5jKCJibHVycmVkIiwgdGhpcy5fb25CbHVycmVkLCB0aGlzKS5vblN5bmMoImVudGVyS2V5ZWQiLCB0aGlzLl9vbkVudGVyS2V5ZWQsIHRoaXMpLm9uU3luYygidGFiS2V5ZWQiLCB0aGlzLl9vblRhYktleWVkLCB0aGlzKS5vblN5bmMoImVzY0tleWVkIiwgdGhpcy5fb25Fc2NLZXllZCwgdGhpcykub25TeW5jKCJ1cEtleWVkIiwgdGhpcy5fb25VcEtleWVkLCB0aGlzKS5vblN5bmMoImRvd25LZXllZCIsIHRoaXMuX29uRG93bktleWVkLCB0aGlzKS5vblN5bmMoImxlZnRLZXllZCIsIHRoaXMuX29uTGVmdEtleWVkLCB0aGlzKS5vblN5bmMoInJpZ2h0S2V5ZWQiLCB0aGlzLl9vblJpZ2h0S2V5ZWQsIHRoaXMpLm9uU3luYygicXVlcnlDaGFuZ2VkIiwgdGhpcy5fb25RdWVyeUNoYW5nZWQsIHRoaXMpLm9uU3luYygid2hpdGVzcGFjZUNoYW5nZWQiLCB0aGlzLl9vbldoaXRlc3BhY2VDaGFuZ2VkLCB0aGlzKTsNCiAgICAgICAgICAgIHRoaXMuX3NldExhbmd1YWdlRGlyZWN0aW9uKCk7DQogICAgICAgIH0NCiAgICAgICAgXy5taXhpbihUeXBlYWhlYWQucHJvdG90eXBlLCB7DQogICAgICAgICAgICBfb25TdWdnZXN0aW9uQ2xpY2tlZDogZnVuY3Rpb24gb25TdWdnZXN0aW9uQ2xpY2tlZCh0eXBlLCAkZWwpIHsNCiAgICAgICAgICAgICAgICB2YXIgZGF0dW07DQogICAgICAgICAgICAgICAgaWYgKGRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvclN1Z2dlc3Rpb24oJGVsKSkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3QoZGF0dW0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfb25DdXJzb3JNb3ZlZDogZnVuY3Rpb24gb25DdXJzb3JNb3ZlZCgpIHsNCiAgICAgICAgICAgICAgICB2YXIgZGF0dW0gPSB0aGlzLmRyb3Bkb3duLmdldERhdHVtRm9yQ3Vyc29yKCk7DQogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRJbnB1dFZhbHVlKGRhdHVtLnZhbHVlLCB0cnVlKTsNCiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoImN1cnNvcmNoYW5nZWQiLCBkYXR1bS5yYXcsIGRhdHVtLmRhdGFzZXROYW1lKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfb25DdXJzb3JSZW1vdmVkOiBmdW5jdGlvbiBvbkN1cnNvclJlbW92ZWQoKSB7DQogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5yZXNldElucHV0VmFsdWUoKTsNCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIaW50KCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX29uRGF0YXNldFJlbmRlcmVkOiBmdW5jdGlvbiBvbkRhdGFzZXRSZW5kZXJlZCgpIHsNCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIaW50KCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX29uT3BlbmVkOiBmdW5jdGlvbiBvbk9wZW5lZCgpIHsNCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIaW50KCk7DQogICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJvcGVuZWQiKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfb25DbG9zZWQ6IGZ1bmN0aW9uIG9uQ2xvc2VkKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuY2xlYXJIaW50KCk7DQogICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJjbG9zZWQiKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfb25Gb2N1c2VkOiBmdW5jdGlvbiBvbkZvY3VzZWQoKSB7DQogICAgICAgICAgICAgICAgdGhpcy5pc0FjdGl2YXRlZCA9IHRydWU7DQogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vcGVuKCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX29uQmx1cnJlZDogZnVuY3Rpb24gb25CbHVycmVkKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuaXNBY3RpdmF0ZWQgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmVtcHR5KCk7DQogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9vbkVudGVyS2V5ZWQ6IGZ1bmN0aW9uIG9uRW50ZXJLZXllZCh0eXBlLCAkZSkgew0KICAgICAgICAgICAgICAgIHZhciBjdXJzb3JEYXR1bSwgdG9wU3VnZ2VzdGlvbkRhdHVtOw0KICAgICAgICAgICAgICAgIGN1cnNvckRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvckN1cnNvcigpOw0KICAgICAgICAgICAgICAgIHRvcFN1Z2dlc3Rpb25EYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uKCk7DQogICAgICAgICAgICAgICAgaWYgKGN1cnNvckRhdHVtKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdChjdXJzb3JEYXR1bSk7DQogICAgICAgICAgICAgICAgICAgICRlLnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmF1dG9zZWxlY3QgJiYgdG9wU3VnZ2VzdGlvbkRhdHVtKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdCh0b3BTdWdnZXN0aW9uRGF0dW0pOw0KICAgICAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfb25UYWJLZXllZDogZnVuY3Rpb24gb25UYWJLZXllZCh0eXBlLCAkZSkgew0KICAgICAgICAgICAgICAgIHZhciBkYXR1bTsNCiAgICAgICAgICAgICAgICBpZiAoZGF0dW0gPSB0aGlzLmRyb3Bkb3duLmdldERhdHVtRm9yQ3Vyc29yKCkpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0KGRhdHVtKTsNCiAgICAgICAgICAgICAgICAgICAgJGUucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hdXRvY29tcGxldGUodHJ1ZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9vbkVzY0tleWVkOiBmdW5jdGlvbiBvbkVzY0tleWVkKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uY2xvc2UoKTsNCiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnJlc2V0SW5wdXRWYWx1ZSgpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9vblVwS2V5ZWQ6IGZ1bmN0aW9uIG9uVXBLZXllZCgpIHsNCiAgICAgICAgICAgICAgICB2YXIgcXVlcnkgPSB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7DQogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5pc0VtcHR5ICYmIHF1ZXJ5Lmxlbmd0aCA+PSB0aGlzLm1pbkxlbmd0aCA/IHRoaXMuZHJvcGRvd24udXBkYXRlKHF1ZXJ5KSA6IHRoaXMuZHJvcGRvd24ubW92ZUN1cnNvclVwKCk7DQogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vcGVuKCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX29uRG93bktleWVkOiBmdW5jdGlvbiBvbkRvd25LZXllZCgpIHsNCiAgICAgICAgICAgICAgICB2YXIgcXVlcnkgPSB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7DQogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5pc0VtcHR5ICYmIHF1ZXJ5Lmxlbmd0aCA+PSB0aGlzLm1pbkxlbmd0aCA/IHRoaXMuZHJvcGRvd24udXBkYXRlKHF1ZXJ5KSA6IHRoaXMuZHJvcGRvd24ubW92ZUN1cnNvckRvd24oKTsNCiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfb25MZWZ0S2V5ZWQ6IGZ1bmN0aW9uIG9uTGVmdEtleWVkKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuZGlyID09PSAicnRsIiAmJiB0aGlzLl9hdXRvY29tcGxldGUoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfb25SaWdodEtleWVkOiBmdW5jdGlvbiBvblJpZ2h0S2V5ZWQoKSB7DQogICAgICAgICAgICAgICAgdGhpcy5kaXIgPT09ICJsdHIiICYmIHRoaXMuX2F1dG9jb21wbGV0ZSgpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9vblF1ZXJ5Q2hhbmdlZDogZnVuY3Rpb24gb25RdWVyeUNoYW5nZWQoZSwgcXVlcnkpIHsNCiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LmNsZWFySGludElmSW52YWxpZCgpOw0KICAgICAgICAgICAgICAgIHF1ZXJ5Lmxlbmd0aCA+PSB0aGlzLm1pbkxlbmd0aCA/IHRoaXMuZHJvcGRvd24udXBkYXRlKHF1ZXJ5KSA6IHRoaXMuZHJvcGRvd24uZW1wdHkoKTsNCiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsNCiAgICAgICAgICAgICAgICB0aGlzLl9zZXRMYW5ndWFnZURpcmVjdGlvbigpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9vbldoaXRlc3BhY2VDaGFuZ2VkOiBmdW5jdGlvbiBvbldoaXRlc3BhY2VDaGFuZ2VkKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhpbnQoKTsNCiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfc2V0TGFuZ3VhZ2VEaXJlY3Rpb246IGZ1bmN0aW9uIHNldExhbmd1YWdlRGlyZWN0aW9uKCkgew0KICAgICAgICAgICAgICAgIHZhciBkaXI7DQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGlyICE9PSAoZGlyID0gdGhpcy5pbnB1dC5nZXRMYW5ndWFnZURpcmVjdGlvbigpKSkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmRpciA9IGRpcjsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5jc3MoImRpcmVjdGlvbiIsIGRpcik7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uc2V0TGFuZ3VhZ2VEaXJlY3Rpb24oZGlyKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX3VwZGF0ZUhpbnQ6IGZ1bmN0aW9uIHVwZGF0ZUhpbnQoKSB7DQogICAgICAgICAgICAgICAgdmFyIGRhdHVtLCB2YWwsIHF1ZXJ5LCBlc2NhcGVkUXVlcnksIGZyb250TWF0Y2hSZWdFeCwgbWF0Y2g7DQogICAgICAgICAgICAgICAgZGF0dW0gPSB0aGlzLmRyb3Bkb3duLmdldERhdHVtRm9yVG9wU3VnZ2VzdGlvbigpOw0KICAgICAgICAgICAgICAgIGlmIChkYXR1bSAmJiB0aGlzLmRyb3Bkb3duLmlzVmlzaWJsZSgpICYmICF0aGlzLmlucHV0Lmhhc092ZXJmbG93KCkpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy5pbnB1dC5nZXRJbnB1dFZhbHVlKCk7DQogICAgICAgICAgICAgICAgICAgIHF1ZXJ5ID0gSW5wdXQubm9ybWFsaXplUXVlcnkodmFsKTsNCiAgICAgICAgICAgICAgICAgICAgZXNjYXBlZFF1ZXJ5ID0gXy5lc2NhcGVSZWdFeENoYXJzKHF1ZXJ5KTsNCiAgICAgICAgICAgICAgICAgICAgZnJvbnRNYXRjaFJlZ0V4ID0gbmV3IFJlZ0V4cCgiXig/OiIgKyBlc2NhcGVkUXVlcnkgKyAiKSguKyQpIiwgImkiKTsNCiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBmcm9udE1hdGNoUmVnRXguZXhlYyhkYXR1bS52YWx1ZSk7DQogICAgICAgICAgICAgICAgICAgIG1hdGNoID8gdGhpcy5pbnB1dC5zZXRIaW50KHZhbCArIG1hdGNoWzFdKSA6IHRoaXMuaW5wdXQuY2xlYXJIaW50KCk7DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5jbGVhckhpbnQoKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX2F1dG9jb21wbGV0ZTogZnVuY3Rpb24gYXV0b2NvbXBsZXRlKGxheEN1cnNvcikgew0KICAgICAgICAgICAgICAgIHZhciBoaW50LCBxdWVyeSwgaXNDdXJzb3JBdEVuZCwgZGF0dW07DQogICAgICAgICAgICAgICAgaGludCA9IHRoaXMuaW5wdXQuZ2V0SGludCgpOw0KICAgICAgICAgICAgICAgIHF1ZXJ5ID0gdGhpcy5pbnB1dC5nZXRRdWVyeSgpOw0KICAgICAgICAgICAgICAgIGlzQ3Vyc29yQXRFbmQgPSBsYXhDdXJzb3IgfHwgdGhpcy5pbnB1dC5pc0N1cnNvckF0RW5kKCk7DQogICAgICAgICAgICAgICAgaWYgKGhpbnQgJiYgcXVlcnkgIT09IGhpbnQgJiYgaXNDdXJzb3JBdEVuZCkgew0KICAgICAgICAgICAgICAgICAgICBkYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uKCk7DQogICAgICAgICAgICAgICAgICAgIGRhdHVtICYmIHRoaXMuaW5wdXQuc2V0SW5wdXRWYWx1ZShkYXR1bS52YWx1ZSk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigiYXV0b2NvbXBsZXRlZCIsIGRhdHVtLnJhdywgZGF0dW0uZGF0YXNldE5hbWUpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfc2VsZWN0OiBmdW5jdGlvbiBzZWxlY3QoZGF0dW0pIHsNCiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnNldFF1ZXJ5KGRhdHVtLnZhbHVlKTsNCiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnNldElucHV0VmFsdWUoZGF0dW0udmFsdWUsIHRydWUpOw0KICAgICAgICAgICAgICAgIHRoaXMuX3NldExhbmd1YWdlRGlyZWN0aW9uKCk7DQogICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJzZWxlY3RlZCIsIGRhdHVtLnJhdywgZGF0dW0uZGF0YXNldE5hbWUpOw0KICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uY2xvc2UoKTsNCiAgICAgICAgICAgICAgICBfLmRlZmVyKF8uYmluZCh0aGlzLmRyb3Bkb3duLmVtcHR5LCB0aGlzLmRyb3Bkb3duKSk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgb3BlbjogZnVuY3Rpb24gb3BlbigpIHsNCiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBjbG9zZTogZnVuY3Rpb24gY2xvc2UoKSB7DQogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHNldFZhbDogZnVuY3Rpb24gc2V0VmFsKHZhbCkgew0KICAgICAgICAgICAgICAgIHZhbCA9IF8udG9TdHIodmFsKTsNCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0FjdGl2YXRlZCkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnNldElucHV0VmFsdWUodmFsKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnNldFF1ZXJ5KHZhbCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc2V0SW5wdXRWYWx1ZSh2YWwsIHRydWUpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzLl9zZXRMYW5ndWFnZURpcmVjdGlvbigpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGdldFZhbDogZnVuY3Rpb24gZ2V0VmFsKCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsNCiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LmRlc3Ryb3koKTsNCiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmRlc3Ryb3koKTsNCiAgICAgICAgICAgICAgICBkZXN0cm95RG9tU3RydWN0dXJlKHRoaXMuJG5vZGUpOw0KICAgICAgICAgICAgICAgIHRoaXMuJG5vZGUgPSBudWxsOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIFR5cGVhaGVhZDsNCiAgICAgICAgZnVuY3Rpb24gYnVpbGREb20oaW5wdXQsIHdpdGhIaW50KSB7DQogICAgICAgICAgICB2YXIgJGlucHV0LCAkd3JhcHBlciwgJGRyb3Bkb3duLCAkaGludDsNCiAgICAgICAgICAgICRpbnB1dCA9ICQoaW5wdXQpOw0KICAgICAgICAgICAgJHdyYXBwZXIgPSAkKGh0bWwud3JhcHBlcikuY3NzKGNzcy53cmFwcGVyKTsNCiAgICAgICAgICAgICRkcm9wZG93biA9ICQoaHRtbC5kcm9wZG93bikuY3NzKGNzcy5kcm9wZG93bik7DQogICAgICAgICAgICAkaGludCA9ICRpbnB1dC5jbG9uZSgpLmNzcyhjc3MuaGludCkuY3NzKGdldEJhY2tncm91bmRTdHlsZXMoJGlucHV0KSk7DQogICAgICAgICAgICAkaGludC52YWwoIiIpLnJlbW92ZURhdGEoKS5hZGRDbGFzcygidHQtaGludCIpLnJlbW92ZUF0dHIoImlkIG5hbWUgcGxhY2Vob2xkZXIgcmVxdWlyZWQiKS5wcm9wKCJyZWFkb25seSIsIHRydWUpLmF0dHIoew0KICAgICAgICAgICAgICAgIGF1dG9jb21wbGV0ZTogIm9mZiIsDQogICAgICAgICAgICAgICAgc3BlbGxjaGVjazogImZhbHNlIiwNCiAgICAgICAgICAgICAgICB0YWJpbmRleDogLTENCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgJGlucHV0LmRhdGEoYXR0cnNLZXksIHsNCiAgICAgICAgICAgICAgICBkaXI6ICRpbnB1dC5hdHRyKCJkaXIiKSwNCiAgICAgICAgICAgICAgICBhdXRvY29tcGxldGU6ICRpbnB1dC5hdHRyKCJhdXRvY29tcGxldGUiKSwNCiAgICAgICAgICAgICAgICBzcGVsbGNoZWNrOiAkaW5wdXQuYXR0cigic3BlbGxjaGVjayIpLA0KICAgICAgICAgICAgICAgIHN0eWxlOiAkaW5wdXQuYXR0cigic3R5bGUiKQ0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAkaW5wdXQuYWRkQ2xhc3MoInR0LWlucHV0IikuYXR0cih7DQogICAgICAgICAgICAgICAgYXV0b2NvbXBsZXRlOiAib2ZmIiwNCiAgICAgICAgICAgICAgICBzcGVsbGNoZWNrOiBmYWxzZQ0KICAgICAgICAgICAgfSkuY3NzKHdpdGhIaW50ID8gY3NzLmlucHV0IDogY3NzLmlucHV0V2l0aE5vSGludCk7DQogICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgICEkaW5wdXQuYXR0cigiZGlyIikgJiYgJGlucHV0LmF0dHIoImRpciIsICJhdXRvIik7DQogICAgICAgICAgICB9IGNhdGNoIChlKSB7fQ0KICAgICAgICAgICAgcmV0dXJuICRpbnB1dC53cmFwKCR3cmFwcGVyKS5wYXJlbnQoKS5wcmVwZW5kKHdpdGhIaW50ID8gJGhpbnQgOiBudWxsKS5hcHBlbmQoJGRyb3Bkb3duKTsNCiAgICAgICAgfQ0KICAgICAgICBmdW5jdGlvbiBnZXRCYWNrZ3JvdW5kU3R5bGVzKCRlbCkgew0KICAgICAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQXR0YWNobWVudDogJGVsLmNzcygiYmFja2dyb3VuZC1hdHRhY2htZW50IiksDQogICAgICAgICAgICAgICAgYmFja2dyb3VuZENsaXA6ICRlbC5jc3MoImJhY2tncm91bmQtY2xpcCIpLA0KICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJGVsLmNzcygiYmFja2dyb3VuZC1jb2xvciIpLA0KICAgICAgICAgICAgICAgIGJhY2tncm91bmRJbWFnZTogJGVsLmNzcygiYmFja2dyb3VuZC1pbWFnZSIpLA0KICAgICAgICAgICAgICAgIGJhY2tncm91bmRPcmlnaW46ICRlbC5jc3MoImJhY2tncm91bmQtb3JpZ2luIiksDQogICAgICAgICAgICAgICAgYmFja2dyb3VuZFBvc2l0aW9uOiAkZWwuY3NzKCJiYWNrZ3JvdW5kLXBvc2l0aW9uIiksDQogICAgICAgICAgICAgICAgYmFja2dyb3VuZFJlcGVhdDogJGVsLmNzcygiYmFja2dyb3VuZC1yZXBlYXQiKSwNCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kU2l6ZTogJGVsLmNzcygiYmFja2dyb3VuZC1zaXplIikNCiAgICAgICAgICAgIH07DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gZGVzdHJveURvbVN0cnVjdHVyZSgkbm9kZSkgew0KICAgICAgICAgICAgdmFyICRpbnB1dCA9ICRub2RlLmZpbmQoIi50dC1pbnB1dCIpOw0KICAgICAgICAgICAgXy5lYWNoKCRpbnB1dC5kYXRhKGF0dHJzS2V5KSwgZnVuY3Rpb24odmFsLCBrZXkpIHsNCiAgICAgICAgICAgICAgICBfLmlzVW5kZWZpbmVkKHZhbCkgPyAkaW5wdXQucmVtb3ZlQXR0cihrZXkpIDogJGlucHV0LmF0dHIoa2V5LCB2YWwpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAkaW5wdXQuZGV0YWNoKCkucmVtb3ZlRGF0YShhdHRyc0tleSkucmVtb3ZlQ2xhc3MoInR0LWlucHV0IikuaW5zZXJ0QWZ0ZXIoJG5vZGUpOw0KICAgICAgICAgICAgJG5vZGUucmVtb3ZlKCk7DQogICAgICAgIH0NCiAgICB9KCk7DQogICAgKGZ1bmN0aW9uKCkgew0KICAgICAgICAidXNlIHN0cmljdCI7DQogICAgICAgIHZhciBvbGQsIHR5cGVhaGVhZEtleSwgbWV0aG9kczsNCiAgICAgICAgb2xkID0gJC5mbi50eXBlYWhlYWQ7DQogICAgICAgIHR5cGVhaGVhZEtleSA9ICJ0dFR5cGVhaGVhZCI7DQogICAgICAgIG1ldGhvZHMgPSB7DQogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiBpbml0aWFsaXplKG8sIGRhdGFzZXRzKSB7DQogICAgICAgICAgICAgICAgZGF0YXNldHMgPSBfLmlzQXJyYXkoZGF0YXNldHMpID8gZGF0YXNldHMgOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7DQogICAgICAgICAgICAgICAgbyA9IG8gfHwge307DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChhdHRhY2gpOw0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGF0dGFjaCgpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyICRpbnB1dCA9ICQodGhpcyksIGV2ZW50QnVzLCB0eXBlYWhlYWQ7DQogICAgICAgICAgICAgICAgICAgIF8uZWFjaChkYXRhc2V0cywgZnVuY3Rpb24oZCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgZC5oaWdobGlnaHQgPSAhIW8uaGlnaGxpZ2h0Ow0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgdHlwZWFoZWFkID0gbmV3IFR5cGVhaGVhZCh7DQogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dDogJGlucHV0LA0KICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRCdXM6IGV2ZW50QnVzID0gbmV3IEV2ZW50QnVzKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbDogJGlucHV0DQogICAgICAgICAgICAgICAgICAgICAgICB9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHdpdGhIaW50OiBfLmlzVW5kZWZpbmVkKG8uaGludCkgPyB0cnVlIDogISFvLmhpbnQsDQogICAgICAgICAgICAgICAgICAgICAgICBtaW5MZW5ndGg6IG8ubWluTGVuZ3RoLA0KICAgICAgICAgICAgICAgICAgICAgICAgYXV0b3NlbGVjdDogby5hdXRvc2VsZWN0LA0KICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXNldHM6IGRhdGFzZXRzDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICAkaW5wdXQuZGF0YSh0eXBlYWhlYWRLZXksIHR5cGVhaGVhZCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIG9wZW46IGZ1bmN0aW9uIG9wZW4oKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChvcGVuVHlwZWFoZWFkKTsNCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBvcGVuVHlwZWFoZWFkKCkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgJGlucHV0ID0gJCh0aGlzKSwgdHlwZWFoZWFkOw0KICAgICAgICAgICAgICAgICAgICBpZiAodHlwZWFoZWFkID0gJGlucHV0LmRhdGEodHlwZWFoZWFkS2V5KSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdHlwZWFoZWFkLm9wZW4oKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBjbG9zZTogZnVuY3Rpb24gY2xvc2UoKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChjbG9zZVR5cGVhaGVhZCk7DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xvc2VUeXBlYWhlYWQoKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciAkaW5wdXQgPSAkKHRoaXMpLCB0eXBlYWhlYWQ7DQogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlYWhlYWQgPSAkaW5wdXQuZGF0YSh0eXBlYWhlYWRLZXkpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB0eXBlYWhlYWQuY2xvc2UoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICB2YWw6IGZ1bmN0aW9uIHZhbChuZXdWYWwpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gIWFyZ3VtZW50cy5sZW5ndGggPyBnZXRWYWwodGhpcy5maXJzdCgpKSA6IHRoaXMuZWFjaChzZXRWYWwpOw0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHNldFZhbCgpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyICRpbnB1dCA9ICQodGhpcyksIHR5cGVhaGVhZDsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVhaGVhZCA9ICRpbnB1dC5kYXRhKHR5cGVhaGVhZEtleSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVhaGVhZC5zZXRWYWwobmV3VmFsKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRWYWwoJGlucHV0KSB7DQogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlYWhlYWQsIHF1ZXJ5Ow0KICAgICAgICAgICAgICAgICAgICBpZiAodHlwZWFoZWFkID0gJGlucHV0LmRhdGEodHlwZWFoZWFkS2V5KSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnkgPSB0eXBlYWhlYWQuZ2V0VmFsKCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHF1ZXJ5Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2godW5hdHRhY2gpOw0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVuYXR0YWNoKCkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgJGlucHV0ID0gJCh0aGlzKSwgdHlwZWFoZWFkOw0KICAgICAgICAgICAgICAgICAgICBpZiAodHlwZWFoZWFkID0gJGlucHV0LmRhdGEodHlwZWFoZWFkS2V5KSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdHlwZWFoZWFkLmRlc3Ryb3koKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICRpbnB1dC5yZW1vdmVEYXRhKHR5cGVhaGVhZEtleSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgICQuZm4udHlwZWFoZWFkID0gZnVuY3Rpb24obWV0aG9kKSB7DQogICAgICAgICAgICB2YXIgdHRzOw0KICAgICAgICAgICAgaWYgKG1ldGhvZHNbbWV0aG9kXSAmJiBtZXRob2QgIT09ICJpbml0aWFsaXplIikgew0KICAgICAgICAgICAgICAgIHR0cyA9IHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gISEkKHRoaXMpLmRhdGEodHlwZWFoZWFkS2V5KTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kc1ttZXRob2RdLmFwcGx5KHR0cywgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIG1ldGhvZHMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICAkLmZuLnR5cGVhaGVhZC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gbm9Db25mbGljdCgpIHsNCiAgICAgICAgICAgICQuZm4udHlwZWFoZWFkID0gb2xkOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH07DQogICAgfSkoKTsNCn0pKHdpbmRvdy5qUXVlcnkpOw==
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 73198
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "ba3f86a2-4a1c-4d78-b63d-91c2779c1b5e"
  Hint: __Sortorder
  Value: 1600
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20160509T120138Z
