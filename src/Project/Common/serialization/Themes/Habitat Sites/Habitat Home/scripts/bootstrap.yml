---
ID: "a5494d6e-8a11-4695-9677-25ee90c8ffd2"
Parent: "469e5822-381b-439a-b1b5-5d3910cfa985"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: /sitecore/media library/Themes/Habitat Sites/Habitat Home/scripts/bootstrap
DB: master
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/A5494D6E8A114695967725EE90C8FFD2.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  BlobID: "5650bf79-1778-48f0-8d61-5406891a05df"
  Value: LyohDQogKiBCb290c3RyYXAgdjMuMy43IChodHRwOi8vZ2V0Ym9vdHN0cmFwLmNvbSkNCiAqIENvcHlyaWdodCAyMDExLTIwMTYgVHdpdHRlciwgSW5jLg0KICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlDQogKi8NCg0KaWYgKHR5cGVvZiBqUXVlcnkgPT09ICd1bmRlZmluZWQnKSB7DQogIHRocm93IG5ldyBFcnJvcignQm9vdHN0cmFwXCdzIEphdmFTY3JpcHQgcmVxdWlyZXMgalF1ZXJ5JykNCn0NCg0KK2Z1bmN0aW9uICgkKSB7DQogICd1c2Ugc3RyaWN0JzsNCiAgdmFyIHZlcnNpb24gPSAkLmZuLmpxdWVyeS5zcGxpdCgnICcpWzBdLnNwbGl0KCcuJykNCiAgaWYgKCh2ZXJzaW9uWzBdIDwgMiAmJiB2ZXJzaW9uWzFdIDwgOSkgfHwgKHZlcnNpb25bMF0gPT0gMSAmJiB2ZXJzaW9uWzFdID09IDkgJiYgdmVyc2lvblsyXSA8IDEpIHx8ICh2ZXJzaW9uWzBdID4gMykpIHsNCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Jvb3RzdHJhcFwncyBKYXZhU2NyaXB0IHJlcXVpcmVzIGpRdWVyeSB2ZXJzaW9uIDEuOS4xIG9yIGhpZ2hlciwgYnV0IGxvd2VyIHRoYW4gdmVyc2lvbiA0JykNCiAgfQ0KfShqUXVlcnkpOw0KDQovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAqIEJvb3RzdHJhcDogdHJhbnNpdGlvbi5qcyB2My4zLjcNCiAqIGh0dHA6Ly9nZXRib290c3RyYXAuY29tL2phdmFzY3JpcHQvI3RyYW5zaXRpb25zDQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAqIENvcHlyaWdodCAyMDExLTIwMTYgVHdpdHRlciwgSW5jLg0KICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLw0KDQoNCitmdW5jdGlvbiAoJCkgew0KICAndXNlIHN0cmljdCc7DQoNCiAgLy8gQ1NTIFRSQU5TSVRJT04gU1VQUE9SVCAoU2hvdXRvdXQ6IGh0dHA6Ly93d3cubW9kZXJuaXpyLmNvbS8pDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQogIGZ1bmN0aW9uIHRyYW5zaXRpb25FbmQoKSB7DQogICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYm9vdHN0cmFwJykNCg0KICAgIHZhciB0cmFuc0VuZEV2ZW50TmFtZXMgPSB7DQogICAgICBXZWJraXRUcmFuc2l0aW9uIDogJ3dlYmtpdFRyYW5zaXRpb25FbmQnLA0KICAgICAgTW96VHJhbnNpdGlvbiAgICA6ICd0cmFuc2l0aW9uZW5kJywNCiAgICAgIE9UcmFuc2l0aW9uICAgICAgOiAnb1RyYW5zaXRpb25FbmQgb3RyYW5zaXRpb25lbmQnLA0KICAgICAgdHJhbnNpdGlvbiAgICAgICA6ICd0cmFuc2l0aW9uZW5kJw0KICAgIH0NCg0KICAgIGZvciAodmFyIG5hbWUgaW4gdHJhbnNFbmRFdmVudE5hbWVzKSB7DQogICAgICBpZiAoZWwuc3R5bGVbbmFtZV0gIT09IHVuZGVmaW5lZCkgew0KICAgICAgICByZXR1cm4geyBlbmQ6IHRyYW5zRW5kRXZlbnROYW1lc1tuYW1lXSB9DQogICAgICB9DQogICAgfQ0KDQogICAgcmV0dXJuIGZhbHNlIC8vIGV4cGxpY2l0IGZvciBpZTggKCAgLl8uKQ0KICB9DQoNCiAgLy8gaHR0cDovL2Jsb2cuYWxleG1hY2Nhdy5jb20vY3NzLXRyYW5zaXRpb25zDQogICQuZm4uZW11bGF0ZVRyYW5zaXRpb25FbmQgPSBmdW5jdGlvbiAoZHVyYXRpb24pIHsNCiAgICB2YXIgY2FsbGVkID0gZmFsc2UNCiAgICB2YXIgJGVsID0gdGhpcw0KICAgICQodGhpcykub25lKCdic1RyYW5zaXRpb25FbmQnLCBmdW5jdGlvbiAoKSB7IGNhbGxlZCA9IHRydWUgfSkNCiAgICB2YXIgY2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7IGlmICghY2FsbGVkKSAkKCRlbCkudHJpZ2dlcigkLnN1cHBvcnQudHJhbnNpdGlvbi5lbmQpIH0NCiAgICBzZXRUaW1lb3V0KGNhbGxiYWNrLCBkdXJhdGlvbikNCiAgICByZXR1cm4gdGhpcw0KICB9DQoNCiAgJChmdW5jdGlvbiAoKSB7DQogICAgJC5zdXBwb3J0LnRyYW5zaXRpb24gPSB0cmFuc2l0aW9uRW5kKCkNCg0KICAgIGlmICghJC5zdXBwb3J0LnRyYW5zaXRpb24pIHJldHVybg0KDQogICAgJC5ldmVudC5zcGVjaWFsLmJzVHJhbnNpdGlvbkVuZCA9IHsNCiAgICAgIGJpbmRUeXBlOiAkLnN1cHBvcnQudHJhbnNpdGlvbi5lbmQsDQogICAgICBkZWxlZ2F0ZVR5cGU6ICQuc3VwcG9ydC50cmFuc2l0aW9uLmVuZCwNCiAgICAgIGhhbmRsZTogZnVuY3Rpb24gKGUpIHsNCiAgICAgICAgaWYgKCQoZS50YXJnZXQpLmlzKHRoaXMpKSByZXR1cm4gZS5oYW5kbGVPYmouaGFuZGxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpDQogICAgICB9DQogICAgfQ0KICB9KQ0KDQp9KGpRdWVyeSk7DQoNCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICogQm9vdHN0cmFwOiBhbGVydC5qcyB2My4zLjcNCiAqIGh0dHA6Ly9nZXRib290c3RyYXAuY29tL2phdmFzY3JpcHQvI2FsZXJ0cw0KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogKiBDb3B5cmlnaHQgMjAxMS0yMDE2IFR3aXR0ZXIsIEluYy4NCiAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpDQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8NCg0KDQorZnVuY3Rpb24gKCQpIHsNCiAgJ3VzZSBzdHJpY3QnOw0KDQogIC8vIEFMRVJUIENMQVNTIERFRklOSVRJT04NCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PQ0KDQogIHZhciBkaXNtaXNzID0gJ1tkYXRhLWRpc21pc3M9ImFsZXJ0Il0nDQogIHZhciBBbGVydCAgID0gZnVuY3Rpb24gKGVsKSB7DQogICAgJChlbCkub24oJ2NsaWNrJywgZGlzbWlzcywgdGhpcy5jbG9zZSkNCiAgfQ0KDQogIEFsZXJ0LlZFUlNJT04gPSAnMy4zLjcnDQoNCiAgQWxlcnQuVFJBTlNJVElPTl9EVVJBVElPTiA9IDE1MA0KDQogIEFsZXJ0LnByb3RvdHlwZS5jbG9zZSA9IGZ1bmN0aW9uIChlKSB7DQogICAgdmFyICR0aGlzICAgID0gJCh0aGlzKQ0KICAgIHZhciBzZWxlY3RvciA9ICR0aGlzLmF0dHIoJ2RhdGEtdGFyZ2V0JykNCg0KICAgIGlmICghc2VsZWN0b3IpIHsNCiAgICAgIHNlbGVjdG9yID0gJHRoaXMuYXR0cignaHJlZicpDQogICAgICBzZWxlY3RvciA9IHNlbGVjdG9yICYmIHNlbGVjdG9yLnJlcGxhY2UoLy4qKD89I1teXHNdKiQpLywgJycpIC8vIHN0cmlwIGZvciBpZTcNCiAgICB9DQoNCiAgICB2YXIgJHBhcmVudCA9ICQoc2VsZWN0b3IgPT09ICcjJyA/IFtdIDogc2VsZWN0b3IpDQoNCiAgICBpZiAoZSkgZS5wcmV2ZW50RGVmYXVsdCgpDQoNCiAgICBpZiAoISRwYXJlbnQubGVuZ3RoKSB7DQogICAgICAkcGFyZW50ID0gJHRoaXMuY2xvc2VzdCgnLmFsZXJ0JykNCiAgICB9DQoNCiAgICAkcGFyZW50LnRyaWdnZXIoZSA9ICQuRXZlbnQoJ2Nsb3NlLmJzLmFsZXJ0JykpDQoNCiAgICBpZiAoZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgcmV0dXJuDQoNCiAgICAkcGFyZW50LnJlbW92ZUNsYXNzKCdpbicpDQoNCiAgICBmdW5jdGlvbiByZW1vdmVFbGVtZW50KCkgew0KICAgICAgLy8gZGV0YWNoIGZyb20gcGFyZW50LCBmaXJlIGV2ZW50IHRoZW4gY2xlYW4gdXAgZGF0YQ0KICAgICAgJHBhcmVudC5kZXRhY2goKS50cmlnZ2VyKCdjbG9zZWQuYnMuYWxlcnQnKS5yZW1vdmUoKQ0KICAgIH0NCg0KICAgICQuc3VwcG9ydC50cmFuc2l0aW9uICYmICRwYXJlbnQuaGFzQ2xhc3MoJ2ZhZGUnKSA/DQogICAgICAkcGFyZW50DQogICAgICAgIC5vbmUoJ2JzVHJhbnNpdGlvbkVuZCcsIHJlbW92ZUVsZW1lbnQpDQogICAgICAgIC5lbXVsYXRlVHJhbnNpdGlvbkVuZChBbGVydC5UUkFOU0lUSU9OX0RVUkFUSU9OKSA6DQogICAgICByZW1vdmVFbGVtZW50KCkNCiAgfQ0KDQoNCiAgLy8gQUxFUlQgUExVR0lOIERFRklOSVRJT04NCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT0NCg0KICBmdW5jdGlvbiBQbHVnaW4ob3B0aW9uKSB7DQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpDQogICAgICB2YXIgZGF0YSAgPSAkdGhpcy5kYXRhKCdicy5hbGVydCcpDQoNCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnYnMuYWxlcnQnLCAoZGF0YSA9IG5ldyBBbGVydCh0aGlzKSkpDQogICAgICBpZiAodHlwZW9mIG9wdGlvbiA9PSAnc3RyaW5nJykgZGF0YVtvcHRpb25dLmNhbGwoJHRoaXMpDQogICAgfSkNCiAgfQ0KDQogIHZhciBvbGQgPSAkLmZuLmFsZXJ0DQoNCiAgJC5mbi5hbGVydCAgICAgICAgICAgICA9IFBsdWdpbg0KICAkLmZuLmFsZXJ0LkNvbnN0cnVjdG9yID0gQWxlcnQNCg0KDQogIC8vIEFMRVJUIE5PIENPTkZMSUNUDQogIC8vID09PT09PT09PT09PT09PT09DQoNCiAgJC5mbi5hbGVydC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgew0KICAgICQuZm4uYWxlcnQgPSBvbGQNCiAgICByZXR1cm4gdGhpcw0KICB9DQoNCg0KICAvLyBBTEVSVCBEQVRBLUFQSQ0KICAvLyA9PT09PT09PT09PT09PQ0KDQogICQoZG9jdW1lbnQpLm9uKCdjbGljay5icy5hbGVydC5kYXRhLWFwaScsIGRpc21pc3MsIEFsZXJ0LnByb3RvdHlwZS5jbG9zZSkNCg0KfShqUXVlcnkpOw0KDQovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAqIEJvb3RzdHJhcDogYnV0dG9uLmpzIHYzLjMuNw0KICogaHR0cDovL2dldGJvb3RzdHJhcC5jb20vamF2YXNjcmlwdC8jYnV0dG9ucw0KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogKiBDb3B5cmlnaHQgMjAxMS0yMDE2IFR3aXR0ZXIsIEluYy4NCiAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpDQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8NCg0KDQorZnVuY3Rpb24gKCQpIHsNCiAgJ3VzZSBzdHJpY3QnOw0KDQogIC8vIEJVVFRPTiBQVUJMSUMgQ0xBU1MgREVGSU5JVElPTg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCg0KICB2YXIgQnV0dG9uID0gZnVuY3Rpb24gKGVsZW1lbnQsIG9wdGlvbnMpIHsNCiAgICB0aGlzLiRlbGVtZW50ICA9ICQoZWxlbWVudCkNCiAgICB0aGlzLm9wdGlvbnMgICA9ICQuZXh0ZW5kKHt9LCBCdXR0b24uREVGQVVMVFMsIG9wdGlvbnMpDQogICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZQ0KICB9DQoNCiAgQnV0dG9uLlZFUlNJT04gID0gJzMuMy43Jw0KDQogIEJ1dHRvbi5ERUZBVUxUUyA9IHsNCiAgICBsb2FkaW5nVGV4dDogJ2xvYWRpbmcuLi4nDQogIH0NCg0KICBCdXR0b24ucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlKSB7DQogICAgdmFyIGQgICAgPSAnZGlzYWJsZWQnDQogICAgdmFyICRlbCAgPSB0aGlzLiRlbGVtZW50DQogICAgdmFyIHZhbCAgPSAkZWwuaXMoJ2lucHV0JykgPyAndmFsJyA6ICdodG1sJw0KICAgIHZhciBkYXRhID0gJGVsLmRhdGEoKQ0KDQogICAgc3RhdGUgKz0gJ1RleHQnDQoNCiAgICBpZiAoZGF0YS5yZXNldFRleHQgPT0gbnVsbCkgJGVsLmRhdGEoJ3Jlc2V0VGV4dCcsICRlbFt2YWxdKCkpDQoNCiAgICAvLyBwdXNoIHRvIGV2ZW50IGxvb3AgdG8gYWxsb3cgZm9ybXMgdG8gc3VibWl0DQogICAgc2V0VGltZW91dCgkLnByb3h5KGZ1bmN0aW9uICgpIHsNCiAgICAgICRlbFt2YWxdKGRhdGFbc3RhdGVdID09IG51bGwgPyB0aGlzLm9wdGlvbnNbc3RhdGVdIDogZGF0YVtzdGF0ZV0pDQoNCiAgICAgIGlmIChzdGF0ZSA9PSAnbG9hZGluZ1RleHQnKSB7DQogICAgICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZQ0KICAgICAgICAkZWwuYWRkQ2xhc3MoZCkuYXR0cihkLCBkKS5wcm9wKGQsIHRydWUpDQogICAgICB9IGVsc2UgaWYgKHRoaXMuaXNMb2FkaW5nKSB7DQogICAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2UNCiAgICAgICAgJGVsLnJlbW92ZUNsYXNzKGQpLnJlbW92ZUF0dHIoZCkucHJvcChkLCBmYWxzZSkNCiAgICAgIH0NCiAgICB9LCB0aGlzKSwgMCkNCiAgfQ0KDQogIEJ1dHRvbi5wcm90b3R5cGUudG9nZ2xlID0gZnVuY3Rpb24gKCkgew0KICAgIHZhciBjaGFuZ2VkID0gdHJ1ZQ0KICAgIHZhciAkcGFyZW50ID0gdGhpcy4kZWxlbWVudC5jbG9zZXN0KCdbZGF0YS10b2dnbGU9ImJ1dHRvbnMiXScpDQoNCiAgICBpZiAoJHBhcmVudC5sZW5ndGgpIHsNCiAgICAgIHZhciAkaW5wdXQgPSB0aGlzLiRlbGVtZW50LmZpbmQoJ2lucHV0JykNCiAgICAgIGlmICgkaW5wdXQucHJvcCgndHlwZScpID09ICdyYWRpbycpIHsNCiAgICAgICAgaWYgKCRpbnB1dC5wcm9wKCdjaGVja2VkJykpIGNoYW5nZWQgPSBmYWxzZQ0KICAgICAgICAkcGFyZW50LmZpbmQoJy5hY3RpdmUnKS5yZW1vdmVDbGFzcygnYWN0aXZlJykNCiAgICAgICAgdGhpcy4kZWxlbWVudC5hZGRDbGFzcygnYWN0aXZlJykNCiAgICAgIH0gZWxzZSBpZiAoJGlucHV0LnByb3AoJ3R5cGUnKSA9PSAnY2hlY2tib3gnKSB7DQogICAgICAgIGlmICgoJGlucHV0LnByb3AoJ2NoZWNrZWQnKSkgIT09IHRoaXMuJGVsZW1lbnQuaGFzQ2xhc3MoJ2FjdGl2ZScpKSBjaGFuZ2VkID0gZmFsc2UNCiAgICAgICAgdGhpcy4kZWxlbWVudC50b2dnbGVDbGFzcygnYWN0aXZlJykNCiAgICAgIH0NCiAgICAgICRpbnB1dC5wcm9wKCdjaGVja2VkJywgdGhpcy4kZWxlbWVudC5oYXNDbGFzcygnYWN0aXZlJykpDQogICAgICBpZiAoY2hhbmdlZCkgJGlucHV0LnRyaWdnZXIoJ2NoYW5nZScpDQogICAgfSBlbHNlIHsNCiAgICAgIHRoaXMuJGVsZW1lbnQuYXR0cignYXJpYS1wcmVzc2VkJywgIXRoaXMuJGVsZW1lbnQuaGFzQ2xhc3MoJ2FjdGl2ZScpKQ0KICAgICAgdGhpcy4kZWxlbWVudC50b2dnbGVDbGFzcygnYWN0aXZlJykNCiAgICB9DQogIH0NCg0KDQogIC8vIEJVVFRPTiBQTFVHSU4gREVGSU5JVElPTg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT0NCg0KICBmdW5jdGlvbiBQbHVnaW4ob3B0aW9uKSB7DQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICB2YXIgJHRoaXMgICA9ICQodGhpcykNCiAgICAgIHZhciBkYXRhICAgID0gJHRoaXMuZGF0YSgnYnMuYnV0dG9uJykNCiAgICAgIHZhciBvcHRpb25zID0gdHlwZW9mIG9wdGlvbiA9PSAnb2JqZWN0JyAmJiBvcHRpb24NCg0KICAgICAgaWYgKCFkYXRhKSAkdGhpcy5kYXRhKCdicy5idXR0b24nLCAoZGF0YSA9IG5ldyBCdXR0b24odGhpcywgb3B0aW9ucykpKQ0KDQogICAgICBpZiAob3B0aW9uID09ICd0b2dnbGUnKSBkYXRhLnRvZ2dsZSgpDQogICAgICBlbHNlIGlmIChvcHRpb24pIGRhdGEuc2V0U3RhdGUob3B0aW9uKQ0KICAgIH0pDQogIH0NCg0KICB2YXIgb2xkID0gJC5mbi5idXR0b24NCg0KICAkLmZuLmJ1dHRvbiAgICAgICAgICAgICA9IFBsdWdpbg0KICAkLmZuLmJ1dHRvbi5Db25zdHJ1Y3RvciA9IEJ1dHRvbg0KDQoNCiAgLy8gQlVUVE9OIE5PIENPTkZMSUNUDQogIC8vID09PT09PT09PT09PT09PT09PQ0KDQogICQuZm4uYnV0dG9uLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgJC5mbi5idXR0b24gPSBvbGQNCiAgICByZXR1cm4gdGhpcw0KICB9DQoNCg0KICAvLyBCVVRUT04gREFUQS1BUEkNCiAgLy8gPT09PT09PT09PT09PT09DQoNCiAgJChkb2N1bWVudCkNCiAgICAub24oJ2NsaWNrLmJzLmJ1dHRvbi5kYXRhLWFwaScsICdbZGF0YS10b2dnbGVePSJidXR0b24iXScsIGZ1bmN0aW9uIChlKSB7DQogICAgICB2YXIgJGJ0biA9ICQoZS50YXJnZXQpLmNsb3Nlc3QoJy5idG4nKQ0KICAgICAgUGx1Z2luLmNhbGwoJGJ0biwgJ3RvZ2dsZScpDQogICAgICBpZiAoISgkKGUudGFyZ2V0KS5pcygnaW5wdXRbdHlwZT0icmFkaW8iXSwgaW5wdXRbdHlwZT0iY2hlY2tib3giXScpKSkgew0KICAgICAgICAvLyBQcmV2ZW50IGRvdWJsZSBjbGljayBvbiByYWRpb3MsIGFuZCB0aGUgZG91YmxlIHNlbGVjdGlvbnMgKHNvIGNhbmNlbGxhdGlvbikgb24gY2hlY2tib3hlcw0KICAgICAgICBlLnByZXZlbnREZWZhdWx0KCkNCiAgICAgICAgLy8gVGhlIHRhcmdldCBjb21wb25lbnQgc3RpbGwgcmVjZWl2ZSB0aGUgZm9jdXMNCiAgICAgICAgaWYgKCRidG4uaXMoJ2lucHV0LGJ1dHRvbicpKSAkYnRuLnRyaWdnZXIoJ2ZvY3VzJykNCiAgICAgICAgZWxzZSAkYnRuLmZpbmQoJ2lucHV0OnZpc2libGUsYnV0dG9uOnZpc2libGUnKS5maXJzdCgpLnRyaWdnZXIoJ2ZvY3VzJykNCiAgICAgIH0NCiAgICB9KQ0KICAgIC5vbignZm9jdXMuYnMuYnV0dG9uLmRhdGEtYXBpIGJsdXIuYnMuYnV0dG9uLmRhdGEtYXBpJywgJ1tkYXRhLXRvZ2dsZV49ImJ1dHRvbiJdJywgZnVuY3Rpb24gKGUpIHsNCiAgICAgICQoZS50YXJnZXQpLmNsb3Nlc3QoJy5idG4nKS50b2dnbGVDbGFzcygnZm9jdXMnLCAvXmZvY3VzKGluKT8kLy50ZXN0KGUudHlwZSkpDQogICAgfSkNCg0KfShqUXVlcnkpOw0KDQovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAqIEJvb3RzdHJhcDogY2Fyb3VzZWwuanMgdjMuMy43DQogKiBodHRwOi8vZ2V0Ym9vdHN0cmFwLmNvbS9qYXZhc2NyaXB0LyNjYXJvdXNlbA0KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogKiBDb3B5cmlnaHQgMjAxMS0yMDE2IFR3aXR0ZXIsIEluYy4NCiAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpDQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8NCg0KDQorZnVuY3Rpb24gKCQpIHsNCiAgJ3VzZSBzdHJpY3QnOw0KDQogIC8vIENBUk9VU0VMIENMQVNTIERFRklOSVRJT04NCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQogIHZhciBDYXJvdXNlbCA9IGZ1bmN0aW9uIChlbGVtZW50LCBvcHRpb25zKSB7DQogICAgdGhpcy4kZWxlbWVudCAgICA9ICQoZWxlbWVudCkNCiAgICB0aGlzLiRpbmRpY2F0b3JzID0gdGhpcy4kZWxlbWVudC5maW5kKCcuY2Fyb3VzZWwtaW5kaWNhdG9ycycpDQogICAgdGhpcy5vcHRpb25zICAgICA9IG9wdGlvbnMNCiAgICB0aGlzLnBhdXNlZCAgICAgID0gbnVsbA0KICAgIHRoaXMuc2xpZGluZyAgICAgPSBudWxsDQogICAgdGhpcy5pbnRlcnZhbCAgICA9IG51bGwNCiAgICB0aGlzLiRhY3RpdmUgICAgID0gbnVsbA0KICAgIHRoaXMuJGl0ZW1zICAgICAgPSBudWxsDQoNCiAgICB0aGlzLm9wdGlvbnMua2V5Ym9hcmQgJiYgdGhpcy4kZWxlbWVudC5vbigna2V5ZG93bi5icy5jYXJvdXNlbCcsICQucHJveHkodGhpcy5rZXlkb3duLCB0aGlzKSkNCg0KICAgIHRoaXMub3B0aW9ucy5wYXVzZSA9PSAnaG92ZXInICYmICEoJ29udG91Y2hzdGFydCcgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSAmJiB0aGlzLiRlbGVtZW50DQogICAgICAub24oJ21vdXNlZW50ZXIuYnMuY2Fyb3VzZWwnLCAkLnByb3h5KHRoaXMucGF1c2UsIHRoaXMpKQ0KICAgICAgLm9uKCdtb3VzZWxlYXZlLmJzLmNhcm91c2VsJywgJC5wcm94eSh0aGlzLmN5Y2xlLCB0aGlzKSkNCiAgfQ0KDQogIENhcm91c2VsLlZFUlNJT04gID0gJzMuMy43Jw0KDQogIENhcm91c2VsLlRSQU5TSVRJT05fRFVSQVRJT04gPSA2MDANCg0KICBDYXJvdXNlbC5ERUZBVUxUUyA9IHsNCiAgICBpbnRlcnZhbDogNTAwMCwNCiAgICBwYXVzZTogJ2hvdmVyJywNCiAgICB3cmFwOiB0cnVlLA0KICAgIGtleWJvYXJkOiB0cnVlDQogIH0NCg0KICBDYXJvdXNlbC5wcm90b3R5cGUua2V5ZG93biA9IGZ1bmN0aW9uIChlKSB7DQogICAgaWYgKC9pbnB1dHx0ZXh0YXJlYS9pLnRlc3QoZS50YXJnZXQudGFnTmFtZSkpIHJldHVybg0KICAgIHN3aXRjaCAoZS53aGljaCkgew0KICAgICAgY2FzZSAzNzogdGhpcy5wcmV2KCk7IGJyZWFrDQogICAgICBjYXNlIDM5OiB0aGlzLm5leHQoKTsgYnJlYWsNCiAgICAgIGRlZmF1bHQ6IHJldHVybg0KICAgIH0NCg0KICAgIGUucHJldmVudERlZmF1bHQoKQ0KICB9DQoNCiAgQ2Fyb3VzZWwucHJvdG90eXBlLmN5Y2xlID0gZnVuY3Rpb24gKGUpIHsNCiAgICBlIHx8ICh0aGlzLnBhdXNlZCA9IGZhbHNlKQ0KDQogICAgdGhpcy5pbnRlcnZhbCAmJiBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpDQoNCiAgICB0aGlzLm9wdGlvbnMuaW50ZXJ2YWwNCiAgICAgICYmICF0aGlzLnBhdXNlZA0KICAgICAgJiYgKHRoaXMuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgkLnByb3h5KHRoaXMubmV4dCwgdGhpcyksIHRoaXMub3B0aW9ucy5pbnRlcnZhbCkpDQoNCiAgICByZXR1cm4gdGhpcw0KICB9DQoNCiAgQ2Fyb3VzZWwucHJvdG90eXBlLmdldEl0ZW1JbmRleCA9IGZ1bmN0aW9uIChpdGVtKSB7DQogICAgdGhpcy4kaXRlbXMgPSBpdGVtLnBhcmVudCgpLmNoaWxkcmVuKCcuaXRlbScpDQogICAgcmV0dXJuIHRoaXMuJGl0ZW1zLmluZGV4KGl0ZW0gfHwgdGhpcy4kYWN0aXZlKQ0KICB9DQoNCiAgQ2Fyb3VzZWwucHJvdG90eXBlLmdldEl0ZW1Gb3JEaXJlY3Rpb24gPSBmdW5jdGlvbiAoZGlyZWN0aW9uLCBhY3RpdmUpIHsNCiAgICB2YXIgYWN0aXZlSW5kZXggPSB0aGlzLmdldEl0ZW1JbmRleChhY3RpdmUpDQogICAgdmFyIHdpbGxXcmFwID0gKGRpcmVjdGlvbiA9PSAncHJldicgJiYgYWN0aXZlSW5kZXggPT09IDApDQogICAgICAgICAgICAgICAgfHwgKGRpcmVjdGlvbiA9PSAnbmV4dCcgJiYgYWN0aXZlSW5kZXggPT0gKHRoaXMuJGl0ZW1zLmxlbmd0aCAtIDEpKQ0KICAgIGlmICh3aWxsV3JhcCAmJiAhdGhpcy5vcHRpb25zLndyYXApIHJldHVybiBhY3RpdmUNCiAgICB2YXIgZGVsdGEgPSBkaXJlY3Rpb24gPT0gJ3ByZXYnID8gLTEgOiAxDQogICAgdmFyIGl0ZW1JbmRleCA9IChhY3RpdmVJbmRleCArIGRlbHRhKSAlIHRoaXMuJGl0ZW1zLmxlbmd0aA0KICAgIHJldHVybiB0aGlzLiRpdGVtcy5lcShpdGVtSW5kZXgpDQogIH0NCg0KICBDYXJvdXNlbC5wcm90b3R5cGUudG8gPSBmdW5jdGlvbiAocG9zKSB7DQogICAgdmFyIHRoYXQgICAgICAgID0gdGhpcw0KICAgIHZhciBhY3RpdmVJbmRleCA9IHRoaXMuZ2V0SXRlbUluZGV4KHRoaXMuJGFjdGl2ZSA9IHRoaXMuJGVsZW1lbnQuZmluZCgnLml0ZW0uYWN0aXZlJykpDQoNCiAgICBpZiAocG9zID4gKHRoaXMuJGl0ZW1zLmxlbmd0aCAtIDEpIHx8IHBvcyA8IDApIHJldHVybg0KDQogICAgaWYgKHRoaXMuc2xpZGluZykgICAgICAgcmV0dXJuIHRoaXMuJGVsZW1lbnQub25lKCdzbGlkLmJzLmNhcm91c2VsJywgZnVuY3Rpb24gKCkgeyB0aGF0LnRvKHBvcykgfSkgLy8geWVzLCAic2xpZCINCiAgICBpZiAoYWN0aXZlSW5kZXggPT0gcG9zKSByZXR1cm4gdGhpcy5wYXVzZSgpLmN5Y2xlKCkNCg0KICAgIHJldHVybiB0aGlzLnNsaWRlKHBvcyA+IGFjdGl2ZUluZGV4ID8gJ25leHQnIDogJ3ByZXYnLCB0aGlzLiRpdGVtcy5lcShwb3MpKQ0KICB9DQoNCiAgQ2Fyb3VzZWwucHJvdG90eXBlLnBhdXNlID0gZnVuY3Rpb24gKGUpIHsNCiAgICBlIHx8ICh0aGlzLnBhdXNlZCA9IHRydWUpDQoNCiAgICBpZiAodGhpcy4kZWxlbWVudC5maW5kKCcubmV4dCwgLnByZXYnKS5sZW5ndGggJiYgJC5zdXBwb3J0LnRyYW5zaXRpb24pIHsNCiAgICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcigkLnN1cHBvcnQudHJhbnNpdGlvbi5lbmQpDQogICAgICB0aGlzLmN5Y2xlKHRydWUpDQogICAgfQ0KDQogICAgdGhpcy5pbnRlcnZhbCA9IGNsZWFySW50ZXJ2YWwodGhpcy5pbnRlcnZhbCkNCg0KICAgIHJldHVybiB0aGlzDQogIH0NCg0KICBDYXJvdXNlbC5wcm90b3R5cGUubmV4dCA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAodGhpcy5zbGlkaW5nKSByZXR1cm4NCiAgICByZXR1cm4gdGhpcy5zbGlkZSgnbmV4dCcpDQogIH0NCg0KICBDYXJvdXNlbC5wcm90b3R5cGUucHJldiA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAodGhpcy5zbGlkaW5nKSByZXR1cm4NCiAgICByZXR1cm4gdGhpcy5zbGlkZSgncHJldicpDQogIH0NCg0KICBDYXJvdXNlbC5wcm90b3R5cGUuc2xpZGUgPSBmdW5jdGlvbiAodHlwZSwgbmV4dCkgew0KICAgIHZhciAkYWN0aXZlICAgPSB0aGlzLiRlbGVtZW50LmZpbmQoJy5pdGVtLmFjdGl2ZScpDQogICAgdmFyICRuZXh0ICAgICA9IG5leHQgfHwgdGhpcy5nZXRJdGVtRm9yRGlyZWN0aW9uKHR5cGUsICRhY3RpdmUpDQogICAgdmFyIGlzQ3ljbGluZyA9IHRoaXMuaW50ZXJ2YWwNCiAgICB2YXIgZGlyZWN0aW9uID0gdHlwZSA9PSAnbmV4dCcgPyAnbGVmdCcgOiAncmlnaHQnDQogICAgdmFyIHRoYXQgICAgICA9IHRoaXMNCg0KICAgIGlmICgkbmV4dC5oYXNDbGFzcygnYWN0aXZlJykpIHJldHVybiAodGhpcy5zbGlkaW5nID0gZmFsc2UpDQoNCiAgICB2YXIgcmVsYXRlZFRhcmdldCA9ICRuZXh0WzBdDQogICAgdmFyIHNsaWRlRXZlbnQgPSAkLkV2ZW50KCdzbGlkZS5icy5jYXJvdXNlbCcsIHsNCiAgICAgIHJlbGF0ZWRUYXJnZXQ6IHJlbGF0ZWRUYXJnZXQsDQogICAgICBkaXJlY3Rpb246IGRpcmVjdGlvbg0KICAgIH0pDQogICAgdGhpcy4kZWxlbWVudC50cmlnZ2VyKHNsaWRlRXZlbnQpDQogICAgaWYgKHNsaWRlRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHJldHVybg0KDQogICAgdGhpcy5zbGlkaW5nID0gdHJ1ZQ0KDQogICAgaXNDeWNsaW5nICYmIHRoaXMucGF1c2UoKQ0KDQogICAgaWYgKHRoaXMuJGluZGljYXRvcnMubGVuZ3RoKSB7DQogICAgICB0aGlzLiRpbmRpY2F0b3JzLmZpbmQoJy5hY3RpdmUnKS5yZW1vdmVDbGFzcygnYWN0aXZlJykNCiAgICAgIHZhciAkbmV4dEluZGljYXRvciA9ICQodGhpcy4kaW5kaWNhdG9ycy5jaGlsZHJlbigpW3RoaXMuZ2V0SXRlbUluZGV4KCRuZXh0KV0pDQogICAgICAkbmV4dEluZGljYXRvciAmJiAkbmV4dEluZGljYXRvci5hZGRDbGFzcygnYWN0aXZlJykNCiAgICB9DQoNCiAgICB2YXIgc2xpZEV2ZW50ID0gJC5FdmVudCgnc2xpZC5icy5jYXJvdXNlbCcsIHsgcmVsYXRlZFRhcmdldDogcmVsYXRlZFRhcmdldCwgZGlyZWN0aW9uOiBkaXJlY3Rpb24gfSkgLy8geWVzLCAic2xpZCINCiAgICBpZiAoJC5zdXBwb3J0LnRyYW5zaXRpb24gJiYgdGhpcy4kZWxlbWVudC5oYXNDbGFzcygnc2xpZGUnKSkgew0KICAgICAgJG5leHQuYWRkQ2xhc3ModHlwZSkNCiAgICAgICRuZXh0WzBdLm9mZnNldFdpZHRoIC8vIGZvcmNlIHJlZmxvdw0KICAgICAgJGFjdGl2ZS5hZGRDbGFzcyhkaXJlY3Rpb24pDQogICAgICAkbmV4dC5hZGRDbGFzcyhkaXJlY3Rpb24pDQogICAgICAkYWN0aXZlDQogICAgICAgIC5vbmUoJ2JzVHJhbnNpdGlvbkVuZCcsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAkbmV4dC5yZW1vdmVDbGFzcyhbdHlwZSwgZGlyZWN0aW9uXS5qb2luKCcgJykpLmFkZENsYXNzKCdhY3RpdmUnKQ0KICAgICAgICAgICRhY3RpdmUucmVtb3ZlQ2xhc3MoWydhY3RpdmUnLCBkaXJlY3Rpb25dLmpvaW4oJyAnKSkNCiAgICAgICAgICB0aGF0LnNsaWRpbmcgPSBmYWxzZQ0KICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdGhhdC4kZWxlbWVudC50cmlnZ2VyKHNsaWRFdmVudCkNCiAgICAgICAgICB9LCAwKQ0KICAgICAgICB9KQ0KICAgICAgICAuZW11bGF0ZVRyYW5zaXRpb25FbmQoQ2Fyb3VzZWwuVFJBTlNJVElPTl9EVVJBVElPTikNCiAgICB9IGVsc2Ugew0KICAgICAgJGFjdGl2ZS5yZW1vdmVDbGFzcygnYWN0aXZlJykNCiAgICAgICRuZXh0LmFkZENsYXNzKCdhY3RpdmUnKQ0KICAgICAgdGhpcy5zbGlkaW5nID0gZmFsc2UNCiAgICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcihzbGlkRXZlbnQpDQogICAgfQ0KDQogICAgaXNDeWNsaW5nICYmIHRoaXMuY3ljbGUoKQ0KDQogICAgcmV0dXJuIHRoaXMNCiAgfQ0KDQoNCiAgLy8gQ0FST1VTRUwgUExVR0lOIERFRklOSVRJT04NCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT0NCg0KICBmdW5jdGlvbiBQbHVnaW4ob3B0aW9uKSB7DQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICB2YXIgJHRoaXMgICA9ICQodGhpcykNCiAgICAgIHZhciBkYXRhICAgID0gJHRoaXMuZGF0YSgnYnMuY2Fyb3VzZWwnKQ0KICAgICAgdmFyIG9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgQ2Fyb3VzZWwuREVGQVVMVFMsICR0aGlzLmRhdGEoKSwgdHlwZW9mIG9wdGlvbiA9PSAnb2JqZWN0JyAmJiBvcHRpb24pDQogICAgICB2YXIgYWN0aW9uICA9IHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycgPyBvcHRpb24gOiBvcHRpb25zLnNsaWRlDQoNCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnYnMuY2Fyb3VzZWwnLCAoZGF0YSA9IG5ldyBDYXJvdXNlbCh0aGlzLCBvcHRpb25zKSkpDQogICAgICBpZiAodHlwZW9mIG9wdGlvbiA9PSAnbnVtYmVyJykgZGF0YS50byhvcHRpb24pDQogICAgICBlbHNlIGlmIChhY3Rpb24pIGRhdGFbYWN0aW9uXSgpDQogICAgICBlbHNlIGlmIChvcHRpb25zLmludGVydmFsKSBkYXRhLnBhdXNlKCkuY3ljbGUoKQ0KICAgIH0pDQogIH0NCg0KICB2YXIgb2xkID0gJC5mbi5jYXJvdXNlbA0KDQogICQuZm4uY2Fyb3VzZWwgICAgICAgICAgICAgPSBQbHVnaW4NCiAgJC5mbi5jYXJvdXNlbC5Db25zdHJ1Y3RvciA9IENhcm91c2VsDQoNCg0KICAvLyBDQVJPVVNFTCBOTyBDT05GTElDVA0KICAvLyA9PT09PT09PT09PT09PT09PT09PQ0KDQogICQuZm4uY2Fyb3VzZWwubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAkLmZuLmNhcm91c2VsID0gb2xkDQogICAgcmV0dXJuIHRoaXMNCiAgfQ0KDQoNCiAgLy8gQ0FST1VTRUwgREFUQS1BUEkNCiAgLy8gPT09PT09PT09PT09PT09PT0NCg0KICB2YXIgY2xpY2tIYW5kbGVyID0gZnVuY3Rpb24gKGUpIHsNCiAgICB2YXIgaHJlZg0KICAgIHZhciAkdGhpcyAgID0gJCh0aGlzKQ0KICAgIHZhciAkdGFyZ2V0ID0gJCgkdGhpcy5hdHRyKCdkYXRhLXRhcmdldCcpIHx8IChocmVmID0gJHRoaXMuYXR0cignaHJlZicpKSAmJiBocmVmLnJlcGxhY2UoLy4qKD89I1teXHNdKyQpLywgJycpKSAvLyBzdHJpcCBmb3IgaWU3DQogICAgaWYgKCEkdGFyZ2V0Lmhhc0NsYXNzKCdjYXJvdXNlbCcpKSByZXR1cm4NCiAgICB2YXIgb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCAkdGFyZ2V0LmRhdGEoKSwgJHRoaXMuZGF0YSgpKQ0KICAgIHZhciBzbGlkZUluZGV4ID0gJHRoaXMuYXR0cignZGF0YS1zbGlkZS10bycpDQogICAgaWYgKHNsaWRlSW5kZXgpIG9wdGlvbnMuaW50ZXJ2YWwgPSBmYWxzZQ0KDQogICAgUGx1Z2luLmNhbGwoJHRhcmdldCwgb3B0aW9ucykNCg0KICAgIGlmIChzbGlkZUluZGV4KSB7DQogICAgICAkdGFyZ2V0LmRhdGEoJ2JzLmNhcm91c2VsJykudG8oc2xpZGVJbmRleCkNCiAgICB9DQoNCiAgICBlLnByZXZlbnREZWZhdWx0KCkNCiAgfQ0KDQogICQoZG9jdW1lbnQpDQogICAgLm9uKCdjbGljay5icy5jYXJvdXNlbC5kYXRhLWFwaScsICdbZGF0YS1zbGlkZV0nLCBjbGlja0hhbmRsZXIpDQogICAgLm9uKCdjbGljay5icy5jYXJvdXNlbC5kYXRhLWFwaScsICdbZGF0YS1zbGlkZS10b10nLCBjbGlja0hhbmRsZXIpDQoNCiAgJCh3aW5kb3cpLm9uKCdsb2FkJywgZnVuY3Rpb24gKCkgew0KICAgICQoJ1tkYXRhLXJpZGU9ImNhcm91c2VsIl0nKS5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgIHZhciAkY2Fyb3VzZWwgPSAkKHRoaXMpDQogICAgICBQbHVnaW4uY2FsbCgkY2Fyb3VzZWwsICRjYXJvdXNlbC5kYXRhKCkpDQogICAgfSkNCiAgfSkNCg0KfShqUXVlcnkpOw0KDQovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAqIEJvb3RzdHJhcDogY29sbGFwc2UuanMgdjMuMy43DQogKiBodHRwOi8vZ2V0Ym9vdHN0cmFwLmNvbS9qYXZhc2NyaXB0LyNjb2xsYXBzZQ0KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogKiBDb3B5cmlnaHQgMjAxMS0yMDE2IFR3aXR0ZXIsIEluYy4NCiAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpDQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8NCg0KLyoganNoaW50IGxhdGVkZWY6IGZhbHNlICovDQoNCitmdW5jdGlvbiAoJCkgew0KICAndXNlIHN0cmljdCc7DQoNCiAgLy8gQ09MTEFQU0UgUFVCTElDIENMQVNTIERFRklOSVRJT04NCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCg0KICB2YXIgQ29sbGFwc2UgPSBmdW5jdGlvbiAoZWxlbWVudCwgb3B0aW9ucykgew0KICAgIHRoaXMuJGVsZW1lbnQgICAgICA9ICQoZWxlbWVudCkNCiAgICB0aGlzLm9wdGlvbnMgICAgICAgPSAkLmV4dGVuZCh7fSwgQ29sbGFwc2UuREVGQVVMVFMsIG9wdGlvbnMpDQogICAgdGhpcy4kdHJpZ2dlciAgICAgID0gJCgnW2RhdGEtdG9nZ2xlPSJjb2xsYXBzZSJdW2hyZWY9IiMnICsgZWxlbWVudC5pZCArICciXSwnICsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICdbZGF0YS10b2dnbGU9ImNvbGxhcHNlIl1bZGF0YS10YXJnZXQ9IiMnICsgZWxlbWVudC5pZCArICciXScpDQogICAgdGhpcy50cmFuc2l0aW9uaW5nID0gbnVsbA0KDQogICAgaWYgKHRoaXMub3B0aW9ucy5wYXJlbnQpIHsNCiAgICAgIHRoaXMuJHBhcmVudCA9IHRoaXMuZ2V0UGFyZW50KCkNCiAgICB9IGVsc2Ugew0KICAgICAgdGhpcy5hZGRBcmlhQW5kQ29sbGFwc2VkQ2xhc3ModGhpcy4kZWxlbWVudCwgdGhpcy4kdHJpZ2dlcikNCiAgICB9DQoNCiAgICBpZiAodGhpcy5vcHRpb25zLnRvZ2dsZSkgdGhpcy50b2dnbGUoKQ0KICB9DQoNCiAgQ29sbGFwc2UuVkVSU0lPTiAgPSAnMy4zLjcnDQoNCiAgQ29sbGFwc2UuVFJBTlNJVElPTl9EVVJBVElPTiA9IDM1MA0KDQogIENvbGxhcHNlLkRFRkFVTFRTID0gew0KICAgIHRvZ2dsZTogdHJ1ZQ0KICB9DQoNCiAgQ29sbGFwc2UucHJvdG90eXBlLmRpbWVuc2lvbiA9IGZ1bmN0aW9uICgpIHsNCiAgICB2YXIgaGFzV2lkdGggPSB0aGlzLiRlbGVtZW50Lmhhc0NsYXNzKCd3aWR0aCcpDQogICAgcmV0dXJuIGhhc1dpZHRoID8gJ3dpZHRoJyA6ICdoZWlnaHQnDQogIH0NCg0KICBDb2xsYXBzZS5wcm90b3R5cGUuc2hvdyA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAodGhpcy50cmFuc2l0aW9uaW5nIHx8IHRoaXMuJGVsZW1lbnQuaGFzQ2xhc3MoJ2luJykpIHJldHVybg0KDQogICAgdmFyIGFjdGl2ZXNEYXRhDQogICAgdmFyIGFjdGl2ZXMgPSB0aGlzLiRwYXJlbnQgJiYgdGhpcy4kcGFyZW50LmNoaWxkcmVuKCcucGFuZWwnKS5jaGlsZHJlbignLmluLCAuY29sbGFwc2luZycpDQoNCiAgICBpZiAoYWN0aXZlcyAmJiBhY3RpdmVzLmxlbmd0aCkgew0KICAgICAgYWN0aXZlc0RhdGEgPSBhY3RpdmVzLmRhdGEoJ2JzLmNvbGxhcHNlJykNCiAgICAgIGlmIChhY3RpdmVzRGF0YSAmJiBhY3RpdmVzRGF0YS50cmFuc2l0aW9uaW5nKSByZXR1cm4NCiAgICB9DQoNCiAgICB2YXIgc3RhcnRFdmVudCA9ICQuRXZlbnQoJ3Nob3cuYnMuY29sbGFwc2UnKQ0KICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcihzdGFydEV2ZW50KQ0KICAgIGlmIChzdGFydEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSByZXR1cm4NCg0KICAgIGlmIChhY3RpdmVzICYmIGFjdGl2ZXMubGVuZ3RoKSB7DQogICAgICBQbHVnaW4uY2FsbChhY3RpdmVzLCAnaGlkZScpDQogICAgICBhY3RpdmVzRGF0YSB8fCBhY3RpdmVzLmRhdGEoJ2JzLmNvbGxhcHNlJywgbnVsbCkNCiAgICB9DQoNCiAgICB2YXIgZGltZW5zaW9uID0gdGhpcy5kaW1lbnNpb24oKQ0KDQogICAgdGhpcy4kZWxlbWVudA0KICAgICAgLnJlbW92ZUNsYXNzKCdjb2xsYXBzZScpDQogICAgICAuYWRkQ2xhc3MoJ2NvbGxhcHNpbmcnKVtkaW1lbnNpb25dKDApDQogICAgICAuYXR0cignYXJpYS1leHBhbmRlZCcsIHRydWUpDQoNCiAgICB0aGlzLiR0cmlnZ2VyDQogICAgICAucmVtb3ZlQ2xhc3MoJ2NvbGxhcHNlZCcpDQogICAgICAuYXR0cignYXJpYS1leHBhbmRlZCcsIHRydWUpDQoNCiAgICB0aGlzLnRyYW5zaXRpb25pbmcgPSAxDQoNCiAgICB2YXIgY29tcGxldGUgPSBmdW5jdGlvbiAoKSB7DQogICAgICB0aGlzLiRlbGVtZW50DQogICAgICAgIC5yZW1vdmVDbGFzcygnY29sbGFwc2luZycpDQogICAgICAgIC5hZGRDbGFzcygnY29sbGFwc2UgaW4nKVtkaW1lbnNpb25dKCcnKQ0KICAgICAgdGhpcy50cmFuc2l0aW9uaW5nID0gMA0KICAgICAgdGhpcy4kZWxlbWVudA0KICAgICAgICAudHJpZ2dlcignc2hvd24uYnMuY29sbGFwc2UnKQ0KICAgIH0NCg0KICAgIGlmICghJC5zdXBwb3J0LnRyYW5zaXRpb24pIHJldHVybiBjb21wbGV0ZS5jYWxsKHRoaXMpDQoNCiAgICB2YXIgc2Nyb2xsU2l6ZSA9ICQuY2FtZWxDYXNlKFsnc2Nyb2xsJywgZGltZW5zaW9uXS5qb2luKCctJykpDQoNCiAgICB0aGlzLiRlbGVtZW50DQogICAgICAub25lKCdic1RyYW5zaXRpb25FbmQnLCAkLnByb3h5KGNvbXBsZXRlLCB0aGlzKSkNCiAgICAgIC5lbXVsYXRlVHJhbnNpdGlvbkVuZChDb2xsYXBzZS5UUkFOU0lUSU9OX0RVUkFUSU9OKVtkaW1lbnNpb25dKHRoaXMuJGVsZW1lbnRbMF1bc2Nyb2xsU2l6ZV0pDQogIH0NCg0KICBDb2xsYXBzZS5wcm90b3R5cGUuaGlkZSA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAodGhpcy50cmFuc2l0aW9uaW5nIHx8ICF0aGlzLiRlbGVtZW50Lmhhc0NsYXNzKCdpbicpKSByZXR1cm4NCg0KICAgIHZhciBzdGFydEV2ZW50ID0gJC5FdmVudCgnaGlkZS5icy5jb2xsYXBzZScpDQogICAgdGhpcy4kZWxlbWVudC50cmlnZ2VyKHN0YXJ0RXZlbnQpDQogICAgaWYgKHN0YXJ0RXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHJldHVybg0KDQogICAgdmFyIGRpbWVuc2lvbiA9IHRoaXMuZGltZW5zaW9uKCkNCg0KICAgIHRoaXMuJGVsZW1lbnRbZGltZW5zaW9uXSh0aGlzLiRlbGVtZW50W2RpbWVuc2lvbl0oKSlbMF0ub2Zmc2V0SGVpZ2h0DQoNCiAgICB0aGlzLiRlbGVtZW50DQogICAgICAuYWRkQ2xhc3MoJ2NvbGxhcHNpbmcnKQ0KICAgICAgLnJlbW92ZUNsYXNzKCdjb2xsYXBzZSBpbicpDQogICAgICAuYXR0cignYXJpYS1leHBhbmRlZCcsIGZhbHNlKQ0KDQogICAgdGhpcy4kdHJpZ2dlcg0KICAgICAgLmFkZENsYXNzKCdjb2xsYXBzZWQnKQ0KICAgICAgLmF0dHIoJ2FyaWEtZXhwYW5kZWQnLCBmYWxzZSkNCg0KICAgIHRoaXMudHJhbnNpdGlvbmluZyA9IDENCg0KICAgIHZhciBjb21wbGV0ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgIHRoaXMudHJhbnNpdGlvbmluZyA9IDANCiAgICAgIHRoaXMuJGVsZW1lbnQNCiAgICAgICAgLnJlbW92ZUNsYXNzKCdjb2xsYXBzaW5nJykNCiAgICAgICAgLmFkZENsYXNzKCdjb2xsYXBzZScpDQogICAgICAgIC50cmlnZ2VyKCdoaWRkZW4uYnMuY29sbGFwc2UnKQ0KICAgIH0NCg0KICAgIGlmICghJC5zdXBwb3J0LnRyYW5zaXRpb24pIHJldHVybiBjb21wbGV0ZS5jYWxsKHRoaXMpDQoNCiAgICB0aGlzLiRlbGVtZW50DQogICAgICBbZGltZW5zaW9uXSgwKQ0KICAgICAgLm9uZSgnYnNUcmFuc2l0aW9uRW5kJywgJC5wcm94eShjb21wbGV0ZSwgdGhpcykpDQogICAgICAuZW11bGF0ZVRyYW5zaXRpb25FbmQoQ29sbGFwc2UuVFJBTlNJVElPTl9EVVJBVElPTikNCiAgfQ0KDQogIENvbGxhcHNlLnByb3RvdHlwZS50b2dnbGUgPSBmdW5jdGlvbiAoKSB7DQogICAgdGhpc1t0aGlzLiRlbGVtZW50Lmhhc0NsYXNzKCdpbicpID8gJ2hpZGUnIDogJ3Nob3cnXSgpDQogIH0NCg0KICBDb2xsYXBzZS5wcm90b3R5cGUuZ2V0UGFyZW50ID0gZnVuY3Rpb24gKCkgew0KICAgIHJldHVybiAkKHRoaXMub3B0aW9ucy5wYXJlbnQpDQogICAgICAuZmluZCgnW2RhdGEtdG9nZ2xlPSJjb2xsYXBzZSJdW2RhdGEtcGFyZW50PSInICsgdGhpcy5vcHRpb25zLnBhcmVudCArICciXScpDQogICAgICAuZWFjaCgkLnByb3h5KGZ1bmN0aW9uIChpLCBlbGVtZW50KSB7DQogICAgICAgIHZhciAkZWxlbWVudCA9ICQoZWxlbWVudCkNCiAgICAgICAgdGhpcy5hZGRBcmlhQW5kQ29sbGFwc2VkQ2xhc3MoZ2V0VGFyZ2V0RnJvbVRyaWdnZXIoJGVsZW1lbnQpLCAkZWxlbWVudCkNCiAgICAgIH0sIHRoaXMpKQ0KICAgICAgLmVuZCgpDQogIH0NCg0KICBDb2xsYXBzZS5wcm90b3R5cGUuYWRkQXJpYUFuZENvbGxhcHNlZENsYXNzID0gZnVuY3Rpb24gKCRlbGVtZW50LCAkdHJpZ2dlcikgew0KICAgIHZhciBpc09wZW4gPSAkZWxlbWVudC5oYXNDbGFzcygnaW4nKQ0KDQogICAgJGVsZW1lbnQuYXR0cignYXJpYS1leHBhbmRlZCcsIGlzT3BlbikNCiAgICAkdHJpZ2dlcg0KICAgICAgLnRvZ2dsZUNsYXNzKCdjb2xsYXBzZWQnLCAhaXNPcGVuKQ0KICAgICAgLmF0dHIoJ2FyaWEtZXhwYW5kZWQnLCBpc09wZW4pDQogIH0NCg0KICBmdW5jdGlvbiBnZXRUYXJnZXRGcm9tVHJpZ2dlcigkdHJpZ2dlcikgew0KICAgIHZhciBocmVmDQogICAgdmFyIHRhcmdldCA9ICR0cmlnZ2VyLmF0dHIoJ2RhdGEtdGFyZ2V0JykNCiAgICAgIHx8IChocmVmID0gJHRyaWdnZXIuYXR0cignaHJlZicpKSAmJiBocmVmLnJlcGxhY2UoLy4qKD89I1teXHNdKyQpLywgJycpIC8vIHN0cmlwIGZvciBpZTcNCg0KICAgIHJldHVybiAkKHRhcmdldCkNCiAgfQ0KDQoNCiAgLy8gQ09MTEFQU0UgUExVR0lOIERFRklOSVRJT04NCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT0NCg0KICBmdW5jdGlvbiBQbHVnaW4ob3B0aW9uKSB7DQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICB2YXIgJHRoaXMgICA9ICQodGhpcykNCiAgICAgIHZhciBkYXRhICAgID0gJHRoaXMuZGF0YSgnYnMuY29sbGFwc2UnKQ0KICAgICAgdmFyIG9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgQ29sbGFwc2UuREVGQVVMVFMsICR0aGlzLmRhdGEoKSwgdHlwZW9mIG9wdGlvbiA9PSAnb2JqZWN0JyAmJiBvcHRpb24pDQoNCiAgICAgIGlmICghZGF0YSAmJiBvcHRpb25zLnRvZ2dsZSAmJiAvc2hvd3xoaWRlLy50ZXN0KG9wdGlvbikpIG9wdGlvbnMudG9nZ2xlID0gZmFsc2UNCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnYnMuY29sbGFwc2UnLCAoZGF0YSA9IG5ldyBDb2xsYXBzZSh0aGlzLCBvcHRpb25zKSkpDQogICAgICBpZiAodHlwZW9mIG9wdGlvbiA9PSAnc3RyaW5nJykgZGF0YVtvcHRpb25dKCkNCiAgICB9KQ0KICB9DQoNCiAgdmFyIG9sZCA9ICQuZm4uY29sbGFwc2UNCg0KICAkLmZuLmNvbGxhcHNlICAgICAgICAgICAgID0gUGx1Z2luDQogICQuZm4uY29sbGFwc2UuQ29uc3RydWN0b3IgPSBDb2xsYXBzZQ0KDQoNCiAgLy8gQ09MTEFQU0UgTk8gQ09ORkxJQ1QNCiAgLy8gPT09PT09PT09PT09PT09PT09PT0NCg0KICAkLmZuLmNvbGxhcHNlLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgJC5mbi5jb2xsYXBzZSA9IG9sZA0KICAgIHJldHVybiB0aGlzDQogIH0NCg0KDQogIC8vIENPTExBUFNFIERBVEEtQVBJDQogIC8vID09PT09PT09PT09PT09PT09DQoNCiAgJChkb2N1bWVudCkub24oJ2NsaWNrLmJzLmNvbGxhcHNlLmRhdGEtYXBpJywgJ1tkYXRhLXRvZ2dsZT0iY29sbGFwc2UiXScsIGZ1bmN0aW9uIChlKSB7DQogICAgdmFyICR0aGlzICAgPSAkKHRoaXMpDQoNCiAgICBpZiAoISR0aGlzLmF0dHIoJ2RhdGEtdGFyZ2V0JykpIGUucHJldmVudERlZmF1bHQoKQ0KDQogICAgdmFyICR0YXJnZXQgPSBnZXRUYXJnZXRGcm9tVHJpZ2dlcigkdGhpcykNCiAgICB2YXIgZGF0YSAgICA9ICR0YXJnZXQuZGF0YSgnYnMuY29sbGFwc2UnKQ0KICAgIHZhciBvcHRpb24gID0gZGF0YSA/ICd0b2dnbGUnIDogJHRoaXMuZGF0YSgpDQoNCiAgICBQbHVnaW4uY2FsbCgkdGFyZ2V0LCBvcHRpb24pDQogIH0pDQoNCn0oalF1ZXJ5KTsNCg0KLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogKiBCb290c3RyYXA6IGRyb3Bkb3duLmpzIHYzLjMuNw0KICogaHR0cDovL2dldGJvb3RzdHJhcC5jb20vamF2YXNjcmlwdC8jZHJvcGRvd25zDQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAqIENvcHlyaWdodCAyMDExLTIwMTYgVHdpdHRlciwgSW5jLg0KICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLw0KDQoNCitmdW5jdGlvbiAoJCkgew0KICAndXNlIHN0cmljdCc7DQoNCiAgLy8gRFJPUERPV04gQ0xBU1MgREVGSU5JVElPTg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09DQoNCiAgdmFyIGJhY2tkcm9wID0gJy5kcm9wZG93bi1iYWNrZHJvcCcNCiAgdmFyIHRvZ2dsZSAgID0gJ1tkYXRhLXRvZ2dsZT0iZHJvcGRvd24iXScNCiAgdmFyIERyb3Bkb3duID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsNCiAgICAkKGVsZW1lbnQpLm9uKCdjbGljay5icy5kcm9wZG93bicsIHRoaXMudG9nZ2xlKQ0KICB9DQoNCiAgRHJvcGRvd24uVkVSU0lPTiA9ICczLjMuNycNCg0KICBmdW5jdGlvbiBnZXRQYXJlbnQoJHRoaXMpIHsNCiAgICB2YXIgc2VsZWN0b3IgPSAkdGhpcy5hdHRyKCdkYXRhLXRhcmdldCcpDQoNCiAgICBpZiAoIXNlbGVjdG9yKSB7DQogICAgICBzZWxlY3RvciA9ICR0aGlzLmF0dHIoJ2hyZWYnKQ0KICAgICAgc2VsZWN0b3IgPSBzZWxlY3RvciAmJiAvI1tBLVphLXpdLy50ZXN0KHNlbGVjdG9yKSAmJiBzZWxlY3Rvci5yZXBsYWNlKC8uKig/PSNbXlxzXSokKS8sICcnKSAvLyBzdHJpcCBmb3IgaWU3DQogICAgfQ0KDQogICAgdmFyICRwYXJlbnQgPSBzZWxlY3RvciAmJiAkKHNlbGVjdG9yKQ0KDQogICAgcmV0dXJuICRwYXJlbnQgJiYgJHBhcmVudC5sZW5ndGggPyAkcGFyZW50IDogJHRoaXMucGFyZW50KCkNCiAgfQ0KDQogIGZ1bmN0aW9uIGNsZWFyTWVudXMoZSkgew0KICAgIGlmIChlICYmIGUud2hpY2ggPT09IDMpIHJldHVybg0KICAgICQoYmFja2Ryb3ApLnJlbW92ZSgpDQogICAgJCh0b2dnbGUpLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgdmFyICR0aGlzICAgICAgICAgPSAkKHRoaXMpDQogICAgICB2YXIgJHBhcmVudCAgICAgICA9IGdldFBhcmVudCgkdGhpcykNCiAgICAgIHZhciByZWxhdGVkVGFyZ2V0ID0geyByZWxhdGVkVGFyZ2V0OiB0aGlzIH0NCg0KICAgICAgaWYgKCEkcGFyZW50Lmhhc0NsYXNzKCdvcGVuJykpIHJldHVybg0KDQogICAgICBpZiAoZSAmJiBlLnR5cGUgPT0gJ2NsaWNrJyAmJiAvaW5wdXR8dGV4dGFyZWEvaS50ZXN0KGUudGFyZ2V0LnRhZ05hbWUpICYmICQuY29udGFpbnMoJHBhcmVudFswXSwgZS50YXJnZXQpKSByZXR1cm4NCg0KICAgICAgJHBhcmVudC50cmlnZ2VyKGUgPSAkLkV2ZW50KCdoaWRlLmJzLmRyb3Bkb3duJywgcmVsYXRlZFRhcmdldCkpDQoNCiAgICAgIGlmIChlLmlzRGVmYXVsdFByZXZlbnRlZCgpKSByZXR1cm4NCg0KICAgICAgJHRoaXMuYXR0cignYXJpYS1leHBhbmRlZCcsICdmYWxzZScpDQogICAgICAkcGFyZW50LnJlbW92ZUNsYXNzKCdvcGVuJykudHJpZ2dlcigkLkV2ZW50KCdoaWRkZW4uYnMuZHJvcGRvd24nLCByZWxhdGVkVGFyZ2V0KSkNCiAgICB9KQ0KICB9DQoNCiAgRHJvcGRvd24ucHJvdG90eXBlLnRvZ2dsZSA9IGZ1bmN0aW9uIChlKSB7DQogICAgdmFyICR0aGlzID0gJCh0aGlzKQ0KDQogICAgaWYgKCR0aGlzLmlzKCcuZGlzYWJsZWQsIDpkaXNhYmxlZCcpKSByZXR1cm4NCg0KICAgIHZhciAkcGFyZW50ICA9IGdldFBhcmVudCgkdGhpcykNCiAgICB2YXIgaXNBY3RpdmUgPSAkcGFyZW50Lmhhc0NsYXNzKCdvcGVuJykNCg0KICAgIGNsZWFyTWVudXMoKQ0KDQogICAgaWYgKCFpc0FjdGl2ZSkgew0KICAgICAgaWYgKCdvbnRvdWNoc3RhcnQnIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiAhJHBhcmVudC5jbG9zZXN0KCcubmF2YmFyLW5hdicpLmxlbmd0aCkgew0KICAgICAgICAvLyBpZiBtb2JpbGUgd2UgdXNlIGEgYmFja2Ryb3AgYmVjYXVzZSBjbGljayBldmVudHMgZG9uJ3QgZGVsZWdhdGUNCiAgICAgICAgJChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSkNCiAgICAgICAgICAuYWRkQ2xhc3MoJ2Ryb3Bkb3duLWJhY2tkcm9wJykNCiAgICAgICAgICAuaW5zZXJ0QWZ0ZXIoJCh0aGlzKSkNCiAgICAgICAgICAub24oJ2NsaWNrJywgY2xlYXJNZW51cykNCiAgICAgIH0NCg0KICAgICAgdmFyIHJlbGF0ZWRUYXJnZXQgPSB7IHJlbGF0ZWRUYXJnZXQ6IHRoaXMgfQ0KICAgICAgJHBhcmVudC50cmlnZ2VyKGUgPSAkLkV2ZW50KCdzaG93LmJzLmRyb3Bkb3duJywgcmVsYXRlZFRhcmdldCkpDQoNCiAgICAgIGlmIChlLmlzRGVmYXVsdFByZXZlbnRlZCgpKSByZXR1cm4NCg0KICAgICAgJHRoaXMNCiAgICAgICAgLnRyaWdnZXIoJ2ZvY3VzJykNCiAgICAgICAgLmF0dHIoJ2FyaWEtZXhwYW5kZWQnLCAndHJ1ZScpDQoNCiAgICAgICRwYXJlbnQNCiAgICAgICAgLnRvZ2dsZUNsYXNzKCdvcGVuJykNCiAgICAgICAgLnRyaWdnZXIoJC5FdmVudCgnc2hvd24uYnMuZHJvcGRvd24nLCByZWxhdGVkVGFyZ2V0KSkNCiAgICB9DQoNCiAgICByZXR1cm4gZmFsc2UNCiAgfQ0KDQogIERyb3Bkb3duLnByb3RvdHlwZS5rZXlkb3duID0gZnVuY3Rpb24gKGUpIHsNCiAgICBpZiAoIS8oMzh8NDB8Mjd8MzIpLy50ZXN0KGUud2hpY2gpIHx8IC9pbnB1dHx0ZXh0YXJlYS9pLnRlc3QoZS50YXJnZXQudGFnTmFtZSkpIHJldHVybg0KDQogICAgdmFyICR0aGlzID0gJCh0aGlzKQ0KDQogICAgZS5wcmV2ZW50RGVmYXVsdCgpDQogICAgZS5zdG9wUHJvcGFnYXRpb24oKQ0KDQogICAgaWYgKCR0aGlzLmlzKCcuZGlzYWJsZWQsIDpkaXNhYmxlZCcpKSByZXR1cm4NCg0KICAgIHZhciAkcGFyZW50ICA9IGdldFBhcmVudCgkdGhpcykNCiAgICB2YXIgaXNBY3RpdmUgPSAkcGFyZW50Lmhhc0NsYXNzKCdvcGVuJykNCg0KICAgIGlmICghaXNBY3RpdmUgJiYgZS53aGljaCAhPSAyNyB8fCBpc0FjdGl2ZSAmJiBlLndoaWNoID09IDI3KSB7DQogICAgICBpZiAoZS53aGljaCA9PSAyNykgJHBhcmVudC5maW5kKHRvZ2dsZSkudHJpZ2dlcignZm9jdXMnKQ0KICAgICAgcmV0dXJuICR0aGlzLnRyaWdnZXIoJ2NsaWNrJykNCiAgICB9DQoNCiAgICB2YXIgZGVzYyA9ICcgbGk6bm90KC5kaXNhYmxlZCk6dmlzaWJsZSBhJw0KICAgIHZhciAkaXRlbXMgPSAkcGFyZW50LmZpbmQoJy5kcm9wZG93bi1tZW51JyArIGRlc2MpDQoNCiAgICBpZiAoISRpdGVtcy5sZW5ndGgpIHJldHVybg0KDQogICAgdmFyIGluZGV4ID0gJGl0ZW1zLmluZGV4KGUudGFyZ2V0KQ0KDQogICAgaWYgKGUud2hpY2ggPT0gMzggJiYgaW5kZXggPiAwKSAgICAgICAgICAgICAgICAgaW5kZXgtLSAgICAgICAgIC8vIHVwDQogICAgaWYgKGUud2hpY2ggPT0gNDAgJiYgaW5kZXggPCAkaXRlbXMubGVuZ3RoIC0gMSkgaW5kZXgrKyAgICAgICAgIC8vIGRvd24NCiAgICBpZiAoIX5pbmRleCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IDANCg0KICAgICRpdGVtcy5lcShpbmRleCkudHJpZ2dlcignZm9jdXMnKQ0KICB9DQoNCg0KICAvLyBEUk9QRE9XTiBQTFVHSU4gREVGSU5JVElPTg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQogIGZ1bmN0aW9uIFBsdWdpbihvcHRpb24pIHsNCiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgIHZhciAkdGhpcyA9ICQodGhpcykNCiAgICAgIHZhciBkYXRhICA9ICR0aGlzLmRhdGEoJ2JzLmRyb3Bkb3duJykNCg0KICAgICAgaWYgKCFkYXRhKSAkdGhpcy5kYXRhKCdicy5kcm9wZG93bicsIChkYXRhID0gbmV3IERyb3Bkb3duKHRoaXMpKSkNCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9uID09ICdzdHJpbmcnKSBkYXRhW29wdGlvbl0uY2FsbCgkdGhpcykNCiAgICB9KQ0KICB9DQoNCiAgdmFyIG9sZCA9ICQuZm4uZHJvcGRvd24NCg0KICAkLmZuLmRyb3Bkb3duICAgICAgICAgICAgID0gUGx1Z2luDQogICQuZm4uZHJvcGRvd24uQ29uc3RydWN0b3IgPSBEcm9wZG93bg0KDQoNCiAgLy8gRFJPUERPV04gTk8gQ09ORkxJQ1QNCiAgLy8gPT09PT09PT09PT09PT09PT09PT0NCg0KICAkLmZuLmRyb3Bkb3duLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgJC5mbi5kcm9wZG93biA9IG9sZA0KICAgIHJldHVybiB0aGlzDQogIH0NCg0KDQogIC8vIEFQUExZIFRPIFNUQU5EQVJEIERST1BET1dOIEVMRU1FTlRTDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQoNCiAgJChkb2N1bWVudCkNCiAgICAub24oJ2NsaWNrLmJzLmRyb3Bkb3duLmRhdGEtYXBpJywgY2xlYXJNZW51cykNCiAgICAub24oJ2NsaWNrLmJzLmRyb3Bkb3duLmRhdGEtYXBpJywgJy5kcm9wZG93biBmb3JtJywgZnVuY3Rpb24gKGUpIHsgZS5zdG9wUHJvcGFnYXRpb24oKSB9KQ0KICAgIC5vbignY2xpY2suYnMuZHJvcGRvd24uZGF0YS1hcGknLCB0b2dnbGUsIERyb3Bkb3duLnByb3RvdHlwZS50b2dnbGUpDQogICAgLm9uKCdrZXlkb3duLmJzLmRyb3Bkb3duLmRhdGEtYXBpJywgdG9nZ2xlLCBEcm9wZG93bi5wcm90b3R5cGUua2V5ZG93bikNCiAgICAub24oJ2tleWRvd24uYnMuZHJvcGRvd24uZGF0YS1hcGknLCAnLmRyb3Bkb3duLW1lbnUnLCBEcm9wZG93bi5wcm90b3R5cGUua2V5ZG93bikNCg0KfShqUXVlcnkpOw0KDQovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAqIEJvb3RzdHJhcDogbW9kYWwuanMgdjMuMy43DQogKiBodHRwOi8vZ2V0Ym9vdHN0cmFwLmNvbS9qYXZhc2NyaXB0LyNtb2RhbHMNCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICogQ29weXJpZ2h0IDIwMTEtMjAxNiBUd2l0dGVyLCBJbmMuDQogKiBMaWNlbnNlZCB1bmRlciBNSVQgKGh0dHBzOi8vZ2l0aHViLmNvbS90d2JzL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9MSUNFTlNFKQ0KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovDQoNCg0KK2Z1bmN0aW9uICgkKSB7DQogICd1c2Ugc3RyaWN0JzsNCg0KICAvLyBNT0RBTCBDTEFTUyBERUZJTklUSU9ODQogIC8vID09PT09PT09PT09PT09PT09PT09PT0NCg0KICB2YXIgTW9kYWwgPSBmdW5jdGlvbiAoZWxlbWVudCwgb3B0aW9ucykgew0KICAgIHRoaXMub3B0aW9ucyAgICAgICAgICAgICA9IG9wdGlvbnMNCiAgICB0aGlzLiRib2R5ICAgICAgICAgICAgICAgPSAkKGRvY3VtZW50LmJvZHkpDQogICAgdGhpcy4kZWxlbWVudCAgICAgICAgICAgID0gJChlbGVtZW50KQ0KICAgIHRoaXMuJGRpYWxvZyAgICAgICAgICAgICA9IHRoaXMuJGVsZW1lbnQuZmluZCgnLm1vZGFsLWRpYWxvZycpDQogICAgdGhpcy4kYmFja2Ryb3AgICAgICAgICAgID0gbnVsbA0KICAgIHRoaXMuaXNTaG93biAgICAgICAgICAgICA9IG51bGwNCiAgICB0aGlzLm9yaWdpbmFsQm9keVBhZCAgICAgPSBudWxsDQogICAgdGhpcy5zY3JvbGxiYXJXaWR0aCAgICAgID0gMA0KICAgIHRoaXMuaWdub3JlQmFja2Ryb3BDbGljayA9IGZhbHNlDQoNCiAgICBpZiAodGhpcy5vcHRpb25zLnJlbW90ZSkgew0KICAgICAgdGhpcy4kZWxlbWVudA0KICAgICAgICAuZmluZCgnLm1vZGFsLWNvbnRlbnQnKQ0KICAgICAgICAubG9hZCh0aGlzLm9wdGlvbnMucmVtb3RlLCAkLnByb3h5KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXIoJ2xvYWRlZC5icy5tb2RhbCcpDQogICAgICAgIH0sIHRoaXMpKQ0KICAgIH0NCiAgfQ0KDQogIE1vZGFsLlZFUlNJT04gID0gJzMuMy43Jw0KDQogIE1vZGFsLlRSQU5TSVRJT05fRFVSQVRJT04gPSAzMDANCiAgTW9kYWwuQkFDS0RST1BfVFJBTlNJVElPTl9EVVJBVElPTiA9IDE1MA0KDQogIE1vZGFsLkRFRkFVTFRTID0gew0KICAgIGJhY2tkcm9wOiB0cnVlLA0KICAgIGtleWJvYXJkOiB0cnVlLA0KICAgIHNob3c6IHRydWUNCiAgfQ0KDQogIE1vZGFsLnByb3RvdHlwZS50b2dnbGUgPSBmdW5jdGlvbiAoX3JlbGF0ZWRUYXJnZXQpIHsNCiAgICByZXR1cm4gdGhpcy5pc1Nob3duID8gdGhpcy5oaWRlKCkgOiB0aGlzLnNob3coX3JlbGF0ZWRUYXJnZXQpDQogIH0NCg0KICBNb2RhbC5wcm90b3R5cGUuc2hvdyA9IGZ1bmN0aW9uIChfcmVsYXRlZFRhcmdldCkgew0KICAgIHZhciB0aGF0ID0gdGhpcw0KICAgIHZhciBlICAgID0gJC5FdmVudCgnc2hvdy5icy5tb2RhbCcsIHsgcmVsYXRlZFRhcmdldDogX3JlbGF0ZWRUYXJnZXQgfSkNCg0KICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcihlKQ0KDQogICAgaWYgKHRoaXMuaXNTaG93biB8fCBlLmlzRGVmYXVsdFByZXZlbnRlZCgpKSByZXR1cm4NCg0KICAgIHRoaXMuaXNTaG93biA9IHRydWUNCg0KICAgIHRoaXMuY2hlY2tTY3JvbGxiYXIoKQ0KICAgIHRoaXMuc2V0U2Nyb2xsYmFyKCkNCiAgICB0aGlzLiRib2R5LmFkZENsYXNzKCdtb2RhbC1vcGVuJykNCg0KICAgIHRoaXMuZXNjYXBlKCkNCiAgICB0aGlzLnJlc2l6ZSgpDQoNCiAgICB0aGlzLiRlbGVtZW50Lm9uKCdjbGljay5kaXNtaXNzLmJzLm1vZGFsJywgJ1tkYXRhLWRpc21pc3M9Im1vZGFsIl0nLCAkLnByb3h5KHRoaXMuaGlkZSwgdGhpcykpDQoNCiAgICB0aGlzLiRkaWFsb2cub24oJ21vdXNlZG93bi5kaXNtaXNzLmJzLm1vZGFsJywgZnVuY3Rpb24gKCkgew0KICAgICAgdGhhdC4kZWxlbWVudC5vbmUoJ21vdXNldXAuZGlzbWlzcy5icy5tb2RhbCcsIGZ1bmN0aW9uIChlKSB7DQogICAgICAgIGlmICgkKGUudGFyZ2V0KS5pcyh0aGF0LiRlbGVtZW50KSkgdGhhdC5pZ25vcmVCYWNrZHJvcENsaWNrID0gdHJ1ZQ0KICAgICAgfSkNCiAgICB9KQ0KDQogICAgdGhpcy5iYWNrZHJvcChmdW5jdGlvbiAoKSB7DQogICAgICB2YXIgdHJhbnNpdGlvbiA9ICQuc3VwcG9ydC50cmFuc2l0aW9uICYmIHRoYXQuJGVsZW1lbnQuaGFzQ2xhc3MoJ2ZhZGUnKQ0KDQogICAgICBpZiAoIXRoYXQuJGVsZW1lbnQucGFyZW50KCkubGVuZ3RoKSB7DQogICAgICAgIHRoYXQuJGVsZW1lbnQuYXBwZW5kVG8odGhhdC4kYm9keSkgLy8gZG9uJ3QgbW92ZSBtb2RhbHMgZG9tIHBvc2l0aW9uDQogICAgICB9DQoNCiAgICAgIHRoYXQuJGVsZW1lbnQNCiAgICAgICAgLnNob3coKQ0KICAgICAgICAuc2Nyb2xsVG9wKDApDQoNCiAgICAgIHRoYXQuYWRqdXN0RGlhbG9nKCkNCg0KICAgICAgaWYgKHRyYW5zaXRpb24pIHsNCiAgICAgICAgdGhhdC4kZWxlbWVudFswXS5vZmZzZXRXaWR0aCAvLyBmb3JjZSByZWZsb3cNCiAgICAgIH0NCg0KICAgICAgdGhhdC4kZWxlbWVudC5hZGRDbGFzcygnaW4nKQ0KDQogICAgICB0aGF0LmVuZm9yY2VGb2N1cygpDQoNCiAgICAgIHZhciBlID0gJC5FdmVudCgnc2hvd24uYnMubW9kYWwnLCB7IHJlbGF0ZWRUYXJnZXQ6IF9yZWxhdGVkVGFyZ2V0IH0pDQoNCiAgICAgIHRyYW5zaXRpb24gPw0KICAgICAgICB0aGF0LiRkaWFsb2cgLy8gd2FpdCBmb3IgbW9kYWwgdG8gc2xpZGUgaW4NCiAgICAgICAgICAub25lKCdic1RyYW5zaXRpb25FbmQnLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB0aGF0LiRlbGVtZW50LnRyaWdnZXIoJ2ZvY3VzJykudHJpZ2dlcihlKQ0KICAgICAgICAgIH0pDQogICAgICAgICAgLmVtdWxhdGVUcmFuc2l0aW9uRW5kKE1vZGFsLlRSQU5TSVRJT05fRFVSQVRJT04pIDoNCiAgICAgICAgdGhhdC4kZWxlbWVudC50cmlnZ2VyKCdmb2N1cycpLnRyaWdnZXIoZSkNCiAgICB9KQ0KICB9DQoNCiAgTW9kYWwucHJvdG90eXBlLmhpZGUgPSBmdW5jdGlvbiAoZSkgew0KICAgIGlmIChlKSBlLnByZXZlbnREZWZhdWx0KCkNCg0KICAgIGUgPSAkLkV2ZW50KCdoaWRlLmJzLm1vZGFsJykNCg0KICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcihlKQ0KDQogICAgaWYgKCF0aGlzLmlzU2hvd24gfHwgZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgcmV0dXJuDQoNCiAgICB0aGlzLmlzU2hvd24gPSBmYWxzZQ0KDQogICAgdGhpcy5lc2NhcGUoKQ0KICAgIHRoaXMucmVzaXplKCkNCg0KICAgICQoZG9jdW1lbnQpLm9mZignZm9jdXNpbi5icy5tb2RhbCcpDQoNCiAgICB0aGlzLiRlbGVtZW50DQogICAgICAucmVtb3ZlQ2xhc3MoJ2luJykNCiAgICAgIC5vZmYoJ2NsaWNrLmRpc21pc3MuYnMubW9kYWwnKQ0KICAgICAgLm9mZignbW91c2V1cC5kaXNtaXNzLmJzLm1vZGFsJykNCg0KICAgIHRoaXMuJGRpYWxvZy5vZmYoJ21vdXNlZG93bi5kaXNtaXNzLmJzLm1vZGFsJykNCg0KICAgICQuc3VwcG9ydC50cmFuc2l0aW9uICYmIHRoaXMuJGVsZW1lbnQuaGFzQ2xhc3MoJ2ZhZGUnKSA/DQogICAgICB0aGlzLiRlbGVtZW50DQogICAgICAgIC5vbmUoJ2JzVHJhbnNpdGlvbkVuZCcsICQucHJveHkodGhpcy5oaWRlTW9kYWwsIHRoaXMpKQ0KICAgICAgICAuZW11bGF0ZVRyYW5zaXRpb25FbmQoTW9kYWwuVFJBTlNJVElPTl9EVVJBVElPTikgOg0KICAgICAgdGhpcy5oaWRlTW9kYWwoKQ0KICB9DQoNCiAgTW9kYWwucHJvdG90eXBlLmVuZm9yY2VGb2N1cyA9IGZ1bmN0aW9uICgpIHsNCiAgICAkKGRvY3VtZW50KQ0KICAgICAgLm9mZignZm9jdXNpbi5icy5tb2RhbCcpIC8vIGd1YXJkIGFnYWluc3QgaW5maW5pdGUgZm9jdXMgbG9vcA0KICAgICAgLm9uKCdmb2N1c2luLmJzLm1vZGFsJywgJC5wcm94eShmdW5jdGlvbiAoZSkgew0KICAgICAgICBpZiAoZG9jdW1lbnQgIT09IGUudGFyZ2V0ICYmDQogICAgICAgICAgICB0aGlzLiRlbGVtZW50WzBdICE9PSBlLnRhcmdldCAmJg0KICAgICAgICAgICAgIXRoaXMuJGVsZW1lbnQuaGFzKGUudGFyZ2V0KS5sZW5ndGgpIHsNCiAgICAgICAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXIoJ2ZvY3VzJykNCiAgICAgICAgfQ0KICAgICAgfSwgdGhpcykpDQogIH0NCg0KICBNb2RhbC5wcm90b3R5cGUuZXNjYXBlID0gZnVuY3Rpb24gKCkgew0KICAgIGlmICh0aGlzLmlzU2hvd24gJiYgdGhpcy5vcHRpb25zLmtleWJvYXJkKSB7DQogICAgICB0aGlzLiRlbGVtZW50Lm9uKCdrZXlkb3duLmRpc21pc3MuYnMubW9kYWwnLCAkLnByb3h5KGZ1bmN0aW9uIChlKSB7DQogICAgICAgIGUud2hpY2ggPT0gMjcgJiYgdGhpcy5oaWRlKCkNCiAgICAgIH0sIHRoaXMpKQ0KICAgIH0gZWxzZSBpZiAoIXRoaXMuaXNTaG93bikgew0KICAgICAgdGhpcy4kZWxlbWVudC5vZmYoJ2tleWRvd24uZGlzbWlzcy5icy5tb2RhbCcpDQogICAgfQ0KICB9DQoNCiAgTW9kYWwucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAodGhpcy5pc1Nob3duKSB7DQogICAgICAkKHdpbmRvdykub24oJ3Jlc2l6ZS5icy5tb2RhbCcsICQucHJveHkodGhpcy5oYW5kbGVVcGRhdGUsIHRoaXMpKQ0KICAgIH0gZWxzZSB7DQogICAgICAkKHdpbmRvdykub2ZmKCdyZXNpemUuYnMubW9kYWwnKQ0KICAgIH0NCiAgfQ0KDQogIE1vZGFsLnByb3RvdHlwZS5oaWRlTW9kYWwgPSBmdW5jdGlvbiAoKSB7DQogICAgdmFyIHRoYXQgPSB0aGlzDQogICAgdGhpcy4kZWxlbWVudC5oaWRlKCkNCiAgICB0aGlzLmJhY2tkcm9wKGZ1bmN0aW9uICgpIHsNCiAgICAgIHRoYXQuJGJvZHkucmVtb3ZlQ2xhc3MoJ21vZGFsLW9wZW4nKQ0KICAgICAgdGhhdC5yZXNldEFkanVzdG1lbnRzKCkNCiAgICAgIHRoYXQucmVzZXRTY3JvbGxiYXIoKQ0KICAgICAgdGhhdC4kZWxlbWVudC50cmlnZ2VyKCdoaWRkZW4uYnMubW9kYWwnKQ0KICAgIH0pDQogIH0NCg0KICBNb2RhbC5wcm90b3R5cGUucmVtb3ZlQmFja2Ryb3AgPSBmdW5jdGlvbiAoKSB7DQogICAgdGhpcy4kYmFja2Ryb3AgJiYgdGhpcy4kYmFja2Ryb3AucmVtb3ZlKCkNCiAgICB0aGlzLiRiYWNrZHJvcCA9IG51bGwNCiAgfQ0KDQogIE1vZGFsLnByb3RvdHlwZS5iYWNrZHJvcCA9IGZ1bmN0aW9uIChjYWxsYmFjaykgew0KICAgIHZhciB0aGF0ID0gdGhpcw0KICAgIHZhciBhbmltYXRlID0gdGhpcy4kZWxlbWVudC5oYXNDbGFzcygnZmFkZScpID8gJ2ZhZGUnIDogJycNCg0KICAgIGlmICh0aGlzLmlzU2hvd24gJiYgdGhpcy5vcHRpb25zLmJhY2tkcm9wKSB7DQogICAgICB2YXIgZG9BbmltYXRlID0gJC5zdXBwb3J0LnRyYW5zaXRpb24gJiYgYW5pbWF0ZQ0KDQogICAgICB0aGlzLiRiYWNrZHJvcCA9ICQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykpDQogICAgICAgIC5hZGRDbGFzcygnbW9kYWwtYmFja2Ryb3AgJyArIGFuaW1hdGUpDQogICAgICAgIC5hcHBlbmRUbyh0aGlzLiRib2R5KQ0KDQogICAgICB0aGlzLiRlbGVtZW50Lm9uKCdjbGljay5kaXNtaXNzLmJzLm1vZGFsJywgJC5wcm94eShmdW5jdGlvbiAoZSkgew0KICAgICAgICBpZiAodGhpcy5pZ25vcmVCYWNrZHJvcENsaWNrKSB7DQogICAgICAgICAgdGhpcy5pZ25vcmVCYWNrZHJvcENsaWNrID0gZmFsc2UNCiAgICAgICAgICByZXR1cm4NCiAgICAgICAgfQ0KICAgICAgICBpZiAoZS50YXJnZXQgIT09IGUuY3VycmVudFRhcmdldCkgcmV0dXJuDQogICAgICAgIHRoaXMub3B0aW9ucy5iYWNrZHJvcCA9PSAnc3RhdGljJw0KICAgICAgICAgID8gdGhpcy4kZWxlbWVudFswXS5mb2N1cygpDQogICAgICAgICAgOiB0aGlzLmhpZGUoKQ0KICAgICAgfSwgdGhpcykpDQoNCiAgICAgIGlmIChkb0FuaW1hdGUpIHRoaXMuJGJhY2tkcm9wWzBdLm9mZnNldFdpZHRoIC8vIGZvcmNlIHJlZmxvdw0KDQogICAgICB0aGlzLiRiYWNrZHJvcC5hZGRDbGFzcygnaW4nKQ0KDQogICAgICBpZiAoIWNhbGxiYWNrKSByZXR1cm4NCg0KICAgICAgZG9BbmltYXRlID8NCiAgICAgICAgdGhpcy4kYmFja2Ryb3ANCiAgICAgICAgICAub25lKCdic1RyYW5zaXRpb25FbmQnLCBjYWxsYmFjaykNCiAgICAgICAgICAuZW11bGF0ZVRyYW5zaXRpb25FbmQoTW9kYWwuQkFDS0RST1BfVFJBTlNJVElPTl9EVVJBVElPTikgOg0KICAgICAgICBjYWxsYmFjaygpDQoNCiAgICB9IGVsc2UgaWYgKCF0aGlzLmlzU2hvd24gJiYgdGhpcy4kYmFja2Ryb3ApIHsNCiAgICAgIHRoaXMuJGJhY2tkcm9wLnJlbW92ZUNsYXNzKCdpbicpDQoNCiAgICAgIHZhciBjYWxsYmFja1JlbW92ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhhdC5yZW1vdmVCYWNrZHJvcCgpDQogICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKCkNCiAgICAgIH0NCiAgICAgICQuc3VwcG9ydC50cmFuc2l0aW9uICYmIHRoaXMuJGVsZW1lbnQuaGFzQ2xhc3MoJ2ZhZGUnKSA/DQogICAgICAgIHRoaXMuJGJhY2tkcm9wDQogICAgICAgICAgLm9uZSgnYnNUcmFuc2l0aW9uRW5kJywgY2FsbGJhY2tSZW1vdmUpDQogICAgICAgICAgLmVtdWxhdGVUcmFuc2l0aW9uRW5kKE1vZGFsLkJBQ0tEUk9QX1RSQU5TSVRJT05fRFVSQVRJT04pIDoNCiAgICAgICAgY2FsbGJhY2tSZW1vdmUoKQ0KDQogICAgfSBlbHNlIGlmIChjYWxsYmFjaykgew0KICAgICAgY2FsbGJhY2soKQ0KICAgIH0NCiAgfQ0KDQogIC8vIHRoZXNlIGZvbGxvd2luZyBtZXRob2RzIGFyZSB1c2VkIHRvIGhhbmRsZSBvdmVyZmxvd2luZyBtb2RhbHMNCg0KICBNb2RhbC5wcm90b3R5cGUuaGFuZGxlVXBkYXRlID0gZnVuY3Rpb24gKCkgew0KICAgIHRoaXMuYWRqdXN0RGlhbG9nKCkNCiAgfQ0KDQogIE1vZGFsLnByb3RvdHlwZS5hZGp1c3REaWFsb2cgPSBmdW5jdGlvbiAoKSB7DQogICAgdmFyIG1vZGFsSXNPdmVyZmxvd2luZyA9IHRoaXMuJGVsZW1lbnRbMF0uc2Nyb2xsSGVpZ2h0ID4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodA0KDQogICAgdGhpcy4kZWxlbWVudC5jc3Moew0KICAgICAgcGFkZGluZ0xlZnQ6ICAhdGhpcy5ib2R5SXNPdmVyZmxvd2luZyAmJiBtb2RhbElzT3ZlcmZsb3dpbmcgPyB0aGlzLnNjcm9sbGJhcldpZHRoIDogJycsDQogICAgICBwYWRkaW5nUmlnaHQ6IHRoaXMuYm9keUlzT3ZlcmZsb3dpbmcgJiYgIW1vZGFsSXNPdmVyZmxvd2luZyA/IHRoaXMuc2Nyb2xsYmFyV2lkdGggOiAnJw0KICAgIH0pDQogIH0NCg0KICBNb2RhbC5wcm90b3R5cGUucmVzZXRBZGp1c3RtZW50cyA9IGZ1bmN0aW9uICgpIHsNCiAgICB0aGlzLiRlbGVtZW50LmNzcyh7DQogICAgICBwYWRkaW5nTGVmdDogJycsDQogICAgICBwYWRkaW5nUmlnaHQ6ICcnDQogICAgfSkNCiAgfQ0KDQogIE1vZGFsLnByb3RvdHlwZS5jaGVja1Njcm9sbGJhciA9IGZ1bmN0aW9uICgpIHsNCiAgICB2YXIgZnVsbFdpbmRvd1dpZHRoID0gd2luZG93LmlubmVyV2lkdGgNCiAgICBpZiAoIWZ1bGxXaW5kb3dXaWR0aCkgeyAvLyB3b3JrYXJvdW5kIGZvciBtaXNzaW5nIHdpbmRvdy5pbm5lcldpZHRoIGluIElFOA0KICAgICAgdmFyIGRvY3VtZW50RWxlbWVudFJlY3QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkNCiAgICAgIGZ1bGxXaW5kb3dXaWR0aCA9IGRvY3VtZW50RWxlbWVudFJlY3QucmlnaHQgLSBNYXRoLmFicyhkb2N1bWVudEVsZW1lbnRSZWN0LmxlZnQpDQogICAgfQ0KICAgIHRoaXMuYm9keUlzT3ZlcmZsb3dpbmcgPSBkb2N1bWVudC5ib2R5LmNsaWVudFdpZHRoIDwgZnVsbFdpbmRvd1dpZHRoDQogICAgdGhpcy5zY3JvbGxiYXJXaWR0aCA9IHRoaXMubWVhc3VyZVNjcm9sbGJhcigpDQogIH0NCg0KICBNb2RhbC5wcm90b3R5cGUuc2V0U2Nyb2xsYmFyID0gZnVuY3Rpb24gKCkgew0KICAgIHZhciBib2R5UGFkID0gcGFyc2VJbnQoKHRoaXMuJGJvZHkuY3NzKCdwYWRkaW5nLXJpZ2h0JykgfHwgMCksIDEwKQ0KICAgIHRoaXMub3JpZ2luYWxCb2R5UGFkID0gZG9jdW1lbnQuYm9keS5zdHlsZS5wYWRkaW5nUmlnaHQgfHwgJycNCiAgICBpZiAodGhpcy5ib2R5SXNPdmVyZmxvd2luZykgdGhpcy4kYm9keS5jc3MoJ3BhZGRpbmctcmlnaHQnLCBib2R5UGFkICsgdGhpcy5zY3JvbGxiYXJXaWR0aCkNCiAgfQ0KDQogIE1vZGFsLnByb3RvdHlwZS5yZXNldFNjcm9sbGJhciA9IGZ1bmN0aW9uICgpIHsNCiAgICB0aGlzLiRib2R5LmNzcygncGFkZGluZy1yaWdodCcsIHRoaXMub3JpZ2luYWxCb2R5UGFkKQ0KICB9DQoNCiAgTW9kYWwucHJvdG90eXBlLm1lYXN1cmVTY3JvbGxiYXIgPSBmdW5jdGlvbiAoKSB7IC8vIHRoeCB3YWxzaA0KICAgIHZhciBzY3JvbGxEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKQ0KICAgIHNjcm9sbERpdi5jbGFzc05hbWUgPSAnbW9kYWwtc2Nyb2xsYmFyLW1lYXN1cmUnDQogICAgdGhpcy4kYm9keS5hcHBlbmQoc2Nyb2xsRGl2KQ0KICAgIHZhciBzY3JvbGxiYXJXaWR0aCA9IHNjcm9sbERpdi5vZmZzZXRXaWR0aCAtIHNjcm9sbERpdi5jbGllbnRXaWR0aA0KICAgIHRoaXMuJGJvZHlbMF0ucmVtb3ZlQ2hpbGQoc2Nyb2xsRGl2KQ0KICAgIHJldHVybiBzY3JvbGxiYXJXaWR0aA0KICB9DQoNCg0KICAvLyBNT0RBTCBQTFVHSU4gREVGSU5JVElPTg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PQ0KDQogIGZ1bmN0aW9uIFBsdWdpbihvcHRpb24sIF9yZWxhdGVkVGFyZ2V0KSB7DQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICB2YXIgJHRoaXMgICA9ICQodGhpcykNCiAgICAgIHZhciBkYXRhICAgID0gJHRoaXMuZGF0YSgnYnMubW9kYWwnKQ0KICAgICAgdmFyIG9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgTW9kYWwuREVGQVVMVFMsICR0aGlzLmRhdGEoKSwgdHlwZW9mIG9wdGlvbiA9PSAnb2JqZWN0JyAmJiBvcHRpb24pDQoNCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnYnMubW9kYWwnLCAoZGF0YSA9IG5ldyBNb2RhbCh0aGlzLCBvcHRpb25zKSkpDQogICAgICBpZiAodHlwZW9mIG9wdGlvbiA9PSAnc3RyaW5nJykgZGF0YVtvcHRpb25dKF9yZWxhdGVkVGFyZ2V0KQ0KICAgICAgZWxzZSBpZiAob3B0aW9ucy5zaG93KSBkYXRhLnNob3coX3JlbGF0ZWRUYXJnZXQpDQogICAgfSkNCiAgfQ0KDQogIHZhciBvbGQgPSAkLmZuLm1vZGFsDQoNCiAgJC5mbi5tb2RhbCAgICAgICAgICAgICA9IFBsdWdpbg0KICAkLmZuLm1vZGFsLkNvbnN0cnVjdG9yID0gTW9kYWwNCg0KDQogIC8vIE1PREFMIE5PIENPTkZMSUNUDQogIC8vID09PT09PT09PT09PT09PT09DQoNCiAgJC5mbi5tb2RhbC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgew0KICAgICQuZm4ubW9kYWwgPSBvbGQNCiAgICByZXR1cm4gdGhpcw0KICB9DQoNCg0KICAvLyBNT0RBTCBEQVRBLUFQSQ0KICAvLyA9PT09PT09PT09PT09PQ0KDQogICQoZG9jdW1lbnQpLm9uKCdjbGljay5icy5tb2RhbC5kYXRhLWFwaScsICdbZGF0YS10b2dnbGU9Im1vZGFsIl0nLCBmdW5jdGlvbiAoZSkgew0KICAgIHZhciAkdGhpcyAgID0gJCh0aGlzKQ0KICAgIHZhciBocmVmICAgID0gJHRoaXMuYXR0cignaHJlZicpDQogICAgdmFyICR0YXJnZXQgPSAkKCR0aGlzLmF0dHIoJ2RhdGEtdGFyZ2V0JykgfHwgKGhyZWYgJiYgaHJlZi5yZXBsYWNlKC8uKig/PSNbXlxzXSskKS8sICcnKSkpIC8vIHN0cmlwIGZvciBpZTcNCiAgICB2YXIgb3B0aW9uICA9ICR0YXJnZXQuZGF0YSgnYnMubW9kYWwnKSA/ICd0b2dnbGUnIDogJC5leHRlbmQoeyByZW1vdGU6ICEvIy8udGVzdChocmVmKSAmJiBocmVmIH0sICR0YXJnZXQuZGF0YSgpLCAkdGhpcy5kYXRhKCkpDQoNCiAgICBpZiAoJHRoaXMuaXMoJ2EnKSkgZS5wcmV2ZW50RGVmYXVsdCgpDQoNCiAgICAkdGFyZ2V0Lm9uZSgnc2hvdy5icy5tb2RhbCcsIGZ1bmN0aW9uIChzaG93RXZlbnQpIHsNCiAgICAgIGlmIChzaG93RXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHJldHVybiAvLyBvbmx5IHJlZ2lzdGVyIGZvY3VzIHJlc3RvcmVyIGlmIG1vZGFsIHdpbGwgYWN0dWFsbHkgZ2V0IHNob3duDQogICAgICAkdGFyZ2V0Lm9uZSgnaGlkZGVuLmJzLm1vZGFsJywgZnVuY3Rpb24gKCkgew0KICAgICAgICAkdGhpcy5pcygnOnZpc2libGUnKSAmJiAkdGhpcy50cmlnZ2VyKCdmb2N1cycpDQogICAgICB9KQ0KICAgIH0pDQogICAgUGx1Z2luLmNhbGwoJHRhcmdldCwgb3B0aW9uLCB0aGlzKQ0KICB9KQ0KDQp9KGpRdWVyeSk7DQoNCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICogQm9vdHN0cmFwOiB0b29sdGlwLmpzIHYzLjMuNw0KICogaHR0cDovL2dldGJvb3RzdHJhcC5jb20vamF2YXNjcmlwdC8jdG9vbHRpcA0KICogSW5zcGlyZWQgYnkgdGhlIG9yaWdpbmFsIGpRdWVyeS50aXBzeSBieSBKYXNvbiBGcmFtZQ0KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogKiBDb3B5cmlnaHQgMjAxMS0yMDE2IFR3aXR0ZXIsIEluYy4NCiAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpDQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8NCg0KDQorZnVuY3Rpb24gKCQpIHsNCiAgJ3VzZSBzdHJpY3QnOw0KDQogIC8vIFRPT0xUSVAgUFVCTElDIENMQVNTIERFRklOSVRJT04NCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQogIHZhciBUb29sdGlwID0gZnVuY3Rpb24gKGVsZW1lbnQsIG9wdGlvbnMpIHsNCiAgICB0aGlzLnR5cGUgICAgICAgPSBudWxsDQogICAgdGhpcy5vcHRpb25zICAgID0gbnVsbA0KICAgIHRoaXMuZW5hYmxlZCAgICA9IG51bGwNCiAgICB0aGlzLnRpbWVvdXQgICAgPSBudWxsDQogICAgdGhpcy5ob3ZlclN0YXRlID0gbnVsbA0KICAgIHRoaXMuJGVsZW1lbnQgICA9IG51bGwNCiAgICB0aGlzLmluU3RhdGUgICAgPSBudWxsDQoNCiAgICB0aGlzLmluaXQoJ3Rvb2x0aXAnLCBlbGVtZW50LCBvcHRpb25zKQ0KICB9DQoNCiAgVG9vbHRpcC5WRVJTSU9OICA9ICczLjMuNycNCg0KICBUb29sdGlwLlRSQU5TSVRJT05fRFVSQVRJT04gPSAxNTANCg0KICBUb29sdGlwLkRFRkFVTFRTID0gew0KICAgIGFuaW1hdGlvbjogdHJ1ZSwNCiAgICBwbGFjZW1lbnQ6ICd0b3AnLA0KICAgIHNlbGVjdG9yOiBmYWxzZSwNCiAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9InRvb2x0aXAiIHJvbGU9InRvb2x0aXAiPjxkaXYgY2xhc3M9InRvb2x0aXAtYXJyb3ciPjwvZGl2PjxkaXYgY2xhc3M9InRvb2x0aXAtaW5uZXIiPjwvZGl2PjwvZGl2PicsDQogICAgdHJpZ2dlcjogJ2hvdmVyIGZvY3VzJywNCiAgICB0aXRsZTogJycsDQogICAgZGVsYXk6IDAsDQogICAgaHRtbDogZmFsc2UsDQogICAgY29udGFpbmVyOiBmYWxzZSwNCiAgICB2aWV3cG9ydDogew0KICAgICAgc2VsZWN0b3I6ICdib2R5JywNCiAgICAgIHBhZGRpbmc6IDANCiAgICB9DQogIH0NCg0KICBUb29sdGlwLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKHR5cGUsIGVsZW1lbnQsIG9wdGlvbnMpIHsNCiAgICB0aGlzLmVuYWJsZWQgICA9IHRydWUNCiAgICB0aGlzLnR5cGUgICAgICA9IHR5cGUNCiAgICB0aGlzLiRlbGVtZW50ICA9ICQoZWxlbWVudCkNCiAgICB0aGlzLm9wdGlvbnMgICA9IHRoaXMuZ2V0T3B0aW9ucyhvcHRpb25zKQ0KICAgIHRoaXMuJHZpZXdwb3J0ID0gdGhpcy5vcHRpb25zLnZpZXdwb3J0ICYmICQoJC5pc0Z1bmN0aW9uKHRoaXMub3B0aW9ucy52aWV3cG9ydCkgPyB0aGlzLm9wdGlvbnMudmlld3BvcnQuY2FsbCh0aGlzLCB0aGlzLiRlbGVtZW50KSA6ICh0aGlzLm9wdGlvbnMudmlld3BvcnQuc2VsZWN0b3IgfHwgdGhpcy5vcHRpb25zLnZpZXdwb3J0KSkNCiAgICB0aGlzLmluU3RhdGUgICA9IHsgY2xpY2s6IGZhbHNlLCBob3ZlcjogZmFsc2UsIGZvY3VzOiBmYWxzZSB9DQoNCiAgICBpZiAodGhpcy4kZWxlbWVudFswXSBpbnN0YW5jZW9mIGRvY3VtZW50LmNvbnN0cnVjdG9yICYmICF0aGlzLm9wdGlvbnMuc2VsZWN0b3IpIHsNCiAgICAgIHRocm93IG5ldyBFcnJvcignYHNlbGVjdG9yYCBvcHRpb24gbXVzdCBiZSBzcGVjaWZpZWQgd2hlbiBpbml0aWFsaXppbmcgJyArIHRoaXMudHlwZSArICcgb24gdGhlIHdpbmRvdy5kb2N1bWVudCBvYmplY3QhJykNCiAgICB9DQoNCiAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLm9wdGlvbnMudHJpZ2dlci5zcGxpdCgnICcpDQoNCiAgICBmb3IgKHZhciBpID0gdHJpZ2dlcnMubGVuZ3RoOyBpLS07KSB7DQogICAgICB2YXIgdHJpZ2dlciA9IHRyaWdnZXJzW2ldDQoNCiAgICAgIGlmICh0cmlnZ2VyID09ICdjbGljaycpIHsNCiAgICAgICAgdGhpcy4kZWxlbWVudC5vbignY2xpY2suJyArIHRoaXMudHlwZSwgdGhpcy5vcHRpb25zLnNlbGVjdG9yLCAkLnByb3h5KHRoaXMudG9nZ2xlLCB0aGlzKSkNCiAgICAgIH0gZWxzZSBpZiAodHJpZ2dlciAhPSAnbWFudWFsJykgew0KICAgICAgICB2YXIgZXZlbnRJbiAgPSB0cmlnZ2VyID09ICdob3ZlcicgPyAnbW91c2VlbnRlcicgOiAnZm9jdXNpbicNCiAgICAgICAgdmFyIGV2ZW50T3V0ID0gdHJpZ2dlciA9PSAnaG92ZXInID8gJ21vdXNlbGVhdmUnIDogJ2ZvY3Vzb3V0Jw0KDQogICAgICAgIHRoaXMuJGVsZW1lbnQub24oZXZlbnRJbiAgKyAnLicgKyB0aGlzLnR5cGUsIHRoaXMub3B0aW9ucy5zZWxlY3RvciwgJC5wcm94eSh0aGlzLmVudGVyLCB0aGlzKSkNCiAgICAgICAgdGhpcy4kZWxlbWVudC5vbihldmVudE91dCArICcuJyArIHRoaXMudHlwZSwgdGhpcy5vcHRpb25zLnNlbGVjdG9yLCAkLnByb3h5KHRoaXMubGVhdmUsIHRoaXMpKQ0KICAgICAgfQ0KICAgIH0NCg0KICAgIHRoaXMub3B0aW9ucy5zZWxlY3RvciA/DQogICAgICAodGhpcy5fb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCB0aGlzLm9wdGlvbnMsIHsgdHJpZ2dlcjogJ21hbnVhbCcsIHNlbGVjdG9yOiAnJyB9KSkgOg0KICAgICAgdGhpcy5maXhUaXRsZSgpDQogIH0NCg0KICBUb29sdGlwLnByb3RvdHlwZS5nZXREZWZhdWx0cyA9IGZ1bmN0aW9uICgpIHsNCiAgICByZXR1cm4gVG9vbHRpcC5ERUZBVUxUUw0KICB9DQoNCiAgVG9vbHRpcC5wcm90b3R5cGUuZ2V0T3B0aW9ucyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7DQogICAgb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCB0aGlzLmdldERlZmF1bHRzKCksIHRoaXMuJGVsZW1lbnQuZGF0YSgpLCBvcHRpb25zKQ0KDQogICAgaWYgKG9wdGlvbnMuZGVsYXkgJiYgdHlwZW9mIG9wdGlvbnMuZGVsYXkgPT0gJ251bWJlcicpIHsNCiAgICAgIG9wdGlvbnMuZGVsYXkgPSB7DQogICAgICAgIHNob3c6IG9wdGlvbnMuZGVsYXksDQogICAgICAgIGhpZGU6IG9wdGlvbnMuZGVsYXkNCiAgICAgIH0NCiAgICB9DQoNCiAgICByZXR1cm4gb3B0aW9ucw0KICB9DQoNCiAgVG9vbHRpcC5wcm90b3R5cGUuZ2V0RGVsZWdhdGVPcHRpb25zID0gZnVuY3Rpb24gKCkgew0KICAgIHZhciBvcHRpb25zICA9IHt9DQogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5nZXREZWZhdWx0cygpDQoNCiAgICB0aGlzLl9vcHRpb25zICYmICQuZWFjaCh0aGlzLl9vcHRpb25zLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgew0KICAgICAgaWYgKGRlZmF1bHRzW2tleV0gIT0gdmFsdWUpIG9wdGlvbnNba2V5XSA9IHZhbHVlDQogICAgfSkNCg0KICAgIHJldHVybiBvcHRpb25zDQogIH0NCg0KICBUb29sdGlwLnByb3RvdHlwZS5lbnRlciA9IGZ1bmN0aW9uIChvYmopIHsNCiAgICB2YXIgc2VsZiA9IG9iaiBpbnN0YW5jZW9mIHRoaXMuY29uc3RydWN0b3IgPw0KICAgICAgb2JqIDogJChvYmouY3VycmVudFRhcmdldCkuZGF0YSgnYnMuJyArIHRoaXMudHlwZSkNCg0KICAgIGlmICghc2VsZikgew0KICAgICAgc2VsZiA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKG9iai5jdXJyZW50VGFyZ2V0LCB0aGlzLmdldERlbGVnYXRlT3B0aW9ucygpKQ0KICAgICAgJChvYmouY3VycmVudFRhcmdldCkuZGF0YSgnYnMuJyArIHRoaXMudHlwZSwgc2VsZikNCiAgICB9DQoNCiAgICBpZiAob2JqIGluc3RhbmNlb2YgJC5FdmVudCkgew0KICAgICAgc2VsZi5pblN0YXRlW29iai50eXBlID09ICdmb2N1c2luJyA/ICdmb2N1cycgOiAnaG92ZXInXSA9IHRydWUNCiAgICB9DQoNCiAgICBpZiAoc2VsZi50aXAoKS5oYXNDbGFzcygnaW4nKSB8fCBzZWxmLmhvdmVyU3RhdGUgPT0gJ2luJykgew0KICAgICAgc2VsZi5ob3ZlclN0YXRlID0gJ2luJw0KICAgICAgcmV0dXJuDQogICAgfQ0KDQogICAgY2xlYXJUaW1lb3V0KHNlbGYudGltZW91dCkNCg0KICAgIHNlbGYuaG92ZXJTdGF0ZSA9ICdpbicNCg0KICAgIGlmICghc2VsZi5vcHRpb25zLmRlbGF5IHx8ICFzZWxmLm9wdGlvbnMuZGVsYXkuc2hvdykgcmV0dXJuIHNlbGYuc2hvdygpDQoNCiAgICBzZWxmLnRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgIGlmIChzZWxmLmhvdmVyU3RhdGUgPT0gJ2luJykgc2VsZi5zaG93KCkNCiAgICB9LCBzZWxmLm9wdGlvbnMuZGVsYXkuc2hvdykNCiAgfQ0KDQogIFRvb2x0aXAucHJvdG90eXBlLmlzSW5TdGF0ZVRydWUgPSBmdW5jdGlvbiAoKSB7DQogICAgZm9yICh2YXIga2V5IGluIHRoaXMuaW5TdGF0ZSkgew0KICAgICAgaWYgKHRoaXMuaW5TdGF0ZVtrZXldKSByZXR1cm4gdHJ1ZQ0KICAgIH0NCg0KICAgIHJldHVybiBmYWxzZQ0KICB9DQoNCiAgVG9vbHRpcC5wcm90b3R5cGUubGVhdmUgPSBmdW5jdGlvbiAob2JqKSB7DQogICAgdmFyIHNlbGYgPSBvYmogaW5zdGFuY2VvZiB0aGlzLmNvbnN0cnVjdG9yID8NCiAgICAgIG9iaiA6ICQob2JqLmN1cnJlbnRUYXJnZXQpLmRhdGEoJ2JzLicgKyB0aGlzLnR5cGUpDQoNCiAgICBpZiAoIXNlbGYpIHsNCiAgICAgIHNlbGYgPSBuZXcgdGhpcy5jb25zdHJ1Y3RvcihvYmouY3VycmVudFRhcmdldCwgdGhpcy5nZXREZWxlZ2F0ZU9wdGlvbnMoKSkNCiAgICAgICQob2JqLmN1cnJlbnRUYXJnZXQpLmRhdGEoJ2JzLicgKyB0aGlzLnR5cGUsIHNlbGYpDQogICAgfQ0KDQogICAgaWYgKG9iaiBpbnN0YW5jZW9mICQuRXZlbnQpIHsNCiAgICAgIHNlbGYuaW5TdGF0ZVtvYmoudHlwZSA9PSAnZm9jdXNvdXQnID8gJ2ZvY3VzJyA6ICdob3ZlciddID0gZmFsc2UNCiAgICB9DQoNCiAgICBpZiAoc2VsZi5pc0luU3RhdGVUcnVlKCkpIHJldHVybg0KDQogICAgY2xlYXJUaW1lb3V0KHNlbGYudGltZW91dCkNCg0KICAgIHNlbGYuaG92ZXJTdGF0ZSA9ICdvdXQnDQoNCiAgICBpZiAoIXNlbGYub3B0aW9ucy5kZWxheSB8fCAhc2VsZi5vcHRpb25zLmRlbGF5LmhpZGUpIHJldHVybiBzZWxmLmhpZGUoKQ0KDQogICAgc2VsZi50aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7DQogICAgICBpZiAoc2VsZi5ob3ZlclN0YXRlID09ICdvdXQnKSBzZWxmLmhpZGUoKQ0KICAgIH0sIHNlbGYub3B0aW9ucy5kZWxheS5oaWRlKQ0KICB9DQoNCiAgVG9vbHRpcC5wcm90b3R5cGUuc2hvdyA9IGZ1bmN0aW9uICgpIHsNCiAgICB2YXIgZSA9ICQuRXZlbnQoJ3Nob3cuYnMuJyArIHRoaXMudHlwZSkNCg0KICAgIGlmICh0aGlzLmhhc0NvbnRlbnQoKSAmJiB0aGlzLmVuYWJsZWQpIHsNCiAgICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlcihlKQ0KDQogICAgICB2YXIgaW5Eb20gPSAkLmNvbnRhaW5zKHRoaXMuJGVsZW1lbnRbMF0ub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIHRoaXMuJGVsZW1lbnRbMF0pDQogICAgICBpZiAoZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fCAhaW5Eb20pIHJldHVybg0KICAgICAgdmFyIHRoYXQgPSB0aGlzDQoNCiAgICAgIHZhciAkdGlwID0gdGhpcy50aXAoKQ0KDQogICAgICB2YXIgdGlwSWQgPSB0aGlzLmdldFVJRCh0aGlzLnR5cGUpDQoNCiAgICAgIHRoaXMuc2V0Q29udGVudCgpDQogICAgICAkdGlwLmF0dHIoJ2lkJywgdGlwSWQpDQogICAgICB0aGlzLiRlbGVtZW50LmF0dHIoJ2FyaWEtZGVzY3JpYmVkYnknLCB0aXBJZCkNCg0KICAgICAgaWYgKHRoaXMub3B0aW9ucy5hbmltYXRpb24pICR0aXAuYWRkQ2xhc3MoJ2ZhZGUnKQ0KDQogICAgICB2YXIgcGxhY2VtZW50ID0gdHlwZW9mIHRoaXMub3B0aW9ucy5wbGFjZW1lbnQgPT0gJ2Z1bmN0aW9uJyA/DQogICAgICAgIHRoaXMub3B0aW9ucy5wbGFjZW1lbnQuY2FsbCh0aGlzLCAkdGlwWzBdLCB0aGlzLiRlbGVtZW50WzBdKSA6DQogICAgICAgIHRoaXMub3B0aW9ucy5wbGFjZW1lbnQNCg0KICAgICAgdmFyIGF1dG9Ub2tlbiA9IC9ccz9hdXRvP1xzPy9pDQogICAgICB2YXIgYXV0b1BsYWNlID0gYXV0b1Rva2VuLnRlc3QocGxhY2VtZW50KQ0KICAgICAgaWYgKGF1dG9QbGFjZSkgcGxhY2VtZW50ID0gcGxhY2VtZW50LnJlcGxhY2UoYXV0b1Rva2VuLCAnJykgfHwgJ3RvcCcNCg0KICAgICAgJHRpcA0KICAgICAgICAuZGV0YWNoKCkNCiAgICAgICAgLmNzcyh7IHRvcDogMCwgbGVmdDogMCwgZGlzcGxheTogJ2Jsb2NrJyB9KQ0KICAgICAgICAuYWRkQ2xhc3MocGxhY2VtZW50KQ0KICAgICAgICAuZGF0YSgnYnMuJyArIHRoaXMudHlwZSwgdGhpcykNCg0KICAgICAgdGhpcy5vcHRpb25zLmNvbnRhaW5lciA/ICR0aXAuYXBwZW5kVG8odGhpcy5vcHRpb25zLmNvbnRhaW5lcikgOiAkdGlwLmluc2VydEFmdGVyKHRoaXMuJGVsZW1lbnQpDQogICAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXIoJ2luc2VydGVkLmJzLicgKyB0aGlzLnR5cGUpDQoNCiAgICAgIHZhciBwb3MgICAgICAgICAgPSB0aGlzLmdldFBvc2l0aW9uKCkNCiAgICAgIHZhciBhY3R1YWxXaWR0aCAgPSAkdGlwWzBdLm9mZnNldFdpZHRoDQogICAgICB2YXIgYWN0dWFsSGVpZ2h0ID0gJHRpcFswXS5vZmZzZXRIZWlnaHQNCg0KICAgICAgaWYgKGF1dG9QbGFjZSkgew0KICAgICAgICB2YXIgb3JnUGxhY2VtZW50ID0gcGxhY2VtZW50DQogICAgICAgIHZhciB2aWV3cG9ydERpbSA9IHRoaXMuZ2V0UG9zaXRpb24odGhpcy4kdmlld3BvcnQpDQoNCiAgICAgICAgcGxhY2VtZW50ID0gcGxhY2VtZW50ID09ICdib3R0b20nICYmIHBvcy5ib3R0b20gKyBhY3R1YWxIZWlnaHQgPiB2aWV3cG9ydERpbS5ib3R0b20gPyAndG9wJyAgICA6DQogICAgICAgICAgICAgICAgICAgIHBsYWNlbWVudCA9PSAndG9wJyAgICAmJiBwb3MudG9wICAgIC0gYWN0dWFsSGVpZ2h0IDwgdmlld3BvcnREaW0udG9wICAgID8gJ2JvdHRvbScgOg0KICAgICAgICAgICAgICAgICAgICBwbGFjZW1lbnQgPT0gJ3JpZ2h0JyAgJiYgcG9zLnJpZ2h0ICArIGFjdHVhbFdpZHRoICA+IHZpZXdwb3J0RGltLndpZHRoICA/ICdsZWZ0JyAgIDoNCiAgICAgICAgICAgICAgICAgICAgcGxhY2VtZW50ID09ICdsZWZ0JyAgICYmIHBvcy5sZWZ0ICAgLSBhY3R1YWxXaWR0aCAgPCB2aWV3cG9ydERpbS5sZWZ0ICAgPyAncmlnaHQnICA6DQogICAgICAgICAgICAgICAgICAgIHBsYWNlbWVudA0KDQogICAgICAgICR0aXANCiAgICAgICAgICAucmVtb3ZlQ2xhc3Mob3JnUGxhY2VtZW50KQ0KICAgICAgICAgIC5hZGRDbGFzcyhwbGFjZW1lbnQpDQogICAgICB9DQoNCiAgICAgIHZhciBjYWxjdWxhdGVkT2Zmc2V0ID0gdGhpcy5nZXRDYWxjdWxhdGVkT2Zmc2V0KHBsYWNlbWVudCwgcG9zLCBhY3R1YWxXaWR0aCwgYWN0dWFsSGVpZ2h0KQ0KDQogICAgICB0aGlzLmFwcGx5UGxhY2VtZW50KGNhbGN1bGF0ZWRPZmZzZXQsIHBsYWNlbWVudCkNCg0KICAgICAgdmFyIGNvbXBsZXRlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgcHJldkhvdmVyU3RhdGUgPSB0aGF0LmhvdmVyU3RhdGUNCiAgICAgICAgdGhhdC4kZWxlbWVudC50cmlnZ2VyKCdzaG93bi5icy4nICsgdGhhdC50eXBlKQ0KICAgICAgICB0aGF0LmhvdmVyU3RhdGUgPSBudWxsDQoNCiAgICAgICAgaWYgKHByZXZIb3ZlclN0YXRlID09ICdvdXQnKSB0aGF0LmxlYXZlKHRoYXQpDQogICAgICB9DQoNCiAgICAgICQuc3VwcG9ydC50cmFuc2l0aW9uICYmIHRoaXMuJHRpcC5oYXNDbGFzcygnZmFkZScpID8NCiAgICAgICAgJHRpcA0KICAgICAgICAgIC5vbmUoJ2JzVHJhbnNpdGlvbkVuZCcsIGNvbXBsZXRlKQ0KICAgICAgICAgIC5lbXVsYXRlVHJhbnNpdGlvbkVuZChUb29sdGlwLlRSQU5TSVRJT05fRFVSQVRJT04pIDoNCiAgICAgICAgY29tcGxldGUoKQ0KICAgIH0NCiAgfQ0KDQogIFRvb2x0aXAucHJvdG90eXBlLmFwcGx5UGxhY2VtZW50ID0gZnVuY3Rpb24gKG9mZnNldCwgcGxhY2VtZW50KSB7DQogICAgdmFyICR0aXAgICA9IHRoaXMudGlwKCkNCiAgICB2YXIgd2lkdGggID0gJHRpcFswXS5vZmZzZXRXaWR0aA0KICAgIHZhciBoZWlnaHQgPSAkdGlwWzBdLm9mZnNldEhlaWdodA0KDQogICAgLy8gbWFudWFsbHkgcmVhZCBtYXJnaW5zIGJlY2F1c2UgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGluY2x1ZGVzIGRpZmZlcmVuY2UNCiAgICB2YXIgbWFyZ2luVG9wID0gcGFyc2VJbnQoJHRpcC5jc3MoJ21hcmdpbi10b3AnKSwgMTApDQogICAgdmFyIG1hcmdpbkxlZnQgPSBwYXJzZUludCgkdGlwLmNzcygnbWFyZ2luLWxlZnQnKSwgMTApDQoNCiAgICAvLyB3ZSBtdXN0IGNoZWNrIGZvciBOYU4gZm9yIGllIDgvOQ0KICAgIGlmIChpc05hTihtYXJnaW5Ub3ApKSAgbWFyZ2luVG9wICA9IDANCiAgICBpZiAoaXNOYU4obWFyZ2luTGVmdCkpIG1hcmdpbkxlZnQgPSAwDQoNCiAgICBvZmZzZXQudG9wICArPSBtYXJnaW5Ub3ANCiAgICBvZmZzZXQubGVmdCArPSBtYXJnaW5MZWZ0DQoNCiAgICAvLyAkLmZuLm9mZnNldCBkb2Vzbid0IHJvdW5kIHBpeGVsIHZhbHVlcw0KICAgIC8vIHNvIHdlIHVzZSBzZXRPZmZzZXQgZGlyZWN0bHkgd2l0aCBvdXIgb3duIGZ1bmN0aW9uIEItMA0KICAgICQub2Zmc2V0LnNldE9mZnNldCgkdGlwWzBdLCAkLmV4dGVuZCh7DQogICAgICB1c2luZzogZnVuY3Rpb24gKHByb3BzKSB7DQogICAgICAgICR0aXAuY3NzKHsNCiAgICAgICAgICB0b3A6IE1hdGgucm91bmQocHJvcHMudG9wKSwNCiAgICAgICAgICBsZWZ0OiBNYXRoLnJvdW5kKHByb3BzLmxlZnQpDQogICAgICAgIH0pDQogICAgICB9DQogICAgfSwgb2Zmc2V0KSwgMCkNCg0KICAgICR0aXAuYWRkQ2xhc3MoJ2luJykNCg0KICAgIC8vIGNoZWNrIHRvIHNlZSBpZiBwbGFjaW5nIHRpcCBpbiBuZXcgb2Zmc2V0IGNhdXNlZCB0aGUgdGlwIHRvIHJlc2l6ZSBpdHNlbGYNCiAgICB2YXIgYWN0dWFsV2lkdGggID0gJHRpcFswXS5vZmZzZXRXaWR0aA0KICAgIHZhciBhY3R1YWxIZWlnaHQgPSAkdGlwWzBdLm9mZnNldEhlaWdodA0KDQogICAgaWYgKHBsYWNlbWVudCA9PSAndG9wJyAmJiBhY3R1YWxIZWlnaHQgIT0gaGVpZ2h0KSB7DQogICAgICBvZmZzZXQudG9wID0gb2Zmc2V0LnRvcCArIGhlaWdodCAtIGFjdHVhbEhlaWdodA0KICAgIH0NCg0KICAgIHZhciBkZWx0YSA9IHRoaXMuZ2V0Vmlld3BvcnRBZGp1c3RlZERlbHRhKHBsYWNlbWVudCwgb2Zmc2V0LCBhY3R1YWxXaWR0aCwgYWN0dWFsSGVpZ2h0KQ0KDQogICAgaWYgKGRlbHRhLmxlZnQpIG9mZnNldC5sZWZ0ICs9IGRlbHRhLmxlZnQNCiAgICBlbHNlIG9mZnNldC50b3AgKz0gZGVsdGEudG9wDQoNCiAgICB2YXIgaXNWZXJ0aWNhbCAgICAgICAgICA9IC90b3B8Ym90dG9tLy50ZXN0KHBsYWNlbWVudCkNCiAgICB2YXIgYXJyb3dEZWx0YSAgICAgICAgICA9IGlzVmVydGljYWwgPyBkZWx0YS5sZWZ0ICogMiAtIHdpZHRoICsgYWN0dWFsV2lkdGggOiBkZWx0YS50b3AgKiAyIC0gaGVpZ2h0ICsgYWN0dWFsSGVpZ2h0DQogICAgdmFyIGFycm93T2Zmc2V0UG9zaXRpb24gPSBpc1ZlcnRpY2FsID8gJ29mZnNldFdpZHRoJyA6ICdvZmZzZXRIZWlnaHQnDQoNCiAgICAkdGlwLm9mZnNldChvZmZzZXQpDQogICAgdGhpcy5yZXBsYWNlQXJyb3coYXJyb3dEZWx0YSwgJHRpcFswXVthcnJvd09mZnNldFBvc2l0aW9uXSwgaXNWZXJ0aWNhbCkNCiAgfQ0KDQogIFRvb2x0aXAucHJvdG90eXBlLnJlcGxhY2VBcnJvdyA9IGZ1bmN0aW9uIChkZWx0YSwgZGltZW5zaW9uLCBpc1ZlcnRpY2FsKSB7DQogICAgdGhpcy5hcnJvdygpDQogICAgICAuY3NzKGlzVmVydGljYWwgPyAnbGVmdCcgOiAndG9wJywgNTAgKiAoMSAtIGRlbHRhIC8gZGltZW5zaW9uKSArICclJykNCiAgICAgIC5jc3MoaXNWZXJ0aWNhbCA/ICd0b3AnIDogJ2xlZnQnLCAnJykNCiAgfQ0KDQogIFRvb2x0aXAucHJvdG90eXBlLnNldENvbnRlbnQgPSBmdW5jdGlvbiAoKSB7DQogICAgdmFyICR0aXAgID0gdGhpcy50aXAoKQ0KICAgIHZhciB0aXRsZSA9IHRoaXMuZ2V0VGl0bGUoKQ0KDQogICAgJHRpcC5maW5kKCcudG9vbHRpcC1pbm5lcicpW3RoaXMub3B0aW9ucy5odG1sID8gJ2h0bWwnIDogJ3RleHQnXSh0aXRsZSkNCiAgICAkdGlwLnJlbW92ZUNsYXNzKCdmYWRlIGluIHRvcCBib3R0b20gbGVmdCByaWdodCcpDQogIH0NCg0KICBUb29sdGlwLnByb3RvdHlwZS5oaWRlID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7DQogICAgdmFyIHRoYXQgPSB0aGlzDQogICAgdmFyICR0aXAgPSAkKHRoaXMuJHRpcCkNCiAgICB2YXIgZSAgICA9ICQuRXZlbnQoJ2hpZGUuYnMuJyArIHRoaXMudHlwZSkNCg0KICAgIGZ1bmN0aW9uIGNvbXBsZXRlKCkgew0KICAgICAgaWYgKHRoYXQuaG92ZXJTdGF0ZSAhPSAnaW4nKSAkdGlwLmRldGFjaCgpDQogICAgICBpZiAodGhhdC4kZWxlbWVudCkgeyAvLyBUT0RPOiBDaGVjayB3aGV0aGVyIGd1YXJkaW5nIHRoaXMgY29kZSB3aXRoIHRoaXMgYGlmYCBpcyByZWFsbHkgbmVjZXNzYXJ5Lg0KICAgICAgICB0aGF0LiRlbGVtZW50DQogICAgICAgICAgLnJlbW92ZUF0dHIoJ2FyaWEtZGVzY3JpYmVkYnknKQ0KICAgICAgICAgIC50cmlnZ2VyKCdoaWRkZW4uYnMuJyArIHRoYXQudHlwZSkNCiAgICAgIH0NCiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKCkNCiAgICB9DQoNCiAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXIoZSkNCg0KICAgIGlmIChlLmlzRGVmYXVsdFByZXZlbnRlZCgpKSByZXR1cm4NCg0KICAgICR0aXAucmVtb3ZlQ2xhc3MoJ2luJykNCg0KICAgICQuc3VwcG9ydC50cmFuc2l0aW9uICYmICR0aXAuaGFzQ2xhc3MoJ2ZhZGUnKSA/DQogICAgICAkdGlwDQogICAgICAgIC5vbmUoJ2JzVHJhbnNpdGlvbkVuZCcsIGNvbXBsZXRlKQ0KICAgICAgICAuZW11bGF0ZVRyYW5zaXRpb25FbmQoVG9vbHRpcC5UUkFOU0lUSU9OX0RVUkFUSU9OKSA6DQogICAgICBjb21wbGV0ZSgpDQoNCiAgICB0aGlzLmhvdmVyU3RhdGUgPSBudWxsDQoNCiAgICByZXR1cm4gdGhpcw0KICB9DQoNCiAgVG9vbHRpcC5wcm90b3R5cGUuZml4VGl0bGUgPSBmdW5jdGlvbiAoKSB7DQogICAgdmFyICRlID0gdGhpcy4kZWxlbWVudA0KICAgIGlmICgkZS5hdHRyKCd0aXRsZScpIHx8IHR5cGVvZiAkZS5hdHRyKCdkYXRhLW9yaWdpbmFsLXRpdGxlJykgIT0gJ3N0cmluZycpIHsNCiAgICAgICRlLmF0dHIoJ2RhdGEtb3JpZ2luYWwtdGl0bGUnLCAkZS5hdHRyKCd0aXRsZScpIHx8ICcnKS5hdHRyKCd0aXRsZScsICcnKQ0KICAgIH0NCiAgfQ0KDQogIFRvb2x0aXAucHJvdG90eXBlLmhhc0NvbnRlbnQgPSBmdW5jdGlvbiAoKSB7DQogICAgcmV0dXJuIHRoaXMuZ2V0VGl0bGUoKQ0KICB9DQoNCiAgVG9vbHRpcC5wcm90b3R5cGUuZ2V0UG9zaXRpb24gPSBmdW5jdGlvbiAoJGVsZW1lbnQpIHsNCiAgICAkZWxlbWVudCAgID0gJGVsZW1lbnQgfHwgdGhpcy4kZWxlbWVudA0KDQogICAgdmFyIGVsICAgICA9ICRlbGVtZW50WzBdDQogICAgdmFyIGlzQm9keSA9IGVsLnRhZ05hbWUgPT0gJ0JPRFknDQoNCiAgICB2YXIgZWxSZWN0ICAgID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkNCiAgICBpZiAoZWxSZWN0LndpZHRoID09IG51bGwpIHsNCiAgICAgIC8vIHdpZHRoIGFuZCBoZWlnaHQgYXJlIG1pc3NpbmcgaW4gSUU4LCBzbyBjb21wdXRlIHRoZW0gbWFudWFsbHk7IHNlZSBodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvaXNzdWVzLzE0MDkzDQogICAgICBlbFJlY3QgPSAkLmV4dGVuZCh7fSwgZWxSZWN0LCB7IHdpZHRoOiBlbFJlY3QucmlnaHQgLSBlbFJlY3QubGVmdCwgaGVpZ2h0OiBlbFJlY3QuYm90dG9tIC0gZWxSZWN0LnRvcCB9KQ0KICAgIH0NCiAgICB2YXIgaXNTdmcgPSB3aW5kb3cuU1ZHRWxlbWVudCAmJiBlbCBpbnN0YW5jZW9mIHdpbmRvdy5TVkdFbGVtZW50DQogICAgLy8gQXZvaWQgdXNpbmcgJC5vZmZzZXQoKSBvbiBTVkdzIHNpbmNlIGl0IGdpdmVzIGluY29ycmVjdCByZXN1bHRzIGluIGpRdWVyeSAzLg0KICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvaXNzdWVzLzIwMjgwDQogICAgdmFyIGVsT2Zmc2V0ICA9IGlzQm9keSA/IHsgdG9wOiAwLCBsZWZ0OiAwIH0gOiAoaXNTdmcgPyBudWxsIDogJGVsZW1lbnQub2Zmc2V0KCkpDQogICAgdmFyIHNjcm9sbCAgICA9IHsgc2Nyb2xsOiBpc0JvZHkgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wIHx8IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wIDogJGVsZW1lbnQuc2Nyb2xsVG9wKCkgfQ0KICAgIHZhciBvdXRlckRpbXMgPSBpc0JvZHkgPyB7IHdpZHRoOiAkKHdpbmRvdykud2lkdGgoKSwgaGVpZ2h0OiAkKHdpbmRvdykuaGVpZ2h0KCkgfSA6IG51bGwNCg0KICAgIHJldHVybiAkLmV4dGVuZCh7fSwgZWxSZWN0LCBzY3JvbGwsIG91dGVyRGltcywgZWxPZmZzZXQpDQogIH0NCg0KICBUb29sdGlwLnByb3RvdHlwZS5nZXRDYWxjdWxhdGVkT2Zmc2V0ID0gZnVuY3Rpb24gKHBsYWNlbWVudCwgcG9zLCBhY3R1YWxXaWR0aCwgYWN0dWFsSGVpZ2h0KSB7DQogICAgcmV0dXJuIHBsYWNlbWVudCA9PSAnYm90dG9tJyA/IHsgdG9wOiBwb3MudG9wICsgcG9zLmhlaWdodCwgICBsZWZ0OiBwb3MubGVmdCArIHBvcy53aWR0aCAvIDIgLSBhY3R1YWxXaWR0aCAvIDIgfSA6DQogICAgICAgICAgIHBsYWNlbWVudCA9PSAndG9wJyAgICA/IHsgdG9wOiBwb3MudG9wIC0gYWN0dWFsSGVpZ2h0LCBsZWZ0OiBwb3MubGVmdCArIHBvcy53aWR0aCAvIDIgLSBhY3R1YWxXaWR0aCAvIDIgfSA6DQogICAgICAgICAgIHBsYWNlbWVudCA9PSAnbGVmdCcgICA/IHsgdG9wOiBwb3MudG9wICsgcG9zLmhlaWdodCAvIDIgLSBhY3R1YWxIZWlnaHQgLyAyLCBsZWZ0OiBwb3MubGVmdCAtIGFjdHVhbFdpZHRoIH0gOg0KICAgICAgICAvKiBwbGFjZW1lbnQgPT0gJ3JpZ2h0JyAqLyB7IHRvcDogcG9zLnRvcCArIHBvcy5oZWlnaHQgLyAyIC0gYWN0dWFsSGVpZ2h0IC8gMiwgbGVmdDogcG9zLmxlZnQgKyBwb3Mud2lkdGggfQ0KDQogIH0NCg0KICBUb29sdGlwLnByb3RvdHlwZS5nZXRWaWV3cG9ydEFkanVzdGVkRGVsdGEgPSBmdW5jdGlvbiAocGxhY2VtZW50LCBwb3MsIGFjdHVhbFdpZHRoLCBhY3R1YWxIZWlnaHQpIHsNCiAgICB2YXIgZGVsdGEgPSB7IHRvcDogMCwgbGVmdDogMCB9DQogICAgaWYgKCF0aGlzLiR2aWV3cG9ydCkgcmV0dXJuIGRlbHRhDQoNCiAgICB2YXIgdmlld3BvcnRQYWRkaW5nID0gdGhpcy5vcHRpb25zLnZpZXdwb3J0ICYmIHRoaXMub3B0aW9ucy52aWV3cG9ydC5wYWRkaW5nIHx8IDANCiAgICB2YXIgdmlld3BvcnREaW1lbnNpb25zID0gdGhpcy5nZXRQb3NpdGlvbih0aGlzLiR2aWV3cG9ydCkNCg0KICAgIGlmICgvcmlnaHR8bGVmdC8udGVzdChwbGFjZW1lbnQpKSB7DQogICAgICB2YXIgdG9wRWRnZU9mZnNldCAgICA9IHBvcy50b3AgLSB2aWV3cG9ydFBhZGRpbmcgLSB2aWV3cG9ydERpbWVuc2lvbnMuc2Nyb2xsDQogICAgICB2YXIgYm90dG9tRWRnZU9mZnNldCA9IHBvcy50b3AgKyB2aWV3cG9ydFBhZGRpbmcgLSB2aWV3cG9ydERpbWVuc2lvbnMuc2Nyb2xsICsgYWN0dWFsSGVpZ2h0DQogICAgICBpZiAodG9wRWRnZU9mZnNldCA8IHZpZXdwb3J0RGltZW5zaW9ucy50b3ApIHsgLy8gdG9wIG92ZXJmbG93DQogICAgICAgIGRlbHRhLnRvcCA9IHZpZXdwb3J0RGltZW5zaW9ucy50b3AgLSB0b3BFZGdlT2Zmc2V0DQogICAgICB9IGVsc2UgaWYgKGJvdHRvbUVkZ2VPZmZzZXQgPiB2aWV3cG9ydERpbWVuc2lvbnMudG9wICsgdmlld3BvcnREaW1lbnNpb25zLmhlaWdodCkgeyAvLyBib3R0b20gb3ZlcmZsb3cNCiAgICAgICAgZGVsdGEudG9wID0gdmlld3BvcnREaW1lbnNpb25zLnRvcCArIHZpZXdwb3J0RGltZW5zaW9ucy5oZWlnaHQgLSBib3R0b21FZGdlT2Zmc2V0DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIHZhciBsZWZ0RWRnZU9mZnNldCAgPSBwb3MubGVmdCAtIHZpZXdwb3J0UGFkZGluZw0KICAgICAgdmFyIHJpZ2h0RWRnZU9mZnNldCA9IHBvcy5sZWZ0ICsgdmlld3BvcnRQYWRkaW5nICsgYWN0dWFsV2lkdGgNCiAgICAgIGlmIChsZWZ0RWRnZU9mZnNldCA8IHZpZXdwb3J0RGltZW5zaW9ucy5sZWZ0KSB7IC8vIGxlZnQgb3ZlcmZsb3cNCiAgICAgICAgZGVsdGEubGVmdCA9IHZpZXdwb3J0RGltZW5zaW9ucy5sZWZ0IC0gbGVmdEVkZ2VPZmZzZXQNCiAgICAgIH0gZWxzZSBpZiAocmlnaHRFZGdlT2Zmc2V0ID4gdmlld3BvcnREaW1lbnNpb25zLnJpZ2h0KSB7IC8vIHJpZ2h0IG92ZXJmbG93DQogICAgICAgIGRlbHRhLmxlZnQgPSB2aWV3cG9ydERpbWVuc2lvbnMubGVmdCArIHZpZXdwb3J0RGltZW5zaW9ucy53aWR0aCAtIHJpZ2h0RWRnZU9mZnNldA0KICAgICAgfQ0KICAgIH0NCg0KICAgIHJldHVybiBkZWx0YQ0KICB9DQoNCiAgVG9vbHRpcC5wcm90b3R5cGUuZ2V0VGl0bGUgPSBmdW5jdGlvbiAoKSB7DQogICAgdmFyIHRpdGxlDQogICAgdmFyICRlID0gdGhpcy4kZWxlbWVudA0KICAgIHZhciBvICA9IHRoaXMub3B0aW9ucw0KDQogICAgdGl0bGUgPSAkZS5hdHRyKCdkYXRhLW9yaWdpbmFsLXRpdGxlJykNCiAgICAgIHx8ICh0eXBlb2Ygby50aXRsZSA9PSAnZnVuY3Rpb24nID8gby50aXRsZS5jYWxsKCRlWzBdKSA6ICBvLnRpdGxlKQ0KDQogICAgcmV0dXJuIHRpdGxlDQogIH0NCg0KICBUb29sdGlwLnByb3RvdHlwZS5nZXRVSUQgPSBmdW5jdGlvbiAocHJlZml4KSB7DQogICAgZG8gcHJlZml4ICs9IH5+KE1hdGgucmFuZG9tKCkgKiAxMDAwMDAwKQ0KICAgIHdoaWxlIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChwcmVmaXgpKQ0KICAgIHJldHVybiBwcmVmaXgNCiAgfQ0KDQogIFRvb2x0aXAucHJvdG90eXBlLnRpcCA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAoIXRoaXMuJHRpcCkgew0KICAgICAgdGhpcy4kdGlwID0gJCh0aGlzLm9wdGlvbnMudGVtcGxhdGUpDQogICAgICBpZiAodGhpcy4kdGlwLmxlbmd0aCAhPSAxKSB7DQogICAgICAgIHRocm93IG5ldyBFcnJvcih0aGlzLnR5cGUgKyAnIGB0ZW1wbGF0ZWAgb3B0aW9uIG11c3QgY29uc2lzdCBvZiBleGFjdGx5IDEgdG9wLWxldmVsIGVsZW1lbnQhJykNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHRoaXMuJHRpcA0KICB9DQoNCiAgVG9vbHRpcC5wcm90b3R5cGUuYXJyb3cgPSBmdW5jdGlvbiAoKSB7DQogICAgcmV0dXJuICh0aGlzLiRhcnJvdyA9IHRoaXMuJGFycm93IHx8IHRoaXMudGlwKCkuZmluZCgnLnRvb2x0aXAtYXJyb3cnKSkNCiAgfQ0KDQogIFRvb2x0aXAucHJvdG90eXBlLmVuYWJsZSA9IGZ1bmN0aW9uICgpIHsNCiAgICB0aGlzLmVuYWJsZWQgPSB0cnVlDQogIH0NCg0KICBUb29sdGlwLnByb3RvdHlwZS5kaXNhYmxlID0gZnVuY3Rpb24gKCkgew0KICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlDQogIH0NCg0KICBUb29sdGlwLnByb3RvdHlwZS50b2dnbGVFbmFibGVkID0gZnVuY3Rpb24gKCkgew0KICAgIHRoaXMuZW5hYmxlZCA9ICF0aGlzLmVuYWJsZWQNCiAgfQ0KDQogIFRvb2x0aXAucHJvdG90eXBlLnRvZ2dsZSA9IGZ1bmN0aW9uIChlKSB7DQogICAgdmFyIHNlbGYgPSB0aGlzDQogICAgaWYgKGUpIHsNCiAgICAgIHNlbGYgPSAkKGUuY3VycmVudFRhcmdldCkuZGF0YSgnYnMuJyArIHRoaXMudHlwZSkNCiAgICAgIGlmICghc2VsZikgew0KICAgICAgICBzZWxmID0gbmV3IHRoaXMuY29uc3RydWN0b3IoZS5jdXJyZW50VGFyZ2V0LCB0aGlzLmdldERlbGVnYXRlT3B0aW9ucygpKQ0KICAgICAgICAkKGUuY3VycmVudFRhcmdldCkuZGF0YSgnYnMuJyArIHRoaXMudHlwZSwgc2VsZikNCiAgICAgIH0NCiAgICB9DQoNCiAgICBpZiAoZSkgew0KICAgICAgc2VsZi5pblN0YXRlLmNsaWNrID0gIXNlbGYuaW5TdGF0ZS5jbGljaw0KICAgICAgaWYgKHNlbGYuaXNJblN0YXRlVHJ1ZSgpKSBzZWxmLmVudGVyKHNlbGYpDQogICAgICBlbHNlIHNlbGYubGVhdmUoc2VsZikNCiAgICB9IGVsc2Ugew0KICAgICAgc2VsZi50aXAoKS5oYXNDbGFzcygnaW4nKSA/IHNlbGYubGVhdmUoc2VsZikgOiBzZWxmLmVudGVyKHNlbGYpDQogICAgfQ0KICB9DQoNCiAgVG9vbHRpcC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsNCiAgICB2YXIgdGhhdCA9IHRoaXMNCiAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KQ0KICAgIHRoaXMuaGlkZShmdW5jdGlvbiAoKSB7DQogICAgICB0aGF0LiRlbGVtZW50Lm9mZignLicgKyB0aGF0LnR5cGUpLnJlbW92ZURhdGEoJ2JzLicgKyB0aGF0LnR5cGUpDQogICAgICBpZiAodGhhdC4kdGlwKSB7DQogICAgICAgIHRoYXQuJHRpcC5kZXRhY2goKQ0KICAgICAgfQ0KICAgICAgdGhhdC4kdGlwID0gbnVsbA0KICAgICAgdGhhdC4kYXJyb3cgPSBudWxsDQogICAgICB0aGF0LiR2aWV3cG9ydCA9IG51bGwNCiAgICAgIHRoYXQuJGVsZW1lbnQgPSBudWxsDQogICAgfSkNCiAgfQ0KDQoNCiAgLy8gVE9PTFRJUCBQTFVHSU4gREVGSU5JVElPTg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09DQoNCiAgZnVuY3Rpb24gUGx1Z2luKG9wdGlvbikgew0KICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgdmFyICR0aGlzICAgPSAkKHRoaXMpDQogICAgICB2YXIgZGF0YSAgICA9ICR0aGlzLmRhdGEoJ2JzLnRvb2x0aXAnKQ0KICAgICAgdmFyIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9uID09ICdvYmplY3QnICYmIG9wdGlvbg0KDQogICAgICBpZiAoIWRhdGEgJiYgL2Rlc3Ryb3l8aGlkZS8udGVzdChvcHRpb24pKSByZXR1cm4NCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnYnMudG9vbHRpcCcsIChkYXRhID0gbmV3IFRvb2x0aXAodGhpcywgb3B0aW9ucykpKQ0KICAgICAgaWYgKHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycpIGRhdGFbb3B0aW9uXSgpDQogICAgfSkNCiAgfQ0KDQogIHZhciBvbGQgPSAkLmZuLnRvb2x0aXANCg0KICAkLmZuLnRvb2x0aXAgICAgICAgICAgICAgPSBQbHVnaW4NCiAgJC5mbi50b29sdGlwLkNvbnN0cnVjdG9yID0gVG9vbHRpcA0KDQoNCiAgLy8gVE9PTFRJUCBOTyBDT05GTElDVA0KICAvLyA9PT09PT09PT09PT09PT09PT09DQoNCiAgJC5mbi50b29sdGlwLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgJC5mbi50b29sdGlwID0gb2xkDQogICAgcmV0dXJuIHRoaXMNCiAgfQ0KDQp9KGpRdWVyeSk7DQoNCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICogQm9vdHN0cmFwOiBwb3BvdmVyLmpzIHYzLjMuNw0KICogaHR0cDovL2dldGJvb3RzdHJhcC5jb20vamF2YXNjcmlwdC8jcG9wb3ZlcnMNCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICogQ29weXJpZ2h0IDIwMTEtMjAxNiBUd2l0dGVyLCBJbmMuDQogKiBMaWNlbnNlZCB1bmRlciBNSVQgKGh0dHBzOi8vZ2l0aHViLmNvbS90d2JzL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9MSUNFTlNFKQ0KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovDQoNCg0KK2Z1bmN0aW9uICgkKSB7DQogICd1c2Ugc3RyaWN0JzsNCg0KICAvLyBQT1BPVkVSIFBVQkxJQyBDTEFTUyBERUZJTklUSU9ODQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCg0KICB2YXIgUG9wb3ZlciA9IGZ1bmN0aW9uIChlbGVtZW50LCBvcHRpb25zKSB7DQogICAgdGhpcy5pbml0KCdwb3BvdmVyJywgZWxlbWVudCwgb3B0aW9ucykNCiAgfQ0KDQogIGlmICghJC5mbi50b29sdGlwKSB0aHJvdyBuZXcgRXJyb3IoJ1BvcG92ZXIgcmVxdWlyZXMgdG9vbHRpcC5qcycpDQoNCiAgUG9wb3Zlci5WRVJTSU9OICA9ICczLjMuNycNCg0KICBQb3BvdmVyLkRFRkFVTFRTID0gJC5leHRlbmQoe30sICQuZm4udG9vbHRpcC5Db25zdHJ1Y3Rvci5ERUZBVUxUUywgew0KICAgIHBsYWNlbWVudDogJ3JpZ2h0JywNCiAgICB0cmlnZ2VyOiAnY2xpY2snLA0KICAgIGNvbnRlbnQ6ICcnLA0KICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0icG9wb3ZlciIgcm9sZT0idG9vbHRpcCI+PGRpdiBjbGFzcz0iYXJyb3ciPjwvZGl2PjxoMyBjbGFzcz0icG9wb3Zlci10aXRsZSI+PC9oMz48ZGl2IGNsYXNzPSJwb3BvdmVyLWNvbnRlbnQiPjwvZGl2PjwvZGl2PicNCiAgfSkNCg0KDQogIC8vIE5PVEU6IFBPUE9WRVIgRVhURU5EUyB0b29sdGlwLmpzDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQoNCiAgUG9wb3Zlci5wcm90b3R5cGUgPSAkLmV4dGVuZCh7fSwgJC5mbi50b29sdGlwLkNvbnN0cnVjdG9yLnByb3RvdHlwZSkNCg0KICBQb3BvdmVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBvcG92ZXINCg0KICBQb3BvdmVyLnByb3RvdHlwZS5nZXREZWZhdWx0cyA9IGZ1bmN0aW9uICgpIHsNCiAgICByZXR1cm4gUG9wb3Zlci5ERUZBVUxUUw0KICB9DQoNCiAgUG9wb3Zlci5wcm90b3R5cGUuc2V0Q29udGVudCA9IGZ1bmN0aW9uICgpIHsNCiAgICB2YXIgJHRpcCAgICA9IHRoaXMudGlwKCkNCiAgICB2YXIgdGl0bGUgICA9IHRoaXMuZ2V0VGl0bGUoKQ0KICAgIHZhciBjb250ZW50ID0gdGhpcy5nZXRDb250ZW50KCkNCg0KICAgICR0aXAuZmluZCgnLnBvcG92ZXItdGl0bGUnKVt0aGlzLm9wdGlvbnMuaHRtbCA/ICdodG1sJyA6ICd0ZXh0J10odGl0bGUpDQogICAgJHRpcC5maW5kKCcucG9wb3Zlci1jb250ZW50JykuY2hpbGRyZW4oKS5kZXRhY2goKS5lbmQoKVsgLy8gd2UgdXNlIGFwcGVuZCBmb3IgaHRtbCBvYmplY3RzIHRvIG1haW50YWluIGpzIGV2ZW50cw0KICAgICAgdGhpcy5vcHRpb25zLmh0bWwgPyAodHlwZW9mIGNvbnRlbnQgPT0gJ3N0cmluZycgPyAnaHRtbCcgOiAnYXBwZW5kJykgOiAndGV4dCcNCiAgICBdKGNvbnRlbnQpDQoNCiAgICAkdGlwLnJlbW92ZUNsYXNzKCdmYWRlIHRvcCBib3R0b20gbGVmdCByaWdodCBpbicpDQoNCiAgICAvLyBJRTggZG9lc24ndCBhY2NlcHQgaGlkaW5nIHZpYSB0aGUgYDplbXB0eWAgcHNldWRvIHNlbGVjdG9yLCB3ZSBoYXZlIHRvIGRvDQogICAgLy8gdGhpcyBtYW51YWxseSBieSBjaGVja2luZyB0aGUgY29udGVudHMuDQogICAgaWYgKCEkdGlwLmZpbmQoJy5wb3BvdmVyLXRpdGxlJykuaHRtbCgpKSAkdGlwLmZpbmQoJy5wb3BvdmVyLXRpdGxlJykuaGlkZSgpDQogIH0NCg0KICBQb3BvdmVyLnByb3RvdHlwZS5oYXNDb250ZW50ID0gZnVuY3Rpb24gKCkgew0KICAgIHJldHVybiB0aGlzLmdldFRpdGxlKCkgfHwgdGhpcy5nZXRDb250ZW50KCkNCiAgfQ0KDQogIFBvcG92ZXIucHJvdG90eXBlLmdldENvbnRlbnQgPSBmdW5jdGlvbiAoKSB7DQogICAgdmFyICRlID0gdGhpcy4kZWxlbWVudA0KICAgIHZhciBvICA9IHRoaXMub3B0aW9ucw0KDQogICAgcmV0dXJuICRlLmF0dHIoJ2RhdGEtY29udGVudCcpDQogICAgICB8fCAodHlwZW9mIG8uY29udGVudCA9PSAnZnVuY3Rpb24nID8NCiAgICAgICAgICAgIG8uY29udGVudC5jYWxsKCRlWzBdKSA6DQogICAgICAgICAgICBvLmNvbnRlbnQpDQogIH0NCg0KICBQb3BvdmVyLnByb3RvdHlwZS5hcnJvdyA9IGZ1bmN0aW9uICgpIHsNCiAgICByZXR1cm4gKHRoaXMuJGFycm93ID0gdGhpcy4kYXJyb3cgfHwgdGhpcy50aXAoKS5maW5kKCcuYXJyb3cnKSkNCiAgfQ0KDQoNCiAgLy8gUE9QT1ZFUiBQTFVHSU4gREVGSU5JVElPTg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09DQoNCiAgZnVuY3Rpb24gUGx1Z2luKG9wdGlvbikgew0KICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgdmFyICR0aGlzICAgPSAkKHRoaXMpDQogICAgICB2YXIgZGF0YSAgICA9ICR0aGlzLmRhdGEoJ2JzLnBvcG92ZXInKQ0KICAgICAgdmFyIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9uID09ICdvYmplY3QnICYmIG9wdGlvbg0KDQogICAgICBpZiAoIWRhdGEgJiYgL2Rlc3Ryb3l8aGlkZS8udGVzdChvcHRpb24pKSByZXR1cm4NCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnYnMucG9wb3ZlcicsIChkYXRhID0gbmV3IFBvcG92ZXIodGhpcywgb3B0aW9ucykpKQ0KICAgICAgaWYgKHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycpIGRhdGFbb3B0aW9uXSgpDQogICAgfSkNCiAgfQ0KDQogIHZhciBvbGQgPSAkLmZuLnBvcG92ZXINCg0KICAkLmZuLnBvcG92ZXIgICAgICAgICAgICAgPSBQbHVnaW4NCiAgJC5mbi5wb3BvdmVyLkNvbnN0cnVjdG9yID0gUG9wb3Zlcg0KDQoNCiAgLy8gUE9QT1ZFUiBOTyBDT05GTElDVA0KICAvLyA9PT09PT09PT09PT09PT09PT09DQoNCiAgJC5mbi5wb3BvdmVyLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgJC5mbi5wb3BvdmVyID0gb2xkDQogICAgcmV0dXJuIHRoaXMNCiAgfQ0KDQp9KGpRdWVyeSk7DQoNCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICogQm9vdHN0cmFwOiBzY3JvbGxzcHkuanMgdjMuMy43DQogKiBodHRwOi8vZ2V0Ym9vdHN0cmFwLmNvbS9qYXZhc2NyaXB0LyNzY3JvbGxzcHkNCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICogQ29weXJpZ2h0IDIwMTEtMjAxNiBUd2l0dGVyLCBJbmMuDQogKiBMaWNlbnNlZCB1bmRlciBNSVQgKGh0dHBzOi8vZ2l0aHViLmNvbS90d2JzL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9MSUNFTlNFKQ0KICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovDQoNCg0KK2Z1bmN0aW9uICgkKSB7DQogICd1c2Ugc3RyaWN0JzsNCg0KICAvLyBTQ1JPTExTUFkgQ0xBU1MgREVGSU5JVElPTg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQogIGZ1bmN0aW9uIFNjcm9sbFNweShlbGVtZW50LCBvcHRpb25zKSB7DQogICAgdGhpcy4kYm9keSAgICAgICAgICA9ICQoZG9jdW1lbnQuYm9keSkNCiAgICB0aGlzLiRzY3JvbGxFbGVtZW50ID0gJChlbGVtZW50KS5pcyhkb2N1bWVudC5ib2R5KSA/ICQod2luZG93KSA6ICQoZWxlbWVudCkNCiAgICB0aGlzLm9wdGlvbnMgICAgICAgID0gJC5leHRlbmQoe30sIFNjcm9sbFNweS5ERUZBVUxUUywgb3B0aW9ucykNCiAgICB0aGlzLnNlbGVjdG9yICAgICAgID0gKHRoaXMub3B0aW9ucy50YXJnZXQgfHwgJycpICsgJyAubmF2IGxpID4gYScNCiAgICB0aGlzLm9mZnNldHMgICAgICAgID0gW10NCiAgICB0aGlzLnRhcmdldHMgICAgICAgID0gW10NCiAgICB0aGlzLmFjdGl2ZVRhcmdldCAgID0gbnVsbA0KICAgIHRoaXMuc2Nyb2xsSGVpZ2h0ICAgPSAwDQoNCiAgICB0aGlzLiRzY3JvbGxFbGVtZW50Lm9uKCdzY3JvbGwuYnMuc2Nyb2xsc3B5JywgJC5wcm94eSh0aGlzLnByb2Nlc3MsIHRoaXMpKQ0KICAgIHRoaXMucmVmcmVzaCgpDQogICAgdGhpcy5wcm9jZXNzKCkNCiAgfQ0KDQogIFNjcm9sbFNweS5WRVJTSU9OICA9ICczLjMuNycNCg0KICBTY3JvbGxTcHkuREVGQVVMVFMgPSB7DQogICAgb2Zmc2V0OiAxMA0KICB9DQoNCiAgU2Nyb2xsU3B5LnByb3RvdHlwZS5nZXRTY3JvbGxIZWlnaHQgPSBmdW5jdGlvbiAoKSB7DQogICAgcmV0dXJuIHRoaXMuJHNjcm9sbEVsZW1lbnRbMF0uc2Nyb2xsSGVpZ2h0IHx8IE1hdGgubWF4KHRoaXMuJGJvZHlbMF0uc2Nyb2xsSGVpZ2h0LCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0KQ0KICB9DQoNCiAgU2Nyb2xsU3B5LnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24gKCkgew0KICAgIHZhciB0aGF0ICAgICAgICAgID0gdGhpcw0KICAgIHZhciBvZmZzZXRNZXRob2QgID0gJ29mZnNldCcNCiAgICB2YXIgb2Zmc2V0QmFzZSAgICA9IDANCg0KICAgIHRoaXMub2Zmc2V0cyAgICAgID0gW10NCiAgICB0aGlzLnRhcmdldHMgICAgICA9IFtdDQogICAgdGhpcy5zY3JvbGxIZWlnaHQgPSB0aGlzLmdldFNjcm9sbEhlaWdodCgpDQoNCiAgICBpZiAoISQuaXNXaW5kb3codGhpcy4kc2Nyb2xsRWxlbWVudFswXSkpIHsNCiAgICAgIG9mZnNldE1ldGhvZCA9ICdwb3NpdGlvbicNCiAgICAgIG9mZnNldEJhc2UgICA9IHRoaXMuJHNjcm9sbEVsZW1lbnQuc2Nyb2xsVG9wKCkNCiAgICB9DQoNCiAgICB0aGlzLiRib2R5DQogICAgICAuZmluZCh0aGlzLnNlbGVjdG9yKQ0KICAgICAgLm1hcChmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciAkZWwgICA9ICQodGhpcykNCiAgICAgICAgdmFyIGhyZWYgID0gJGVsLmRhdGEoJ3RhcmdldCcpIHx8ICRlbC5hdHRyKCdocmVmJykNCiAgICAgICAgdmFyICRocmVmID0gL14jLi8udGVzdChocmVmKSAmJiAkKGhyZWYpDQoNCiAgICAgICAgcmV0dXJuICgkaHJlZg0KICAgICAgICAgICYmICRocmVmLmxlbmd0aA0KICAgICAgICAgICYmICRocmVmLmlzKCc6dmlzaWJsZScpDQogICAgICAgICAgJiYgW1skaHJlZltvZmZzZXRNZXRob2RdKCkudG9wICsgb2Zmc2V0QmFzZSwgaHJlZl1dKSB8fCBudWxsDQogICAgICB9KQ0KICAgICAgLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsgcmV0dXJuIGFbMF0gLSBiWzBdIH0pDQogICAgICAuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoYXQub2Zmc2V0cy5wdXNoKHRoaXNbMF0pDQogICAgICAgIHRoYXQudGFyZ2V0cy5wdXNoKHRoaXNbMV0pDQogICAgICB9KQ0KICB9DQoNCiAgU2Nyb2xsU3B5LnByb3RvdHlwZS5wcm9jZXNzID0gZnVuY3Rpb24gKCkgew0KICAgIHZhciBzY3JvbGxUb3AgICAgPSB0aGlzLiRzY3JvbGxFbGVtZW50LnNjcm9sbFRvcCgpICsgdGhpcy5vcHRpb25zLm9mZnNldA0KICAgIHZhciBzY3JvbGxIZWlnaHQgPSB0aGlzLmdldFNjcm9sbEhlaWdodCgpDQogICAgdmFyIG1heFNjcm9sbCAgICA9IHRoaXMub3B0aW9ucy5vZmZzZXQgKyBzY3JvbGxIZWlnaHQgLSB0aGlzLiRzY3JvbGxFbGVtZW50LmhlaWdodCgpDQogICAgdmFyIG9mZnNldHMgICAgICA9IHRoaXMub2Zmc2V0cw0KICAgIHZhciB0YXJnZXRzICAgICAgPSB0aGlzLnRhcmdldHMNCiAgICB2YXIgYWN0aXZlVGFyZ2V0ID0gdGhpcy5hY3RpdmVUYXJnZXQNCiAgICB2YXIgaQ0KDQogICAgaWYgKHRoaXMuc2Nyb2xsSGVpZ2h0ICE9IHNjcm9sbEhlaWdodCkgew0KICAgICAgdGhpcy5yZWZyZXNoKCkNCiAgICB9DQoNCiAgICBpZiAoc2Nyb2xsVG9wID49IG1heFNjcm9sbCkgew0KICAgICAgcmV0dXJuIGFjdGl2ZVRhcmdldCAhPSAoaSA9IHRhcmdldHNbdGFyZ2V0cy5sZW5ndGggLSAxXSkgJiYgdGhpcy5hY3RpdmF0ZShpKQ0KICAgIH0NCg0KICAgIGlmIChhY3RpdmVUYXJnZXQgJiYgc2Nyb2xsVG9wIDwgb2Zmc2V0c1swXSkgew0KICAgICAgdGhpcy5hY3RpdmVUYXJnZXQgPSBudWxsDQogICAgICByZXR1cm4gdGhpcy5jbGVhcigpDQogICAgfQ0KDQogICAgZm9yIChpID0gb2Zmc2V0cy5sZW5ndGg7IGktLTspIHsNCiAgICAgIGFjdGl2ZVRhcmdldCAhPSB0YXJnZXRzW2ldDQogICAgICAgICYmIHNjcm9sbFRvcCA+PSBvZmZzZXRzW2ldDQogICAgICAgICYmIChvZmZzZXRzW2kgKyAxXSA9PT0gdW5kZWZpbmVkIHx8IHNjcm9sbFRvcCA8IG9mZnNldHNbaSArIDFdKQ0KICAgICAgICAmJiB0aGlzLmFjdGl2YXRlKHRhcmdldHNbaV0pDQogICAgfQ0KICB9DQoNCiAgU2Nyb2xsU3B5LnByb3RvdHlwZS5hY3RpdmF0ZSA9IGZ1bmN0aW9uICh0YXJnZXQpIHsNCiAgICB0aGlzLmFjdGl2ZVRhcmdldCA9IHRhcmdldA0KDQogICAgdGhpcy5jbGVhcigpDQoNCiAgICB2YXIgc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yICsNCiAgICAgICdbZGF0YS10YXJnZXQ9IicgKyB0YXJnZXQgKyAnIl0sJyArDQogICAgICB0aGlzLnNlbGVjdG9yICsgJ1tocmVmPSInICsgdGFyZ2V0ICsgJyJdJw0KDQogICAgdmFyIGFjdGl2ZSA9ICQoc2VsZWN0b3IpDQogICAgICAucGFyZW50cygnbGknKQ0KICAgICAgLmFkZENsYXNzKCdhY3RpdmUnKQ0KDQogICAgaWYgKGFjdGl2ZS5wYXJlbnQoJy5kcm9wZG93bi1tZW51JykubGVuZ3RoKSB7DQogICAgICBhY3RpdmUgPSBhY3RpdmUNCiAgICAgICAgLmNsb3Nlc3QoJ2xpLmRyb3Bkb3duJykNCiAgICAgICAgLmFkZENsYXNzKCdhY3RpdmUnKQ0KICAgIH0NCg0KICAgIGFjdGl2ZS50cmlnZ2VyKCdhY3RpdmF0ZS5icy5zY3JvbGxzcHknKQ0KICB9DQoNCiAgU2Nyb2xsU3B5LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHsNCiAgICAkKHRoaXMuc2VsZWN0b3IpDQogICAgICAucGFyZW50c1VudGlsKHRoaXMub3B0aW9ucy50YXJnZXQsICcuYWN0aXZlJykNCiAgICAgIC5yZW1vdmVDbGFzcygnYWN0aXZlJykNCiAgfQ0KDQoNCiAgLy8gU0NST0xMU1BZIFBMVUdJTiBERUZJTklUSU9ODQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQogIGZ1bmN0aW9uIFBsdWdpbihvcHRpb24pIHsNCiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgIHZhciAkdGhpcyAgID0gJCh0aGlzKQ0KICAgICAgdmFyIGRhdGEgICAgPSAkdGhpcy5kYXRhKCdicy5zY3JvbGxzcHknKQ0KICAgICAgdmFyIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9uID09ICdvYmplY3QnICYmIG9wdGlvbg0KDQogICAgICBpZiAoIWRhdGEpICR0aGlzLmRhdGEoJ2JzLnNjcm9sbHNweScsIChkYXRhID0gbmV3IFNjcm9sbFNweSh0aGlzLCBvcHRpb25zKSkpDQogICAgICBpZiAodHlwZW9mIG9wdGlvbiA9PSAnc3RyaW5nJykgZGF0YVtvcHRpb25dKCkNCiAgICB9KQ0KICB9DQoNCiAgdmFyIG9sZCA9ICQuZm4uc2Nyb2xsc3B5DQoNCiAgJC5mbi5zY3JvbGxzcHkgICAgICAgICAgICAgPSBQbHVnaW4NCiAgJC5mbi5zY3JvbGxzcHkuQ29uc3RydWN0b3IgPSBTY3JvbGxTcHkNCg0KDQogIC8vIFNDUk9MTFNQWSBOTyBDT05GTElDVA0KICAvLyA9PT09PT09PT09PT09PT09PT09PT0NCg0KICAkLmZuLnNjcm9sbHNweS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgew0KICAgICQuZm4uc2Nyb2xsc3B5ID0gb2xkDQogICAgcmV0dXJuIHRoaXMNCiAgfQ0KDQoNCiAgLy8gU0NST0xMU1BZIERBVEEtQVBJDQogIC8vID09PT09PT09PT09PT09PT09PQ0KDQogICQod2luZG93KS5vbignbG9hZC5icy5zY3JvbGxzcHkuZGF0YS1hcGknLCBmdW5jdGlvbiAoKSB7DQogICAgJCgnW2RhdGEtc3B5PSJzY3JvbGwiXScpLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgdmFyICRzcHkgPSAkKHRoaXMpDQogICAgICBQbHVnaW4uY2FsbCgkc3B5LCAkc3B5LmRhdGEoKSkNCiAgICB9KQ0KICB9KQ0KDQp9KGpRdWVyeSk7DQoNCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICogQm9vdHN0cmFwOiB0YWIuanMgdjMuMy43DQogKiBodHRwOi8vZ2V0Ym9vdHN0cmFwLmNvbS9qYXZhc2NyaXB0LyN0YWJzDQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAqIENvcHlyaWdodCAyMDExLTIwMTYgVHdpdHRlciwgSW5jLg0KICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLw0KDQoNCitmdW5jdGlvbiAoJCkgew0KICAndXNlIHN0cmljdCc7DQoNCiAgLy8gVEFCIENMQVNTIERFRklOSVRJT04NCiAgLy8gPT09PT09PT09PT09PT09PT09PT0NCg0KICB2YXIgVGFiID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsNCiAgICAvLyBqc2NzOmRpc2FibGUgcmVxdWlyZURvbGxhckJlZm9yZWpRdWVyeUFzc2lnbm1lbnQNCiAgICB0aGlzLmVsZW1lbnQgPSAkKGVsZW1lbnQpDQogICAgLy8ganNjczplbmFibGUgcmVxdWlyZURvbGxhckJlZm9yZWpRdWVyeUFzc2lnbm1lbnQNCiAgfQ0KDQogIFRhYi5WRVJTSU9OID0gJzMuMy43Jw0KDQogIFRhYi5UUkFOU0lUSU9OX0RVUkFUSU9OID0gMTUwDQoNCiAgVGFiLnByb3RvdHlwZS5zaG93ID0gZnVuY3Rpb24gKCkgew0KICAgIHZhciAkdGhpcyAgICA9IHRoaXMuZWxlbWVudA0KICAgIHZhciAkdWwgICAgICA9ICR0aGlzLmNsb3Nlc3QoJ3VsOm5vdCguZHJvcGRvd24tbWVudSknKQ0KICAgIHZhciBzZWxlY3RvciA9ICR0aGlzLmRhdGEoJ3RhcmdldCcpDQoNCiAgICBpZiAoIXNlbGVjdG9yKSB7DQogICAgICBzZWxlY3RvciA9ICR0aGlzLmF0dHIoJ2hyZWYnKQ0KICAgICAgc2VsZWN0b3IgPSBzZWxlY3RvciAmJiBzZWxlY3Rvci5yZXBsYWNlKC8uKig/PSNbXlxzXSokKS8sICcnKSAvLyBzdHJpcCBmb3IgaWU3DQogICAgfQ0KDQogICAgaWYgKCR0aGlzLnBhcmVudCgnbGknKS5oYXNDbGFzcygnYWN0aXZlJykpIHJldHVybg0KDQogICAgdmFyICRwcmV2aW91cyA9ICR1bC5maW5kKCcuYWN0aXZlOmxhc3QgYScpDQogICAgdmFyIGhpZGVFdmVudCA9ICQuRXZlbnQoJ2hpZGUuYnMudGFiJywgew0KICAgICAgcmVsYXRlZFRhcmdldDogJHRoaXNbMF0NCiAgICB9KQ0KICAgIHZhciBzaG93RXZlbnQgPSAkLkV2ZW50KCdzaG93LmJzLnRhYicsIHsNCiAgICAgIHJlbGF0ZWRUYXJnZXQ6ICRwcmV2aW91c1swXQ0KICAgIH0pDQoNCiAgICAkcHJldmlvdXMudHJpZ2dlcihoaWRlRXZlbnQpDQogICAgJHRoaXMudHJpZ2dlcihzaG93RXZlbnQpDQoNCiAgICBpZiAoc2hvd0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8IGhpZGVFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgcmV0dXJuDQoNCiAgICB2YXIgJHRhcmdldCA9ICQoc2VsZWN0b3IpDQoNCiAgICB0aGlzLmFjdGl2YXRlKCR0aGlzLmNsb3Nlc3QoJ2xpJyksICR1bCkNCiAgICB0aGlzLmFjdGl2YXRlKCR0YXJnZXQsICR0YXJnZXQucGFyZW50KCksIGZ1bmN0aW9uICgpIHsNCiAgICAgICRwcmV2aW91cy50cmlnZ2VyKHsNCiAgICAgICAgdHlwZTogJ2hpZGRlbi5icy50YWInLA0KICAgICAgICByZWxhdGVkVGFyZ2V0OiAkdGhpc1swXQ0KICAgICAgfSkNCiAgICAgICR0aGlzLnRyaWdnZXIoew0KICAgICAgICB0eXBlOiAnc2hvd24uYnMudGFiJywNCiAgICAgICAgcmVsYXRlZFRhcmdldDogJHByZXZpb3VzWzBdDQogICAgICB9KQ0KICAgIH0pDQogIH0NCg0KICBUYWIucHJvdG90eXBlLmFjdGl2YXRlID0gZnVuY3Rpb24gKGVsZW1lbnQsIGNvbnRhaW5lciwgY2FsbGJhY2spIHsNCiAgICB2YXIgJGFjdGl2ZSAgICA9IGNvbnRhaW5lci5maW5kKCc+IC5hY3RpdmUnKQ0KICAgIHZhciB0cmFuc2l0aW9uID0gY2FsbGJhY2sNCiAgICAgICYmICQuc3VwcG9ydC50cmFuc2l0aW9uDQogICAgICAmJiAoJGFjdGl2ZS5sZW5ndGggJiYgJGFjdGl2ZS5oYXNDbGFzcygnZmFkZScpIHx8ICEhY29udGFpbmVyLmZpbmQoJz4gLmZhZGUnKS5sZW5ndGgpDQoNCiAgICBmdW5jdGlvbiBuZXh0KCkgew0KICAgICAgJGFjdGl2ZQ0KICAgICAgICAucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpDQogICAgICAgIC5maW5kKCc+IC5kcm9wZG93bi1tZW51ID4gLmFjdGl2ZScpDQogICAgICAgICAgLnJlbW92ZUNsYXNzKCdhY3RpdmUnKQ0KICAgICAgICAuZW5kKCkNCiAgICAgICAgLmZpbmQoJ1tkYXRhLXRvZ2dsZT0idGFiIl0nKQ0KICAgICAgICAgIC5hdHRyKCdhcmlhLWV4cGFuZGVkJywgZmFsc2UpDQoNCiAgICAgIGVsZW1lbnQNCiAgICAgICAgLmFkZENsYXNzKCdhY3RpdmUnKQ0KICAgICAgICAuZmluZCgnW2RhdGEtdG9nZ2xlPSJ0YWIiXScpDQogICAgICAgICAgLmF0dHIoJ2FyaWEtZXhwYW5kZWQnLCB0cnVlKQ0KDQogICAgICBpZiAodHJhbnNpdGlvbikgew0KICAgICAgICBlbGVtZW50WzBdLm9mZnNldFdpZHRoIC8vIHJlZmxvdyBmb3IgdHJhbnNpdGlvbg0KICAgICAgICBlbGVtZW50LmFkZENsYXNzKCdpbicpDQogICAgICB9IGVsc2Ugew0KICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKCdmYWRlJykNCiAgICAgIH0NCg0KICAgICAgaWYgKGVsZW1lbnQucGFyZW50KCcuZHJvcGRvd24tbWVudScpLmxlbmd0aCkgew0KICAgICAgICBlbGVtZW50DQogICAgICAgICAgLmNsb3Nlc3QoJ2xpLmRyb3Bkb3duJykNCiAgICAgICAgICAgIC5hZGRDbGFzcygnYWN0aXZlJykNCiAgICAgICAgICAuZW5kKCkNCiAgICAgICAgICAuZmluZCgnW2RhdGEtdG9nZ2xlPSJ0YWIiXScpDQogICAgICAgICAgICAuYXR0cignYXJpYS1leHBhbmRlZCcsIHRydWUpDQogICAgICB9DQoNCiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKCkNCiAgICB9DQoNCiAgICAkYWN0aXZlLmxlbmd0aCAmJiB0cmFuc2l0aW9uID8NCiAgICAgICRhY3RpdmUNCiAgICAgICAgLm9uZSgnYnNUcmFuc2l0aW9uRW5kJywgbmV4dCkNCiAgICAgICAgLmVtdWxhdGVUcmFuc2l0aW9uRW5kKFRhYi5UUkFOU0lUSU9OX0RVUkFUSU9OKSA6DQogICAgICBuZXh0KCkNCg0KICAgICRhY3RpdmUucmVtb3ZlQ2xhc3MoJ2luJykNCiAgfQ0KDQoNCiAgLy8gVEFCIFBMVUdJTiBERUZJTklUSU9ODQogIC8vID09PT09PT09PT09PT09PT09PT09PQ0KDQogIGZ1bmN0aW9uIFBsdWdpbihvcHRpb24pIHsNCiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgIHZhciAkdGhpcyA9ICQodGhpcykNCiAgICAgIHZhciBkYXRhICA9ICR0aGlzLmRhdGEoJ2JzLnRhYicpDQoNCiAgICAgIGlmICghZGF0YSkgJHRoaXMuZGF0YSgnYnMudGFiJywgKGRhdGEgPSBuZXcgVGFiKHRoaXMpKSkNCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9uID09ICdzdHJpbmcnKSBkYXRhW29wdGlvbl0oKQ0KICAgIH0pDQogIH0NCg0KICB2YXIgb2xkID0gJC5mbi50YWINCg0KICAkLmZuLnRhYiAgICAgICAgICAgICA9IFBsdWdpbg0KICAkLmZuLnRhYi5Db25zdHJ1Y3RvciA9IFRhYg0KDQoNCiAgLy8gVEFCIE5PIENPTkZMSUNUDQogIC8vID09PT09PT09PT09PT09PQ0KDQogICQuZm4udGFiLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgJC5mbi50YWIgPSBvbGQNCiAgICByZXR1cm4gdGhpcw0KICB9DQoNCg0KICAvLyBUQUIgREFUQS1BUEkNCiAgLy8gPT09PT09PT09PT09DQoNCiAgdmFyIGNsaWNrSGFuZGxlciA9IGZ1bmN0aW9uIChlKSB7DQogICAgZS5wcmV2ZW50RGVmYXVsdCgpDQogICAgUGx1Z2luLmNhbGwoJCh0aGlzKSwgJ3Nob3cnKQ0KICB9DQoNCiAgJChkb2N1bWVudCkNCiAgICAub24oJ2NsaWNrLmJzLnRhYi5kYXRhLWFwaScsICdbZGF0YS10b2dnbGU9InRhYiJdJywgY2xpY2tIYW5kbGVyKQ0KICAgIC5vbignY2xpY2suYnMudGFiLmRhdGEtYXBpJywgJ1tkYXRhLXRvZ2dsZT0icGlsbCJdJywgY2xpY2tIYW5kbGVyKQ0KDQp9KGpRdWVyeSk7DQoNCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICogQm9vdHN0cmFwOiBhZmZpeC5qcyB2My4zLjcNCiAqIGh0dHA6Ly9nZXRib290c3RyYXAuY29tL2phdmFzY3JpcHQvI2FmZml4DQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAqIENvcHlyaWdodCAyMDExLTIwMTYgVHdpdHRlciwgSW5jLg0KICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLw0KDQoNCitmdW5jdGlvbiAoJCkgew0KICAndXNlIHN0cmljdCc7DQoNCiAgLy8gQUZGSVggQ0xBU1MgREVGSU5JVElPTg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09DQoNCiAgdmFyIEFmZml4ID0gZnVuY3Rpb24gKGVsZW1lbnQsIG9wdGlvbnMpIHsNCiAgICB0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgQWZmaXguREVGQVVMVFMsIG9wdGlvbnMpDQoNCiAgICB0aGlzLiR0YXJnZXQgPSAkKHRoaXMub3B0aW9ucy50YXJnZXQpDQogICAgICAub24oJ3Njcm9sbC5icy5hZmZpeC5kYXRhLWFwaScsICQucHJveHkodGhpcy5jaGVja1Bvc2l0aW9uLCB0aGlzKSkNCiAgICAgIC5vbignY2xpY2suYnMuYWZmaXguZGF0YS1hcGknLCAgJC5wcm94eSh0aGlzLmNoZWNrUG9zaXRpb25XaXRoRXZlbnRMb29wLCB0aGlzKSkNCg0KICAgIHRoaXMuJGVsZW1lbnQgICAgID0gJChlbGVtZW50KQ0KICAgIHRoaXMuYWZmaXhlZCAgICAgID0gbnVsbA0KICAgIHRoaXMudW5waW4gICAgICAgID0gbnVsbA0KICAgIHRoaXMucGlubmVkT2Zmc2V0ID0gbnVsbA0KDQogICAgdGhpcy5jaGVja1Bvc2l0aW9uKCkNCiAgfQ0KDQogIEFmZml4LlZFUlNJT04gID0gJzMuMy43Jw0KDQogIEFmZml4LlJFU0VUICAgID0gJ2FmZml4IGFmZml4LXRvcCBhZmZpeC1ib3R0b20nDQoNCiAgQWZmaXguREVGQVVMVFMgPSB7DQogICAgb2Zmc2V0OiAwLA0KICAgIHRhcmdldDogd2luZG93DQogIH0NCg0KICBBZmZpeC5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoc2Nyb2xsSGVpZ2h0LCBoZWlnaHQsIG9mZnNldFRvcCwgb2Zmc2V0Qm90dG9tKSB7DQogICAgdmFyIHNjcm9sbFRvcCAgICA9IHRoaXMuJHRhcmdldC5zY3JvbGxUb3AoKQ0KICAgIHZhciBwb3NpdGlvbiAgICAgPSB0aGlzLiRlbGVtZW50Lm9mZnNldCgpDQogICAgdmFyIHRhcmdldEhlaWdodCA9IHRoaXMuJHRhcmdldC5oZWlnaHQoKQ0KDQogICAgaWYgKG9mZnNldFRvcCAhPSBudWxsICYmIHRoaXMuYWZmaXhlZCA9PSAndG9wJykgcmV0dXJuIHNjcm9sbFRvcCA8IG9mZnNldFRvcCA/ICd0b3AnIDogZmFsc2UNCg0KICAgIGlmICh0aGlzLmFmZml4ZWQgPT0gJ2JvdHRvbScpIHsNCiAgICAgIGlmIChvZmZzZXRUb3AgIT0gbnVsbCkgcmV0dXJuIChzY3JvbGxUb3AgKyB0aGlzLnVucGluIDw9IHBvc2l0aW9uLnRvcCkgPyBmYWxzZSA6ICdib3R0b20nDQogICAgICByZXR1cm4gKHNjcm9sbFRvcCArIHRhcmdldEhlaWdodCA8PSBzY3JvbGxIZWlnaHQgLSBvZmZzZXRCb3R0b20pID8gZmFsc2UgOiAnYm90dG9tJw0KICAgIH0NCg0KICAgIHZhciBpbml0aWFsaXppbmcgICA9IHRoaXMuYWZmaXhlZCA9PSBudWxsDQogICAgdmFyIGNvbGxpZGVyVG9wICAgID0gaW5pdGlhbGl6aW5nID8gc2Nyb2xsVG9wIDogcG9zaXRpb24udG9wDQogICAgdmFyIGNvbGxpZGVySGVpZ2h0ID0gaW5pdGlhbGl6aW5nID8gdGFyZ2V0SGVpZ2h0IDogaGVpZ2h0DQoNCiAgICBpZiAob2Zmc2V0VG9wICE9IG51bGwgJiYgc2Nyb2xsVG9wIDw9IG9mZnNldFRvcCkgcmV0dXJuICd0b3AnDQogICAgaWYgKG9mZnNldEJvdHRvbSAhPSBudWxsICYmIChjb2xsaWRlclRvcCArIGNvbGxpZGVySGVpZ2h0ID49IHNjcm9sbEhlaWdodCAtIG9mZnNldEJvdHRvbSkpIHJldHVybiAnYm90dG9tJw0KDQogICAgcmV0dXJuIGZhbHNlDQogIH0NCg0KICBBZmZpeC5wcm90b3R5cGUuZ2V0UGlubmVkT2Zmc2V0ID0gZnVuY3Rpb24gKCkgew0KICAgIGlmICh0aGlzLnBpbm5lZE9mZnNldCkgcmV0dXJuIHRoaXMucGlubmVkT2Zmc2V0DQogICAgdGhpcy4kZWxlbWVudC5yZW1vdmVDbGFzcyhBZmZpeC5SRVNFVCkuYWRkQ2xhc3MoJ2FmZml4JykNCiAgICB2YXIgc2Nyb2xsVG9wID0gdGhpcy4kdGFyZ2V0LnNjcm9sbFRvcCgpDQogICAgdmFyIHBvc2l0aW9uICA9IHRoaXMuJGVsZW1lbnQub2Zmc2V0KCkNCiAgICByZXR1cm4gKHRoaXMucGlubmVkT2Zmc2V0ID0gcG9zaXRpb24udG9wIC0gc2Nyb2xsVG9wKQ0KICB9DQoNCiAgQWZmaXgucHJvdG90eXBlLmNoZWNrUG9zaXRpb25XaXRoRXZlbnRMb29wID0gZnVuY3Rpb24gKCkgew0KICAgIHNldFRpbWVvdXQoJC5wcm94eSh0aGlzLmNoZWNrUG9zaXRpb24sIHRoaXMpLCAxKQ0KICB9DQoNCiAgQWZmaXgucHJvdG90eXBlLmNoZWNrUG9zaXRpb24gPSBmdW5jdGlvbiAoKSB7DQogICAgaWYgKCF0aGlzLiRlbGVtZW50LmlzKCc6dmlzaWJsZScpKSByZXR1cm4NCg0KICAgIHZhciBoZWlnaHQgICAgICAgPSB0aGlzLiRlbGVtZW50LmhlaWdodCgpDQogICAgdmFyIG9mZnNldCAgICAgICA9IHRoaXMub3B0aW9ucy5vZmZzZXQNCiAgICB2YXIgb2Zmc2V0VG9wICAgID0gb2Zmc2V0LnRvcA0KICAgIHZhciBvZmZzZXRCb3R0b20gPSBvZmZzZXQuYm90dG9tDQogICAgdmFyIHNjcm9sbEhlaWdodCA9IE1hdGgubWF4KCQoZG9jdW1lbnQpLmhlaWdodCgpLCAkKGRvY3VtZW50LmJvZHkpLmhlaWdodCgpKQ0KDQogICAgaWYgKHR5cGVvZiBvZmZzZXQgIT0gJ29iamVjdCcpICAgICAgICAgb2Zmc2V0Qm90dG9tID0gb2Zmc2V0VG9wID0gb2Zmc2V0DQogICAgaWYgKHR5cGVvZiBvZmZzZXRUb3AgPT0gJ2Z1bmN0aW9uJykgICAgb2Zmc2V0VG9wICAgID0gb2Zmc2V0LnRvcCh0aGlzLiRlbGVtZW50KQ0KICAgIGlmICh0eXBlb2Ygb2Zmc2V0Qm90dG9tID09ICdmdW5jdGlvbicpIG9mZnNldEJvdHRvbSA9IG9mZnNldC5ib3R0b20odGhpcy4kZWxlbWVudCkNCg0KICAgIHZhciBhZmZpeCA9IHRoaXMuZ2V0U3RhdGUoc2Nyb2xsSGVpZ2h0LCBoZWlnaHQsIG9mZnNldFRvcCwgb2Zmc2V0Qm90dG9tKQ0KDQogICAgaWYgKHRoaXMuYWZmaXhlZCAhPSBhZmZpeCkgew0KICAgICAgaWYgKHRoaXMudW5waW4gIT0gbnVsbCkgdGhpcy4kZWxlbWVudC5jc3MoJ3RvcCcsICcnKQ0KDQogICAgICB2YXIgYWZmaXhUeXBlID0gJ2FmZml4JyArIChhZmZpeCA/ICctJyArIGFmZml4IDogJycpDQogICAgICB2YXIgZSAgICAgICAgID0gJC5FdmVudChhZmZpeFR5cGUgKyAnLmJzLmFmZml4JykNCg0KICAgICAgdGhpcy4kZWxlbWVudC50cmlnZ2VyKGUpDQoNCiAgICAgIGlmIChlLmlzRGVmYXVsdFByZXZlbnRlZCgpKSByZXR1cm4NCg0KICAgICAgdGhpcy5hZmZpeGVkID0gYWZmaXgNCiAgICAgIHRoaXMudW5waW4gPSBhZmZpeCA9PSAnYm90dG9tJyA/IHRoaXMuZ2V0UGlubmVkT2Zmc2V0KCkgOiBudWxsDQoNCiAgICAgIHRoaXMuJGVsZW1lbnQNCiAgICAgICAgLnJlbW92ZUNsYXNzKEFmZml4LlJFU0VUKQ0KICAgICAgICAuYWRkQ2xhc3MoYWZmaXhUeXBlKQ0KICAgICAgICAudHJpZ2dlcihhZmZpeFR5cGUucmVwbGFjZSgnYWZmaXgnLCAnYWZmaXhlZCcpICsgJy5icy5hZmZpeCcpDQogICAgfQ0KDQogICAgaWYgKGFmZml4ID09ICdib3R0b20nKSB7DQogICAgICB0aGlzLiRlbGVtZW50Lm9mZnNldCh7DQogICAgICAgIHRvcDogc2Nyb2xsSGVpZ2h0IC0gaGVpZ2h0IC0gb2Zmc2V0Qm90dG9tDQogICAgICB9KQ0KICAgIH0NCiAgfQ0KDQoNCiAgLy8gQUZGSVggUExVR0lOIERFRklOSVRJT04NCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT0NCg0KICBmdW5jdGlvbiBQbHVnaW4ob3B0aW9uKSB7DQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICB2YXIgJHRoaXMgICA9ICQodGhpcykNCiAgICAgIHZhciBkYXRhICAgID0gJHRoaXMuZGF0YSgnYnMuYWZmaXgnKQ0KICAgICAgdmFyIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9uID09ICdvYmplY3QnICYmIG9wdGlvbg0KDQogICAgICBpZiAoIWRhdGEpICR0aGlzLmRhdGEoJ2JzLmFmZml4JywgKGRhdGEgPSBuZXcgQWZmaXgodGhpcywgb3B0aW9ucykpKQ0KICAgICAgaWYgKHR5cGVvZiBvcHRpb24gPT0gJ3N0cmluZycpIGRhdGFbb3B0aW9uXSgpDQogICAgfSkNCiAgfQ0KDQogIHZhciBvbGQgPSAkLmZuLmFmZml4DQoNCiAgJC5mbi5hZmZpeCAgICAgICAgICAgICA9IFBsdWdpbg0KICAkLmZuLmFmZml4LkNvbnN0cnVjdG9yID0gQWZmaXgNCg0KDQogIC8vIEFGRklYIE5PIENPTkZMSUNUDQogIC8vID09PT09PT09PT09PT09PT09DQoNCiAgJC5mbi5hZmZpeC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgew0KICAgICQuZm4uYWZmaXggPSBvbGQNCiAgICByZXR1cm4gdGhpcw0KICB9DQoNCg0KICAvLyBBRkZJWCBEQVRBLUFQSQ0KICAvLyA9PT09PT09PT09PT09PQ0KDQogICQod2luZG93KS5vbignbG9hZCcsIGZ1bmN0aW9uICgpIHsNCiAgICAkKCdbZGF0YS1zcHk9ImFmZml4Il0nKS5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgIHZhciAkc3B5ID0gJCh0aGlzKQ0KICAgICAgdmFyIGRhdGEgPSAkc3B5LmRhdGEoKQ0KDQogICAgICBkYXRhLm9mZnNldCA9IGRhdGEub2Zmc2V0IHx8IHt9DQoNCiAgICAgIGlmIChkYXRhLm9mZnNldEJvdHRvbSAhPSBudWxsKSBkYXRhLm9mZnNldC5ib3R0b20gPSBkYXRhLm9mZnNldEJvdHRvbQ0KICAgICAgaWYgKGRhdGEub2Zmc2V0VG9wICAgICE9IG51bGwpIGRhdGEub2Zmc2V0LnRvcCAgICA9IGRhdGEub2Zmc2V0VG9wDQoNCiAgICAgIFBsdWdpbi5jYWxsKCRzcHksIGRhdGEpDQogICAgfSkNCiAgfSkNCg0KfShqUXVlcnkpOw0K
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 72084
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20171211T193120Z
